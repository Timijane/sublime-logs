<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wallet Dashboard</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<h1>Wallet Dashboard</h1>
<p>Welcome, <span id="userEmail">Loading...</span></p>
<p>Your Balance: $<span id="balance">0</span></p>

<h2>Deposit</h2>
<input type="number" id="depositAmount" placeholder="Enter amount">
<button id="depositBtn">Deposit</button>

<h2>Withdraw</h2>
<input type="number" id="withdrawAmount" placeholder="Enter amount">
<button id="withdrawBtn">Withdraw</button>

<h2>Transfer</h2>
<input type="email" id="recipientEmail" placeholder="Recipient Email">
<input type="number" id="transferAmount" placeholder="Amount to transfer">
<button id="transferBtn">Transfer</button>

<button id="logoutBtn">Logout</button>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDVu5IQ3Y5bvgAfSKym8kXPpZZWKqMELTM",
    authDomain: "sublime-logs.firebaseapp.com",
    projectId: "sublime-logs",
    storageBucket: "sublime-logs.firebasestorage.app",
    messagingSenderId: "381847722551",
    appId: "1:381847722551:web:8ec68f018291d3927f3db2",
    measurementId: "G-8YHHJC1MP7"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  auth.onAuthStateChanged(async user => {
    if (!user) {
      window.location = 'login.html';
      return;
    }

    const uid = user.uid;
    const email = user.email;
    document.getElementById('userEmail').innerText = email;

    const walletRef = db.collection('wallets').doc(uid);

    // Auto-create wallet if not exists
    const walletDoc = await walletRef.get();
    if (!walletDoc.exists) {
      await walletRef.set({ balance: 0 });
    }

    // Function to update balance in real-time
    async function updateBalance() {
      const snapshot = await walletRef.get();
      document.getElementById('balance').innerText = snapshot.data().balance;
    }

    await updateBalance();

    // Deposit
    document.getElementById('depositBtn').addEventListener('click', async () => {
      const amount = parseFloat(document.getElementById('depositAmount').value);
      if (isNaN(amount) || amount <= 0) return alert("Enter valid amount");

      const current = (await walletRef.get()).data().balance;
      const newBalance = current + amount;
      await walletRef.update({ balance: newBalance });

      await db.collection('transactions').add({
        uid: uid,
        type: 'Deposit',
        amount: amount,
        date: firebase.firestore.Timestamp.now()
      });

      document.getElementById('depositAmount').value = '';
      updateBalance();
      alert("Deposit successful!");
    });

    // Withdraw
    document.getElementById('withdrawBtn').addEventListener('click', async () => {
      const amount = parseFloat(document.getElementById('withdrawAmount').value);
      if (isNaN(amount) || amount <= 0) return alert("Enter valid amount");

      const current = (await walletRef.get()).data().balance;
      if (amount > current) return alert("Insufficient balance");

      const newBalance = current - amount;
      await walletRef.update({ balance: newBalance });

      await db.collection('transactions').add({
        uid: uid,
        type: 'Withdraw',
        amount: amount,
        date: firebase.firestore.Timestamp.now()
      });

      document.getElementById('withdrawAmount').value = '';
      updateBalance();
      alert("Withdraw successful!");
    });

    // Transfer
    document.getElementById('transferBtn').addEventListener('click', async () => {
      const recipientEmail = document.getElementById('recipientEmail').value.trim();
      const amount = parseFloat(document.getElementById('transferAmount').value);
      if (!recipientEmail || isNaN(amount) || amount <= 0) return alert("Enter valid recipient and amount");

      const usersSnapshot = await db.collection('users').where('email', '==', recipientEmail).get();
      if (usersSnapshot.empty) return alert("Recipient not found");

      const recipientUID = usersSnapshot.docs[0].id;
      const recipientWalletRef = db.collection('wallets').doc(recipientUID);

      // Auto-create recipient wallet if not exists
      const recWallet = await recipientWalletRef.get();
      if (!recWallet.exists) await recipientWalletRef.set({ balance: 0 });

      const senderBalance = (await walletRef.get()).data().balance;
      if (amount > senderBalance) return alert("Insufficient balance");

      await walletRef.update({ balance: senderBalance - amount });
      const recipientBalance = (await recipientWalletRef.get()).data().balance;
      await recipientWalletRef.update({ balance: recipientBalance + amount });

      // Log transactions for both sender and recipient
      await db.collection('transactions').add({
        uid: uid,
        type: 'Transfer Sent',
        amount: amount,
        to: recipientEmail,
        date: firebase.firestore.Timestamp.now()
      });

      await db.collection('transactions').add({
        uid: recipientUID,
        type: 'Transfer Received',
        amount: amount,
        from: email,
        date: firebase.firestore.Timestamp.now()
      });

      document.getElementById('recipientEmail').value = '';
      document.getElementById('transferAmount').value = '';
      updateBalance();
      alert("Transfer successful!");
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      auth.signOut().then(() => window.location = 'login.html');
    });
  });
</script>
</body>
</html>
