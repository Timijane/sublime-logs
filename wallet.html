<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sublime Logs - Wallet</title>
<link href="https://fonts.googleapis.com/css2?family=Lobster&family=David:wght@400;700&display=swap" rel="stylesheet">
<style>
  body {
    margin: 0;
    font-family: 'David', sans-serif;
    background: linear-gradient(135deg, #8e44ad, #e91e63);
    min-height: 100vh;
    display: flex;
  }

  /* Sidebar */
  .sidebar {
    width: 250px;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(12px);
    padding: 30px 20px;
    color: #fff;
    display: flex;
    flex-direction: column;
  }

  .sidebar h2 {
    font-family: 'Lobster', cursive;
    margin-bottom: 30px;
    font-size: 2em;
    color: #fff;
  }

  .sidebar button {
    background: none;
    border: none;
    color: #fff;
    padding: 12px 0;
    text-align: left;
    font-size: 1em;
    cursor: pointer;
    margin-bottom: 10px;
    transition: all 0.2s;
  }

  .sidebar button:hover {
    color: #ffdd59;
  }

  /* Main Content */
  .main {
    flex: 1;
    padding: 40px;
    color: #fff;
  }

  .welcome {
    font-size: 1.4em;
    margin-bottom: 30px;
  }

  .balance-card {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(12px);
    padding: 25px 20px;
    border-radius: 15px;
    width: 300px;
    margin-bottom: 30px;
  }

  .balance-card h3 {
    margin: 0 0 10px 0;
    font-size: 1em;
    font-weight: normal;
    color: #f1f1f1;
  }

  .balance-card p {
    font-size: 1.8em;
    margin: 0;
    font-weight: bold;
  }

  .btn {
    padding: 12px 20px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-size: 1em;
    margin-top: 10px;
    color: #fff;
    background: linear-gradient(90deg, #8e44ad, #e91e63);
    transition: all 0.3s ease;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(233,30,99,0.4);
  }

  .transactions {
    margin-top: 40px;
    max-width: 500px;
  }

  .transactions h3 {
    margin-bottom: 15px;
  }

  .transaction-item {
    display: flex;
    justify-content: space-between;
    background: rgba(255,255,255,0.15);
    padding: 12px 15px;
    border-radius: 10px;
    margin-bottom: 10px;
  }

  .transaction-item.credit {
    border-left: 4px solid #2ecc71;
  }

  .transaction-item.debit {
    border-left: 4px solid #e74c3c;
  }

  .transaction-item span {
    font-weight: bold;
  }
</style>
</head>
<body>

<div class="sidebar">
  <h2>Sublime Logs</h2>
  <button id="dashboard-btn">Dashboard</button>
  <button id="wallet-btn">Wallet</button>
  <button id="logout-btn">Logout</button>
</div>

<div class="main">
  <div class="welcome" id="welcome-msg">Welcome, User</div>

  <div class="balance-card">
    <h3>Your Wallet Balance</h3>
    <p id="wallet-balance">₦0</p>
    <button class="btn" id="fund-wallet-btn">Fund Wallet</button>
  </div>

  <div class="transactions">
    <h3>Recent Transactions</h3>
    <div id="transaction-list"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDRnNoRJ4Zgtu-KEZAdOAKtou2LV9rdL5c",
  authDomain: "sublime-log.firebaseapp.com",
  projectId: "sublime-log",
  storageBucket: "sublime-log.appspot.com",
  messagingSenderId: "644554254089",
  appId: "1:644554254089:web:dd3374c9468046a5a015d8",
  measurementId: "G-YMPGVWCK16"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Elements
const welcomeMsg = document.getElementById("welcome-msg");
const walletBalance = document.getElementById("wallet-balance");
const fundWalletBtn = document.getElementById("fund-wallet-btn");
const transactionList = document.getElementById("transaction-list");
const logoutBtn = document.getElementById("logout-btn");

// Helper: Get user balance
async function getUserBalance(uid) {
  const userRef = doc(db, "users", uid);
  const userSnap = await getDoc(userRef);
  return userSnap.exists() ? Number(userSnap.data().balance || 0) : 0;
}

// Helper: Update user balance
async function updateUserBalance(uid, amount) {
  const userRef = doc(db, "users", uid);
  const currentBalance = await getUserBalance(uid);
  await updateDoc(userRef, { balance: currentBalance + amount });

  // Record transaction
  const txRef = collection(db, "users", uid, "transactions");
  await addDoc(txRef, {
    amount,
    type: amount > 0 ? "credit" : "debit",
    date: new Date().toISOString()
  });
}

// Show balance in UI
async function refreshBalance(uid) {
  const balance = await getUserBalance(uid);
  walletBalance.textContent = `₦${balance.toLocaleString()}`;
}

// Show recent transactions
async function showTransactions(uid) {
  transactionList.innerHTML = '';
  const txRef = collection(db, "users", uid, "transactions");
  const q = query(txRef, orderBy("date", "desc"), limit(10));
  const snapshot = await getDocs(q);
  snapshot.docs.forEach(docSnap => {
    const data = docSnap.data();
    const div = document.createElement('div');
    div.classList.add('transaction-item', data.type);
    div.innerHTML = `
      <span>${data.type === 'credit' ? '+' : '-'}₦${Math.abs(data.amount).toLocaleString()}</span>
      <span>${new Date(data.date).toLocaleDateString()}</span>
    `;
    transactionList.appendChild(div);
  });
}

// Paystack Fund Wallet
function fundWallet(user) {
  const handler = window.PaystackPop.setup({
    key: 'pk_live_20505aa86cec6458bf2cc8cd926ecc06b87ff492',
    email: user.email,
    amount: 5000 * 100, // ₦5000 default
    currency: 'NGN',
    ref: '' + Math.floor(Math.random() * 1000000000 + 1),
    onClose: function(){
      alert('Payment cancelled');
    },
    callback: async function(response){
      await updateUserBalance(user.uid, 5000);
      alert('Wallet funded successfully!');
      refreshBalance(user.uid);
      showTransactions(user.uid);
    }
  });
  handler.openIframe();
}

// Logout
logoutBtn.addEventListener('click', () => {
  signOut(auth).then(() => window.location.href = "login.html");
});

fundWalletBtn.addEventListener('click', () => fundWallet(currentUser));

let currentUser = null;

// Check auth state
onAuthStateChanged(auth, async user => {
  if(user) {
    currentUser = user;
    welcomeMsg.textContent = `Welcome, ${user.displayName || user.email}`;
    refreshBalance(user.uid);
    showTransactions(user.uid);
  } else {
    window.location.href = 'login.html';
  }
});
</script>

<!-- Paystack JS -->
<script src="https://js.paystack.co/v1/inline.js"></script>
</body>
</html>
