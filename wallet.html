<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Buy Number — Sublime Logs</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
  :root{ --bg:#0b0f13; --card:#161b22; --input-bg:#0d1117; --muted:#8b949e; --text:#c9d1d9; --accent:#2ea043; --accent-hover:#3fb950; --border:rgba(240,246,252,0.1); --danger:#f85149; --warning:#d29922; --header-height: 60px; }
  
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden;}
  
  .app-container { display: flex; min-height: 100vh; }
  
  /* Mobile Header */
  .mobile-header {
      display: none; position: fixed; top: 0; left: 0; right: 0; height: var(--header-height);
      background: var(--card); border-bottom: 1px solid var(--border); z-index: 1000;
      align-items: center; justify-content: space-between; padding: 0 20px;
  }
  .hamburger { font-size: 24px; cursor: pointer; color: var(--text); background: none; border: none; }
  
  /* Sidebar */
  .sidebar{
      width:250px; background:var(--card); border-right:1px solid var(--border);
      padding:20px; display:flex; flex-direction:column; gap:10px;
      position:fixed; height:100%; top:0; left:0; z-index: 999;
      transition: transform 0.3s ease;
  }
  
  .main{ margin-left:250px; flex:1; padding:30px; max-width:100%; width: 100%; padding-top: 30px;}

  /* UI Elements */
  h1,h2,h3{margin:0;color:#fff}
  .label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block;text-transform:uppercase;letter-spacing:0.5px;}
  .card{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:20px;margin-bottom:20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);}
  
  .search-wrapper { position: relative; margin-bottom: 10px; }
  .search-wrapper i { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 12px;}
  .search-input { padding-left: 30px !important; }

  select, input{width:100%;padding:12px;background:var(--input-bg);border:1px solid var(--border);border-radius:6px;color:#fff;font-size:14px;outline:none;}
  select:focus, input:focus{border-color:var(--accent);}
  
  /* Button Styles */
  .btn{background:var(--accent);color:#fff;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;transition:0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px;}
  .btn:hover{background:var(--accent-hover);}
  .btn:disabled{opacity:0.5;cursor:not-allowed;background:var(--muted);}
  .btn.secondary{background:rgba(255,255,255,0.05);border:1px solid var(--border);color:var(--text); justify-content: flex-start;}
  .btn.secondary:hover { background: rgba(255,255,255,0.1); }
  .btn-full { width: 100%; }

  .nav-link { display: flex; align-items: center; gap: 10px; padding: 12px; color: var(--text); text-decoration: none; border-radius: 6px; transition: 0.2s; }
  .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.05); color: #fff; }
  .nav-link i { width: 20px; text-align: center; color: var(--muted); }
  
  /* Step Interface */
  .step-container{display:none; animation: fadeIn 0.3s ease;}
  .step-container.active{display:block;}
  @keyframes fadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
  
  /* Height fixes for "Show All Numbers" */
  select[size] { height: 400px; max-height: 60vh; }

  /* Grid & Tables */
  .offer-list{display:grid;grid-template-columns:repeat(auto-fill, minmax(140px, 1fr));gap:10px;margin-top:15px;}
  .offer-item{background:var(--input-bg);border:1px solid var(--border);padding:15px;border-radius:6px;cursor:pointer;transition:0.2s;text-align:center;}
  .offer-item:hover{border-color:var(--accent);background:#1c2128;}
  .offer-price{font-size:18px;font-weight:bold;color:#fff;margin:5px 0;}
  .offer-stock{font-size:11px;color:var(--muted);}

  .table-container{overflow-x:auto; -webkit-overflow-scrolling: touch;}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px; min-width: 600px;} 
  th{text-align:left;padding:12px;border-bottom:1px solid var(--border);color:var(--muted);font-weight:500;}
  td{padding:12px;border-bottom:1px solid var(--border);color:#fff;}
  tr:last-child td{border-bottom:none;}
  
  .badge{padding:3px 8px;border-radius:12px;font-size:10px;font-weight:700;text-transform:uppercase;}
  .status-pending{background:rgba(210,153,34,0.15);color:#e3b341;}
  .status-finished{background:rgba(46,160,67,0.15);color:#3fb950;}
  .status-canceled{background:rgba(248,81,73,0.15);color:#f85149;}
  .code-box{font-family:monospace;background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:4px;letter-spacing:1px;}

  .top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px; flex-wrap: wrap; gap: 15px;}
  .balance-card{text-align:right; background: rgba(46,160,67,0.1); padding: 10px 15px; border-radius: 8px; border: 1px solid rgba(46,160,67,0.3);}
  .balance-amount{font-size:20px;font-weight:700;color:var(--accent);}

  /* Important Notice */
  .important-notice {
      background: linear-gradient(135deg, rgba(46,160,67,0.15), rgba(46,160,67,0.05));
      border: 1px solid rgba(46,160,67,0.3);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      font-size: 13px;
  }
  .notice-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      color: var(--accent);
      font-weight: 600;
  }
  .notice-header i {
      font-size: 16px;
  }
  .notice-content ul {
      margin: 10px 0;
      padding-left: 20px;
  }
  .notice-content li {
      margin-bottom: 8px;
      color: var(--text);
  }
  .notice-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
  }
  .notice-actions .btn {
      flex: 1;
      min-width: 150px;
  }

  /* Modal */
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.8);z-index:2000}
  .modal.open{display:flex}
  .modal-card{width:450px; max-width:90%;background:var(--card);padding:24px;border-radius:12px;border:1px solid var(--border); max-height: 85vh; overflow-y: auto;}
  
  /* Rules Section in Modal */
  .rules-toggle{ background: none; border: none; color: var(--muted); text-align: left; padding: 10px 0; width: 100%; cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
  .rules-toggle:hover { color: var(--text); }
  .rules-content{ font-size: 12px; color: var(--muted); padding: 15px; background: rgba(255,255,255,0.03); border-radius: 6px; border: 1px solid var(--border); margin-top: 10px; display: none; }
  .rules-content ul { margin: 10px 0; padding-left: 20px; }
  .rules-content li { margin-bottom: 8px; }
  
  /* Support & Community Buttons */
  .support-actions { display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
  .support-actions .btn { flex: 1; }

  /* Payment Status Indicator */
  .payment-status {
      padding: 10px;
      border-radius: 6px;
      margin-top: 15px;
      font-size: 13px;
      display: none;
  }
  .payment-status.success {
      background: rgba(46,160,67,0.15);
      border: 1px solid rgba(46,160,67,0.3);
      color: var(--accent);
  }
  .payment-status.warning {
      background: rgba(210,153,34,0.15);
      border: 1px solid rgba(210,153,34,0.3);
      color: var(--warning);
  }
  
  /* Loading Overlay */
  .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
  }
  .loading-content {
      text-align: center;
      color: #fff;
  }
  .loading-spinner {
      font-size: 40px;
      margin-bottom: 20px;
      color: var(--accent);
  }

  /* Responsive */
  @media(max-width:800px){ 
      .mobile-header { display: flex; }
      .sidebar{ transform: translateX(-100%); width: 260px; box-shadow: 2px 0 10px rgba(0,0,0,0.5); padding-top: 80px;}
      .sidebar.open { transform: translateX(0); }
      .main{ margin-left:0; padding: 15px; padding-top: 80px; }
      .top-bar { flex-direction: column; align-items: flex-start; }
      .balance-card { width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center;}
      .support-actions, .notice-actions { flex-direction: column; }
  }
</style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
        </div>
        <h3 id="loading-text">Processing Payment...</h3>
        <p style="color: var(--muted); font-size: 14px; margin-top: 10px;">
            Please wait while we process your payment
        </p>
    </div>
</div>

<div class="mobile-header">
    <div style="font-weight:bold;font-size:18px;">Sublime Logs</div>
    <button class="hamburger" id="menu-toggle"><i class="fas fa-bars"></i></button>
</div>

<!-- Fund Wallet Modal - UPDATED WITH NEW FEATURES -->
<div class="modal" id="add-money-modal">
  <div class="modal-card">
    <h3 style="margin-bottom:15px"><i class="fas fa-wallet"></i> Fund Wallet</h3>
    
    <button class="rules-toggle" id="rules-toggle">
        <span><i class="fas fa-info-circle"></i> Important Usage Rules</span>
        <i class="fas fa-chevron-down" id="rules-chevron"></i>
    </button>
    
    <div class="rules-content" id="rules-content">
        <p><strong>Please read before purchasing:</strong></p>
        <ul>
            <li><strong>1. Security:</strong> Immediately set up two-factor authentication (2FA) on your service account after purchasing a number.</li>
            <li><strong>2. For Faster OTP:</strong> Higher-priced numbers typically receive OTP codes faster. You may experience delays with lower-priced options.</li>
            <li><strong>3. Payment Issues:</strong> If your wallet balance doesn't update after a successful payment, contact support immediately.</li>
        </ul>
        <p style="font-size:11px; margin-top: 15px; color: var(--warning);"><i class="fas fa-exclamation-triangle"></i> Purchases are final. Please test numbers promptly upon receipt.</p>
    </div>
    
    <div id="payment-status" class="payment-status warning" style="display:none;">
        <i class="fas fa-info-circle"></i> <span id="payment-status-text"></span>
    </div>
    
    <p style="font-size:13px;color:var(--muted);margin-bottom:15px;" id="modal-msg">Enter amount to fund your wallet (Minimum: ₦100).</p>
    
    <form id="deposit-form">
      <input type="number" id="pay-amount" placeholder="Amount (e.g., 1000)" min="100" required style="margin-bottom:15px;" />
      <input type="email" id="pay-email-hidden" style="display:none;" />
      
      <div style="display:flex;justify-content:flex-end;gap:10px">
        <button type="button" class="btn secondary" id="close-add-money">Cancel</button>
        <button type="submit" class="btn" id="start-paystack">Pay Now</button>
      </div>
    </form>
    
    <div class="support-actions">
        <!-- WhatsApp Support Button -->
        <a href="https://wa.me/2349056658964?text=User%20of%20Sublime%20Logs%2C%20have%20a%20complaint.%20My%20email%20is%3A%20[USER_EMAIL]" 
           class="btn secondary" 
           id="whatsapp-support" 
           target="_blank" 
           style="background:rgba(37,211,102,0.1); color:#25D366; border-color:rgba(37,211,102,0.3);">
            <i class="fab fa-whatsapp"></i> Contact Support
        </a>
        
        <!-- Community Button -->
        <button class="btn secondary" id="community-btn">
            <i class="fas fa-users"></i> Join Community
        </button>
    </div>
    
    <p style="font-size:11px; color:var(--muted); text-align:center; margin-top:15px;">
        <i class="fas fa-sync-alt"></i> For bank transfers (Opay, etc.), wallet updates may take 5-15 minutes. Contact support if not updated after 15 minutes.
    </p>
  </div>
</div>

<div class="app-container">

    <aside class="sidebar" id="sidebar">
        <div style="font-weight:bold;font-size:20px;margin-bottom:30px;padding-left:10px;" class="desktop-only-logo">
            Sublime Logs
        </div>
        
        <a href="dashboard1.html" class="nav-link">
            <i class="fas fa-home"></i> Dashboard
        </a>
        <a href="#" class="nav-link active" onclick="closeMenu()">
            <i class="fas fa-shopping-cart"></i> Buy Number
        </a>
        <a href="#" class="nav-link" id="nav-fund">
            <i class="fas fa-wallet"></i> Fund Account
        </a>
        
        <div style="margin-top:auto; border-top: 1px solid var(--border); padding-top: 15px;">
            <div style="font-size:11px;color:var(--muted); margin-bottom: 10px; padding-left: 10px;">
                LOGGED IN AS:<br><span id="user-email" style="color:var(--text);font-size:13px;">...</span>
            </div>
            <button id="logout" class="btn secondary btn-full">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </aside>

    <main class="main">
      
      <div class="top-bar">
        <div>
          <h2>New Order</h2>
          <div style="color:var(--muted);font-size:14px">Instant SMS Verification</div>
        </div>
        <div class="balance-card">
            <div class="label" style="margin:0; color: #fff;">Wallet Balance</div>
            <div class="balance-amount" id="balance">...</div>
        </div>
      </div>

      <!-- IMPORTANT NOTICE SECTION -->
      <div class="important-notice">
          <div class="notice-header">
              <i class="fas fa-exclamation-circle"></i>
              <span>Important Rules & Information</span>
          </div>
          <div class="notice-content">
              <ul>
                  <li><strong>1. Security First:</strong> Immediately set up two-factor authentication (2FA) after purchasing a number.</li>
                  <li><strong>2. Faster OTP:</strong> Higher-priced numbers receive OTP faster. Lower-priced numbers may experience delays.</li>
                  <li><strong>3. Payment Issues:</strong> If wallet doesn't update after payment, contact support immediately.</li>
                  <li><strong>4. Bank Transfers:</strong> For Opay/transfers, wallet updates may take 5-15 minutes.</li>
              </ul>
          </div>
          <div class="notice-actions">
              <a href="https://wa.me/2349056658964?text=User%20of%20Sublime%20Logs%2C%20have%20a%20complaint.%20My%20email%20is%3A%20[USER_EMAIL]" 
                 class="btn secondary" 
                 id="main-whatsapp-support" 
                 target="_blank"
                 style="background:rgba(37,211,102,0.1); color:#25D366; border-color:rgba(37,211,102,0.3);">
                  <i class="fab fa-whatsapp"></i> WhatsApp Support
              </a>
              <button class="btn secondary" id="main-community-btn">
                  <i class="fas fa-users"></i> Join Community
              </button>
              <button class="btn secondary" id="check-pending-payments">
                  <i class="fas fa-sync-alt"></i> Check Pending Payments
              </button>
          </div>
      </div>

      <div class="card">
        
        <div id="step-1" class="step-container active">
            <h3 style="margin-bottom:15px">1. Select Country</h3>
            
            <div class="search-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="search-country" class="search-input" placeholder="Search country (e.g., Brazil)...">
            </div>
            
            <select id="sel-country" size="20"></select>
            
            <button class="btn btn-full" style="margin-top:15px" onclick="goToStep2()">Continue &rarr;</button>
        </div>

        <div id="step-2" class="step-container">
            <h3 style="margin-bottom:15px">2. Select Service</h3>
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px; background:var(--input-bg); padding:10px; border-radius:6px; border:1px solid var(--border);">
                 <button class="btn secondary" style="padding:6px 12px;font-size:12px;" onclick="goToStep1()">&larr;</button>
                 <div class="label" style="margin:0">Country: <span id="display-country" style="color:#fff; font-weight:bold;"></span></div>
            </div>
            
            <div class="search-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="search-service" class="search-input" placeholder="Search service (e.g., Whatsapp)...">
            </div>

            <select id="sel-service" size="20"></select>
            
            <button class="btn btn-full" style="margin-top:15px" id="btn-check-avail">Check Availability</button>
        </div>

        <div id="step-3" class="step-container">
            <h3 style="margin-bottom:15px">3. Available Numbers</h3>
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px; background:var(--input-bg); padding:10px; border-radius:6px; border:1px solid var(--border);">
                 <button class="btn secondary" style="padding:6px 12px;font-size:12px;" onclick="goToStep2()">&larr;</button>
                 <div class="label" style="margin:0">For: <span id="display-final" style="color:#fff; font-weight:bold;"></span></div>
            </div>
            
            <div id="results-loader" style="display:none;color:var(--muted); text-align:center; padding:20px;">
                <i class="fas fa-spinner fa-spin"></i> Fetching best prices...
            </div>
            <div id="offers-grid" class="offer-list"></div>
        </div>

      </div>

      <h3 style="margin-top:40px;margin-bottom:15px;">Transaction History</h3>
      <div class="card" style="padding:0;">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width:40px">#</th>
                        <th>Phone</th>
                        <th>Code</th>
                        <th>Service</th>
                        <th>Price</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="history-table-body">
                    <tr><td colspan="8" style="text-align:center;color:var(--muted)">Loading history...</td></tr>
                </tbody>
            </table>
        </div>
      </div>

    </main>
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>

<script type="module">
  const PAYSTACK_KEY = 'pk_live_20505aa86cec6458bf2cc8cd926ecc06b87ff492';
  const API_URL = "https://eoslm172tqy3opg.m.pipedream.net"; 
  
  // Fixed exchange rate
  const EXCHANGE_RATE = 1600;

  // 5sim pricing: 1 dollar = 79 coins
  const COINS_PER_DOLLAR = 79;

  // Minimum selling price for USA WhatsApp (this is your new target price)
  const MINIMUM_SELLING_PRICE_USA_WHATSAPP = 4500;

  // Country-specific surcharges in Naira
  const COUNTRY_SURCHARGES = {
      'usa': 1000,          // ₦1,000 for USA
      'england': 700,       // ₦700 for UK
      'germany': 2500,      // ₦2,500 for Germany
      'canada': 2000,       // ₦2,000 for Canada
      'netherlands': 3000,  // ₦3,000 for Netherlands
      'poland': 1500,       // ₦1,500 for Poland
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, collection, query, orderBy, limit, runTransaction, updateDoc, addDoc, getDocs, where, getDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDRnNoRJ4Zgtu-KEZAdOAKtou2LV9rdL5c",
    authDomain: "sublime-log.firebaseapp.com",
    projectId: "sublime-log",
    storageBucket: "sublime-log.firebasestorage.app",
    messagingSenderId: "644554254089",
    appId: "1:644554254089:web:dd3374c9468046a5a015d8"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let currentWalletBalance = 0;
  let pendingTransactionRef = null;
  let paystackHandler = null;

  // --- DATA ---
  const countries = [
      {code:"usa",name:"USA"},{code:"england",name:"United Kingdom"},{code:"russia",name:"Russia"},{code:"ukraine",name:"Ukraine"},
      {code:"kazakhstan",name:"Kazakhstan"},{code:"nigeria",name:"Nigeria"},{code:"kenya",name:"Kenya"},{code:"ghana",name:"Ghana"},
      {code:"southafrica",name:"South Africa"},{code:"brazil",name:"Brazil"},{code:"argentina",name:"Argentina"},{code:"colombia",name:"Colombia"},
      {code:"peru",name:"Peru"},{code:"india",name:"India"},{code:"indonesia",name:"Indonesia"},{code:"philippines",name:"Philippines"},
      {code:"vietnam",name:"Vietnam"},{code:"thailand",name:"Thailand"},{code:"malaysia",name:"Malaysia"},{code:"germany",name:"Germany"},
      {code:"france",name:"France"},{code:"netherlands",name:"Netherlands"},{code:"spain",name:"Spain"},{code:"poland",name:"Poland"},
      {code:"canada",name:"Canada"},{code:"mexico",name:"Mexico"},{code:"australia",name:"Australia"},{code:"egypt",name:"Egypt"},
      {code:"morocco",name:"Morocco"},{code:"turkey",name:"Turkey"},{code:"uae",name:"UAE"},{code:"pakistan",name:"Pakistan"},
      {code:"bangladesh",name:"Bangladesh"},{code:"china",name:"China"},{code:"japan",name:"Japan"},{code:"southkorea",name:"South Korea"},
      {code:"italy",name:"Italy"},{code:"portugal",name:"Portugal"},{code:"belgium",name:"Belgium"}
  ];
  
  // Services including Upwork and Fiverr
  const services = [
      {code:"whatsapp",name:"WhatsApp"},{code:"telegram",name:"Telegram"},{code:"google",name:"Google / Gmail"},
      {code:"facebook",name:"Facebook"},{code:"instagram",name:"Instagram"},{code:"tiktok",name:"TikTok"},{code:"twitter",name:"X (Twitter)"},
      {code:"linkedin",name:"LinkedIn"},{code:"netflix",name:"Netflix"},{code:"uber",name:"Uber"},{code:"amazon",name:"Amazon"},
      {code:"discord",name:"Discord"},{code:"viber",name:"Viber"},{code:"snapchat",name:"Snapchat"},{code:"openai",name:"OpenAI / ChatGPT"},
      {code:"microsoft",name:"Microsoft"},{code:"airbnb",name:"Airbnb"},{code:"bolt",name:"Bolt"},{code:"yahoo",name:"Yahoo"},
      {code:"paypal",name:"PayPal"},{code:"tinder",name:"Tinder"},{code:"glovo",name:"Glovo"},
      {code:"upwork",name:"Upwork"},{code:"fiverr",name:"Fiverr"}
  ];

  // --- MENU & MODAL LOGIC ---
  const menuToggle = document.getElementById('menu-toggle');
  const sidebar = document.getElementById('sidebar');
  const amModal = document.getElementById('add-money-modal');
  const loadingOverlay = document.getElementById('loading-overlay');

  menuToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
  window.closeMenu = () => sidebar.classList.remove('open');
  
  // Close menu when clicking outside
  document.addEventListener('click', (e) => {
      if(!sidebar.contains(e.target) && !menuToggle.contains(e.target) && sidebar.classList.contains('open')){
          sidebar.classList.remove('open');
      }
  });

  // --- NEW: RULES TOGGLE LOGIC ---
  document.getElementById('rules-toggle').addEventListener('click', function() {
    const content = document.getElementById('rules-content');
    const chevron = document.getElementById('rules-chevron');
    const isHidden = content.style.display === 'none' || content.style.display === '';
    
    content.style.display = isHidden ? 'block' : 'none';
    chevron.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
    chevron.style.transition = 'transform 0.3s ease';
  });

  // --- NEW: COMMUNITY BUTTON LOGIC - UPDATED ---
  document.getElementById('community-btn').addEventListener('click', function() {
    const communityLink = 'https://chat.whatsapp.com/GCk6NVzCiZ39ym5xOfWK8g';
    window.open(communityLink, '_blank');
  });

  document.getElementById('main-community-btn').addEventListener('click', function() {
    const communityLink = 'https://chat.whatsapp.com/GCk6NVzCiZ39ym5xOfWK8g';
    window.open(communityLink, '_blank');
  });

  // --- UPDATED: WHATSAPP SUPPORT BUTTON - DYNAMIC EMAIL ---
  function updateWhatsAppLink() {
    if (currentUser && currentUser.email) {
      const userEmail = encodeURIComponent(currentUser.email);
      const message = encodeURIComponent(`User of Sublime Logs, have a complaint. My email is: ${currentUser.email}`);
      const whatsappBtn = document.getElementById('whatsapp-support');
      const mainWhatsappBtn = document.getElementById('main-whatsapp-support');
      
      const whatsappUrl = `https://wa.me/2349056658964?text=${message}`;
      
      if (whatsappBtn) whatsappBtn.href = whatsappUrl;
      if (mainWhatsappBtn) mainWhatsappBtn.href = whatsappUrl;
    }
  }

  // --- NEW: CHECK PENDING PAYMENTS FUNCTION ---
  document.getElementById('check-pending-payments').addEventListener('click', async function() {
    const btn = this;
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
    btn.disabled = true;
    
    try {
      const transactionsRef = collection(db, "users", currentUser.uid, "transactions");
      const q = query(transactionsRef, where("status", "==", "PENDING"));
      const querySnapshot = await getDocs(q);
      
      if (querySnapshot.empty) {
        alert("No pending payments found. All transactions are completed.");
      } else {
        let message = `Found ${querySnapshot.size} pending payment(s).\n\n`;
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          message += `- Reference: ${data.reference}\n`;
          message += `  Amount: ₦${data.amount}\n`;
          message += `  Date: ${new Date(data.date).toLocaleString()}\n\n`;
        });
        message += "For bank transfers, please wait 5-15 minutes. If still pending, contact support.";
        alert(message);
      }
    } catch (error) {
      console.error("Error checking pending payments:", error);
      alert("Error checking pending payments. Please try again.");
    } finally {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  });

  // Modal Handlers
  document.getElementById('nav-fund').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('modal-msg').textContent = "Enter amount to fund your wallet (Minimum: ₦100).";
      document.getElementById('pay-amount').value = "";
      document.getElementById('payment-status').style.display = 'none';
      amModal.classList.add('open');
      updateWhatsAppLink();
      closeMenu();
  });
  
  document.getElementById('close-add-money').addEventListener('click', () => {
    amModal.classList.remove('open');
    document.getElementById('payment-status').style.display = 'none';
  });

  // --- AUTH ---
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('user-email').textContent = user.email;
      document.getElementById('pay-email-hidden').value = user.email;
      updateWhatsAppLink();
      
      onSnapshot(doc(db, "users", user.uid), (docSnap) => {
         const bal = docSnap.exists() ? docSnap.data().balance : 0;
         currentWalletBalance = bal || 0;
         document.getElementById('balance').textContent = '₦' + (bal || 0).toLocaleString();
      });

      loadHistory();
      initDropdowns();
      startPaymentChecker();
    } else {
      window.location.href = 'index.html';
    }
  });
  
  document.getElementById('logout').addEventListener('click', () => {
      signOut(auth).then(() => window.location.href = 'index.html');
  });

  // --- DROPDOWN & SEARCH ---
  function initDropdowns() {
      countries.sort((a,b) => a.name.localeCompare(b.name));
      services.sort((a,b) => a.name.localeCompare(b.name));
      renderOptions('sel-country', countries);
      renderOptions('sel-service', services);
      setupSearch('search-country', 'sel-country', countries);
      setupSearch('search-service', 'sel-service', services);
  }
  
  function renderOptions(selectId, data) {
      const el = document.getElementById(selectId);
      el.innerHTML = '';
      data.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.code; opt.textContent = item.name;
          el.appendChild(opt);
      });
      if(data.length > 0) el.selectedIndex = 0;
  }
  
  function setupSearch(inputId, selectId, data) {
      document.getElementById(inputId).addEventListener('keyup', (e) => {
          const term = e.target.value.toLowerCase();
          const filtered = data.filter(item => item.name.toLowerCase().includes(term));
          renderOptions(selectId, filtered);
      });
  }

  // --- STEP NAV ---
  window.goToStep1 = () => {
      document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
      document.getElementById('step-1').classList.add('active');
  };
  window.goToStep2 = () => {
      const sel = document.getElementById('sel-country');
      if(!sel.value) return alert("Please select a country");
      const cName = countries.find(x => x.code === sel.value).name;
      document.getElementById('display-country').textContent = cName;
      document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
      document.getElementById('step-2').classList.add('active');
  };

  // --- CHECK AVAILABILITY ---
  document.getElementById('btn-check-avail').addEventListener('click', async () => {
      const country = document.getElementById('sel-country').value;
      const service = document.getElementById('sel-service').value;
      
      document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
      document.getElementById('step-3').classList.add('active');
      
      const sName = services.find(x => x.code === service).name;
      const cName = countries.find(x => x.code === country).name;
      document.getElementById('display-final').textContent = `${sName} in ${cName}`;
      
      const grid = document.getElementById('offers-grid');
      const loader = document.getElementById('results-loader');
      grid.innerHTML = ''; loader.style.display = 'block';

      try {
          const res = await fetch(`${API_URL}/prices`, {
              method: 'POST', headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ country, product: service })
          });
          const data = await res.json();
          loader.style.display = 'none';

          if(!data.offers || data.offers.length === 0) {
              grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--warning)">No numbers available right now.</div>';
              return;
          }

          data.offers.forEach(offer => {
             const costInDollars = offer.cost / COINS_PER_DOLLAR;
             const basePriceNaira = Math.ceil(costInDollars * EXCHANGE_RATE);
             const surcharge = COUNTRY_SURCHARGES[country] || 1000;
             let finalPrice = basePriceNaira + surcharge;
             
             if (country === 'usa' && service === 'whatsapp') {
                 if (finalPrice < MINIMUM_SELLING_PRICE_USA_WHATSAPP) {
                     finalPrice = MINIMUM_SELLING_PRICE_USA_WHATSAPP;
                 }
             }
             
             const MINIMUM_PROFIT_MARGIN = 0.20;
             const costPrice = basePriceNaira + surcharge;
             const profitablePrice = Math.ceil(costPrice * (1 + MINIMUM_PROFIT_MARGIN));
             
             if (finalPrice < profitablePrice) {
                 finalPrice = profitablePrice;
             }
             
             const div = document.createElement('div');
             div.className = 'offer-item';
             div.innerHTML = `
                <div style="font-weight:700;font-size:12px;color:var(--muted);margin-bottom:5px;">${offer.operator}</div>
                <div class="offer-price">₦${finalPrice.toLocaleString()}</div>
                <div class="offer-stock">Qty: ${offer.count}</div>
                <button class="btn" style="width:100%;margin-top:10px;font-size:12px;padding:8px" 
                   onclick="buyNumber('${country}', '${service}', '${offer.operator}', ${finalPrice})">
                   <i class="fas fa-shopping-cart"></i> Buy
                </button>
             `;
             grid.appendChild(div);
          });
      } catch(e) {
          loader.style.display = 'none';
          grid.innerHTML = '<div style="color:var(--danger)">Network Error.</div>';
      }
  });

  // --- BUY & PAYSTACK LOGIC ---
  window.buyNumber = async (country, product, operator, cost) => {
      if (currentWalletBalance < cost) {
          const deficit = cost - currentWalletBalance;
          const fundAmount = deficit < 50 ? 50 : deficit;
          
          document.getElementById('modal-msg').innerHTML = `<span style="color:var(--warning)">Insufficient Balance!</span><br>You need ₦${Math.ceil(deficit)} more.<br>Fund your wallet now to continue.`;
          document.getElementById('pay-amount').value = Math.ceil(fundAmount);
          amModal.classList.add('open');
          updateWhatsAppLink();
          return;
      }

      if(!confirm(`Confirm Purchase: ₦${cost}?\n\nRemember: Higher-priced numbers receive OTP faster.`)) return;
      
      const userRef = doc(db, "users", currentUser.uid);
      try {
        let apiData = null;
        await runTransaction(db, async (t) => {
            const uDoc = await t.get(userRef);
            if((uDoc.data().balance || 0) < cost) throw "Insufficient Balance (Server)";
        });

        const res = await fetch(`${API_URL}/buy`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ country, product, operator })
        });
        const data = await res.json();
        if(!res.ok || data.error) throw data.error || "Failed";
        apiData = data;

        await runTransaction(db, async (t) => {
            const uDoc = await t.get(userRef);
            t.update(userRef, { balance: uDoc.data().balance - cost });
            const newOrderRef = doc(collection(userRef, "orders"));
            t.set(newOrderRef, {
                id: apiData.id, phone: apiData.phone, product: product, country: country,
                cost: cost, status: 'PENDING', code: null, createdAt: new Date().toISOString()
            });
        });

        alert("Number Purchased Successfully!\n\nIMPORTANT: Immediately set up 2FA on your account!");
        window.goToStep1(); 
      } catch(e) {
          if(e === "Insufficient Balance (Server)") {
              alert("Balance updated roughly. Please fund wallet.");
          } else {
              alert("Error: " + e);
          }
      }
  };

  // --- FIXED: PAYSTACK FORM HANDLER ---
  document.getElementById('deposit-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const amount = document.getElementById('pay-amount').value;
    const email = document.getElementById('pay-email-hidden').value;
    const btn = document.getElementById('start-paystack');

    if(amount < 100) {
        alert("Minimum deposit is ₦100");
        return;
    }
    
    // Show loading overlay
    loadingOverlay.style.display = 'flex';
    document.getElementById('loading-text').textContent = 'Initializing Payment...';
    
    // Generate a unique reference
    const txRef = 'SL-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
    
    try {
        // Check if Paystack is loaded
        if (typeof PaystackPop === 'undefined') {
            throw new Error('Payment service not loaded. Please refresh the page.');
        }
        
        // Setup Paystack payment
        paystackHandler = PaystackPop.setup({
            key: PAYSTACK_KEY,
            email: email,
            amount: amount * 100, // Convert to kobo
            currency: 'NGN',
            ref: txRef,
            metadata: {
                userId: currentUser.uid,
                userEmail: currentUser.email,
                platform: 'Sublime Logs'
            },
            callback: async function(response) {
                console.log('Payment successful!', response);
                
                // Record successful transaction
                await recordTransaction(amount, txRef, 'COMPLETED');
                
                // Update user balance
                await updateUserBalance(parseFloat(amount));
                
                // Show success message
                const statusDiv = document.getElementById('payment-status');
                const statusText = document.getElementById('payment-status-text');
                statusDiv.className = 'payment-status success';
                statusDiv.style.display = 'block';
                statusText.innerHTML = `
                    Payment Successful!<br>
                    Your wallet has been credited with ₦${amount}.<br>
                    <small>Reference: ${txRef}</small>
                `;
                
                // Hide loading overlay
                loadingOverlay.style.display = 'none';
                
                // Refresh balance display
                const userDoc = await getDoc(doc(db, "users", currentUser.uid));
                if (userDoc.exists()) {
                    currentWalletBalance = userDoc.data().balance || 0;
                    document.getElementById('balance').textContent = '₦' + currentWalletBalance.toLocaleString();
                }
                
                // Auto-close modal after 3 seconds
                setTimeout(() => {
                    amModal.classList.remove('open');
                    statusDiv.style.display = 'none';
                }, 3000);
            },
            onClose: function() {
                console.log('Payment window closed.');
                loadingOverlay.style.display = 'none';
                
                // Record canceled transaction
                recordTransaction(amount, txRef, 'CANCELED');
                
                // Reset button state
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-credit-card"></i> Pay Now';
            }
        });
        
        // Open Paystack payment modal
        paystackHandler.openIframe();
        
    } catch (error) {
        console.error('Payment initialization error:', error);
        loadingOverlay.style.display = 'none';
        
        // Show error message
        const statusDiv = document.getElementById('payment-status');
        const statusText = document.getElementById('payment-status-text');
        statusDiv.className = 'payment-status warning';
        statusDiv.style.display = 'block';
        statusText.textContent = `Payment Error: ${error.message || 'Unable to initialize payment. Please try again.'}`;
        
        // Reset button
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-credit-card"></i> Pay Now';
    }
  });

  // --- FUNCTION TO RECORD TRANSACTION ---
  async function recordTransaction(amount, reference, status) {
    try {
      await addDoc(collection(db, "users", currentUser.uid, "transactions"), {
        type: 'deposit',
        amount: Number(amount),
        date: new Date().toISOString(),
        reference: reference,
        status: status,
        userEmail: currentUser.email,
        updatedAt: new Date().toISOString()
      });
      console.log('Transaction recorded:', reference, status);
    } catch(e) { 
      console.error('Error recording transaction:', e);
    }
  }

  // --- FUNCTION TO UPDATE USER BALANCE ---
  async function updateUserBalance(amount) {
    try {
      const userRef = doc(db, "users", currentUser.uid);
      await runTransaction(db, async (t) => {
        const userDoc = await t.get(userRef);
        const currentBalance = userDoc.data().balance || 0;
        const newBalance = currentBalance + amount;
        t.update(userRef, { balance: newBalance });
      });
      console.log('Balance updated by:', amount);
    } catch(e) {
      console.error('Error updating balance:', e);
      throw e;
    }
  }

  // --- PERIODIC PAYMENT CHECKER ---
  function startPaymentChecker() {
    setInterval(async () => {
      if (!currentUser) return;
      
      try {
        const transactionsRef = collection(db, "users", currentUser.uid, "transactions");
        const q = query(transactionsRef, where("status", "==", "PENDING"));
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
          console.log(`Found ${querySnapshot.size} pending payment(s)`);
          
          // In a real implementation, you would verify these with your backend
          // For now, we just update old pending transactions
          const now = new Date();
          querySnapshot.forEach(async (docSnap) => {
            const data = docSnap.data();
            const transactionTime = new Date(data.date);
            const minutesPassed = (now - transactionTime) / (1000 * 60);
            
            // If more than 30 minutes, mark as expired
            if (minutesPassed > 30) {
              await updateDoc(docSnap.ref, { 
                status: 'EXPIRED',
                updatedAt: new Date().toISOString()
              });
            }
          });
        }
      } catch (error) {
        console.error("Error in payment checker:", error);
      }
    }, 300000); // Check every 5 minutes
  }

  // --- HISTORY TABLE ---
  function loadHistory() {
      const q = query(collection(db, "users", currentUser.uid, "orders"), orderBy("createdAt", "desc"), limit(20));
      const tbody = document.getElementById('history-table-body');
      
      onSnapshot(q, (snapshot) => {
          tbody.innerHTML = '';
          if(snapshot.empty) { 
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;color:var(--muted)">No transactions yet.</td></tr>'; 
            return; 
          }
          
          let index = 1;
          snapshot.forEach(docSnap => {
              const d = docSnap.data();
              const tr = document.createElement('tr');
              let statusClass = d.status === 'PENDING' ? 'status-pending' : 
                               (d.status === 'FINISHED' ? 'status-finished' : 'status-canceled');
              let codeDisplay = d.status === 'FINISHED' ? `<span class="code-box">${d.code}</span>` : 
                               (d.status === 'PENDING' ? '...' : '-');
              let actionBtn = d.status === 'PENDING' ? 
                `<button class="btn secondary" style="padding:4px 8px;font-size:11px" onclick="checkSMS('${docSnap.id}', '${d.id}')">Check</button>` : '';

              tr.innerHTML = `
                <td>${index++}</td>
                <td style="font-family:monospace">${d.phone}</td>
                <td>${codeDisplay}</td>
                <td style="text-transform:capitalize">${d.product}</td>
                <td>₦${d.cost}</td>
                <td><span class="badge ${statusClass}">${d.status}</span></td>
                <td style="font-size:11px;color:var(--muted)">${new Date(d.createdAt).toLocaleDateString()}</td>
                <td>${actionBtn}</td>`;
              tbody.appendChild(tr);
          });
      });
  }

  window.checkSMS = async (docId, orderId) => {
      const btn = event.currentTarget; 
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
      btn.disabled = true;
      
      try {
          const res = await fetch(`${API_URL}/check`, { 
            method: 'POST', 
            headers: {'Content-Type':'application/json'}, 
            body: JSON.stringify({orderId}) 
          });
          const data = await res.json();
          
          if(data.sms && data.sms.length > 0) {
              await updateDoc(doc(db, "users", currentUser.uid, "orders", docId), { 
                status: 'FINISHED', 
                code: data.sms[0].code 
              });
              alert('SMS code received: ' + data.sms[0].code);
          } else if (data.status === 'CANCELED' || data.status === 'BANNED') {
              await updateDoc(doc(db, "users", currentUser.uid, "orders", docId), { status: 'CANCELED' });
              alert("Order Canceled by Network.");
          } else {
              alert("No SMS received yet. Please try again in a few seconds.");
          }
      } catch(e) { 
          console.error(e); 
          alert("Error checking SMS. Please try again.");
      } finally { 
          btn.innerHTML = 'Check'; 
          btn.disabled = false; 
      }
  };
</script>
</body>
  </html>
