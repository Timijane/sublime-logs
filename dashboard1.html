<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard — Sublime Logs</title>
<style>
  :root{ --bg:#0b0f13; --card:#0f1720; --muted:#98a0a8; --accent:#6ee7b7; --accent-2:#7c5cff; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial;background:radial-gradient(1200px 600px at 10% 10%, rgba(124,92,255,0.06), transparent 5%),linear-gradient(180deg,#020408 0%, #061018 100%);color:#e6eef6;min-height:100vh;display:flex;}
  
  /* CORE FIX: Loader Styles */
  #app-loader {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #020408; z-index: 99999; display: flex;
    justify-content: center; align-items: center;
  }
  .spinner {
    width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1);
    border-top-color: var(--accent); border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Hide main content initially */
  #main-content { display: none; width: 100%; }

  .sidebar{
    width:260px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-right:1px solid rgba(255,255,255,0.03);
    padding:28px 20px;
    display:flex;
    flex-direction:column;
    gap:18px;
    /* Mobile-specific properties */
    position: fixed; /* Fix sidebar position on mobile */
    top: 0;
    left: 0;
    height: 100%;
    z-index: 100;
    transform: translateX(-100%); /* Start hidden off-screen */
    transition: transform 0.3s ease;
    box-shadow: 2px 0 10px rgba(0,0,0,0.5);
  }
  .sidebar.open {
    transform: translateX(0); /* Slide in when open */
  }

  /* Hamburger Menu Button */
  #menu-toggle {
    display: none; /* Hidden by default on desktop */
    position: fixed;
    top: 20px;
    left: 20px;
    width: 40px;
    height: 40px;
    background: rgba(255,255,255,0.1);
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    z-index: 101; /* Above sidebar backdrop */
    font-size: 24px;
    line-height: 40px;
    text-align: center;
  }

  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent-2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:700;color:#051018;font-size:18px}
  nav{display:flex;flex-direction:column;gap:10px;margin-top:6px}
  .nav-link{display:flex;gap:12px;align-items:center;padding:10px 12px;border-radius:10px;color:var(--muted);cursor:pointer;text-decoration:none;font-size:14px}
  .nav-link.active, .nav-link:hover{background: linear-gradient(90deg, rgba(124,92,255,0.06), rgba(110,231,183,0.03));color:#e9fef0}
  
  .main{flex:1;padding:28px;display:flex;flex-direction:column;gap:20px}
  .top-bar{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .card-row{display:flex;gap:18px;align-items:stretch}
  .card{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:20px;flex:1;box-shadow:0 8px 30px rgba(2,6,12,0.6);min-height:110px}
  .big-card{flex:1.4}
  .balance-value{font-size:28px;font-weight:700;color:var(--accent)}
  .small{font-size:13px;color:var(--muted)}
  .actions{display:flex;gap:12px}
  .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#051018;font-weight:700}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);box-shadow:none}
  .buy-button{display:inline-block;padding:12px 16px;border-radius:12px;background:linear-gradient(90deg,#ff8a65,#ffb74d);color:#051018;font-weight:700;cursor:pointer}
  
  /* Modals */
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(2,6,12,0.6);z-index:999}
  .modal.open{display:flex}
  .modal-card{width:400px;max-width:95%;background:#071018;padding:24px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .form-row{display:flex;gap:8px;margin-top:12px}
  input, select{padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:#e6eef6;outline:none; width:100%}
  .tx-list{margin-top:12px;max-height:320px;overflow:auto;background:var(--card);padding:12px;border-radius:10px}
  .tx-item{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.02)}
  
  /* MEDIA QUERY FOR MOBILE DEVICES */
  @media(max-width:920px){
    /* Show menu toggle button */
    #menu-toggle { display: block; }
    
    /* On mobile, remove flex from body and rely on padding */
    body { display: block; }
    
    /* Make the main content take up full width and push it over for the button */
    .main { 
        padding-top: 70px; /* Make space for the fixed menu button */
        margin-left: 0;
    }
    
    /* Sidebar is hidden by default, position is fixed */
    .sidebar {
        transform: translateX(-100%);
        box-shadow: 0 0 0 transparent; /* Reset desktop shadow */
    }
    .sidebar.open {
        transform: translateX(0);
        box-shadow: 2px 0 10px rgba(0,0,0,0.5);
    }
    
    .card-row{flex-direction:column}
  }
</style>
</head>
<body>

<div id="app-loader"><div class="spinner"></div></div>

<div id="main-content">
  <button id="menu-toggle" aria-label="Toggle Menu">☰</button>

  <aside class="sidebar" id="sidebar">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="logo">SL</div>
      <div>
        <h1 style="margin:0;font-size:16px">Sublime Logs</h1>
        <p style="margin:0;font-size:12px;color:var(--muted)">Wallet & Numbers</p>
      </div>
    </div>
    <nav>
      <a href="#" class="nav-link active">Dashboard</a>
      <a href="wallet.html" class="nav-link">Wallet</a>
      <a href="transactions.html" class="nav-link">Transactions</a>
      <a href="#" class="nav-link" id="btn-logout">Logout</a>
    </nav>
    <div style="margin-top:auto;font-size:12px;color:var(--muted)">
      Signed in as: <div id="side-user" style="margin-top:8px;font-weight:600">...</div>
    </div>
  </aside>

  <main class="main">
    <div class="top-bar">
      <div>
        <h2 id="greeting">Welcome</h2>
        <p class="small">Your dashboard overview</p>
      </div>
      <div class="actions">
        <a href="wallet.html" class="btn" style="text-decoration:none;">Open Wallet</a>
        <button class="btn secondary" id="open-add-money">Fund Wallet</button>
      </div>
    </div>

    <div class="card-row">
      <div class="card">
        <div class="small">Available Balance</div>
        <div style="height:8px"></div>
        <div class="balance-value" id="balance">...</div>
      </div>
      <div class="card big-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Buy Number</div>
            <div style="font-weight:700;font-size:18px;margin-top:6px">Purchase a temporary number</div>
            <div class="small" style="margin-top:6px">WhatsApp, Google, Telegram, etc.</div>
          </div>
          <div><div class="buy-button" id="open-buy-modal">Buy Number</div></div>
        </div>
      </div>
    </div>

    <section>
      <h3 style="margin:20px 0 8px 0">Recent activity</h3>
      <div class="tx-list" id="tx-list"><div class="tx-item"><div class="small">Loading…</div></div></div>
    </section>
  </main>
</div>

<div class="modal" id="add-money-modal">
  <div class="modal-card">
    <h3 style="margin:0 0 8px 0">Fund Wallet</h3>
    <form id="deposit-form">
      <div class="small">Enter amount to fund your wallet.</div>
      <div style="height:10px"></div>
      <input type="number" id="pay-amount" placeholder="Amount (e.g. 1000)" min="50" required />
      <input type="email" id="pay-email-hidden" style="display:none;" />
      <div style="height:15px"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button type="button" class="btn secondary" id="close-add-money">Cancel</button>
        <button type="submit" class="btn" id="start-paystack">Pay Now</button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="buy-modal">
  <div class="modal-card">
    <h3 style="margin:0 0 8px 0">Buy Number</h3>
    <div class="form-row">
      <select id="buy-product">
          <option value="whatsapp">WhatsApp</option>
          <option value="google">Google</option>
          <option value="telegram">Telegram</option>
          <option value="facebook">Facebook</option>
          <option value="amazon">Amazon</option>
      </select>
      <input id="buy-country" placeholder="Country (e.g., 'england' or 'any')" />
    </div>
    <div style="height:15px"></div>
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button class="btn secondary" id="close-buy">Close</button>
      <button class="btn" id="confirm-buy">Buy</button>
    </div>
  </div>
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>

<script>
    // CRITICAL: YOUR 5SIM API TOKEN IS NOW PLACED HERE
    const FIVESIM_TOKEN = 'eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3OTExMjczNjYsImlhdCI6MTc1OTU5MTM2NiwicmF5IjoiYzdlMTU3YmE2MDU2ODNkNmZjNzUzMzE4NTc4YTg0ZTQiLCJzdWIiOjM1MzY0NTl9.dDT08PGc_jJa7c6i-24hMcIUpGmOhgagFL8FN1MpMpsp5LImU9xxvgZPylAGlyVjab4CaISbZb0kSm1YqaJnFUNro3hUvHH1qehlklQIi8aWQeXdQ-C6DrMTlQc0XRqVC5NIkPHRi699R5716vLoxUx0eud9na4XdU5ywJeRVaPdTW9jt4Nd1RBAuu8mxfIW_EBKCyPHUjVzt3qw-pETcBtcC3Ly0qS3XbhpOBOcCHERXEvmZEOiuVqJ-nqqOqa3dSVJbGGiz1MbXHmBqw3S8vxI0zTT_tUtU_JFJytipmpjw0QPnqSWTAHwfNiaxcq-B2mVHqaIZgOodaQ8Z2xbfw'; 
    const API_BASE_URL = 'https://5sim.net/v1/user';

    /**
     * Handles Fetch requests to 5sim API with token and error checking.
     * @param {string} endpoint - The 5sim endpoint (e.g., 'profile', 'buy/activation/russia/any/whatsapp')
     * @param {string} method - HTTP method (default 'GET')
     * @returns {Promise<Object>} - The JSON response data
     */
    async function fetch5sim(endpoint, method = 'GET') {
        const url = `${eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3OTExMjczNjYsImlhdCI6MTc1OTU5MTM2NiwicmF5IjoiYzdlMTU3YmE2MDU2ODNkNmZjNzUzMzE4NTc4YTg0ZTQiLCJzdWIiOjM1MzY0NTl9.dDT08PGc_jJa7c6i-24hMcIUpGmOhgagFL8FN1MpMpsp5LImU9xxvgZPylAGlyVjab4CaISbZb0kSm1YqaJnFUNro3hUvHH1qehlklQIi8aWQeXdQ-C6DrMTlQc0XRqVC5NIkPHRi699R5716vLoxUx0eud9na4XdU5ywJeRVaPdTW9jt4Nd1RBAuu8mxfIW_EBKCyPHUjVzt3qw-pETcBtcC3Ly0qS3XbhpOBOcCHERXEvmZEOiuVqJ-nqqOqa3dSVJbGGiz1MbXHmBqw3S8vxI0zTT_tUtU_JFJytipmpjw0QPnqSWTAHwfNiaxcq-B2mVHqaIZgOodaQ8Z2xbfw }/${endpoint}`;
        const headers = {
            'Authorization': `Bearer ${FIVESIM_TOKEN}`,
            'Accept': 'application/json',
        };

        try {
            const response = await fetch(url, { method, headers });
            const data = await response.json();

            // Check for non-2xx status codes
            if (!response.ok) {
                // 5sim often returns error details in the body
                const errorMsg = data.error || data.message || `HTTP status ${response.status}`;
                throw new Error(`5sim API Error: ${errorMsg}`);
            }
            return data;
        } catch (e) {
            console.error('5sim API Fetch Error:', e);
            throw e; // Re-throw to be caught by the calling function
        }
    }

    /**
     * Marks a 5sim order as finished. Called from the dynamically created button.
     * @param {HTMLElement} buttonElement - The button that was clicked
     */
    async function finish5simOrder(buttonElement) {
        const orderId = buttonElement.getAttribute('data-order-id');
        buttonElement.textContent = 'Finishing...';
        buttonElement.disabled = true;
        
        try {
            // Endpoint: /v1/user/finish/{id}
            await fetch5sim(`finish/${orderId}`);
            buttonElement.textContent = 'Finished!';
            buttonElement.style.background = 'var(--accent)'; // Greenish finish color
            alert(`Order ID ${orderId} successfully marked as FINISHED. You can use this number for other services now.`);
        } catch (e) {
            console.error('Error finishing 5sim order:', e);
            buttonElement.textContent = 'Error Finishing';
            buttonElement.disabled = false;
            alert(`Failed to finish order. Please try again or manually cancel/ban if necessary: ${e.message}`);
        }
    }
</script>

<script type="module">
  const PAYSTACK_KEY = 'pk_live_20505aa86cec6458bf2cc8cd926ecc06b87ff492';
  
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, collection, addDoc, query, orderBy, limit, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  // CORRECTED CONFIG: Using the 'sublime-log' project
  const firebaseConfig = {
    apiKey: "AIzaSyDRnNoRJ4Zgtu-KEZAdOAKtou2LV9rdL5c",
    authDomain: "sublime-log.firebaseapp.com",
    projectId: "sublime-log",
    storageBucket: "sublime-log.firebasestorage.app",
    messagingSenderId: "644554254089",
    appId: "1:644554254089:web:dd3374c9468046a5a015d8",
    measurementId: "G-YMPGVWCK16"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Persistence
  setPersistence(auth, browserLocalPersistence).catch(console.error);

  let currentUser = null;
  const appLoader = document.getElementById('app-loader');
  const mainContent = document.getElementById('main-content');
  const sidebar = document.getElementById('sidebar');
  const menuToggle = document.getElementById('menu-toggle');
  const bModal = document.getElementById('buy-modal'); // Define buy modal here

  // Helper to format name: uses displayName, or email prefix
  const formatUserName = (user) => {
      const name = user.displayName;
      if (name && name.trim().length > 0) return name;
      return user.email ? user.email.split('@')[0] : 'User';
  }

  // --- Mobile Menu Toggle Logic ---
  menuToggle.addEventListener('click', () => {
    sidebar.classList.toggle('open');
  });
  // Close menu when a link is clicked (mobile UX)
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', () => {
        if (window.innerWidth <= 920) {
            sidebar.classList.remove('open');
        }
    });
  });

  // --- CRITICAL: THE FIREBASE GUARD (onAuthStateChanged) ---
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      appLoader.style.display = 'none'; 
      mainContent.style.display = 'flex'; 

      const formattedName = formatUserName(user);
      document.getElementById('side-user').textContent = formattedName;
      document.getElementById('greeting').textContent = `Welcome, ${formattedName}`;
      document.getElementById('pay-email-hidden').value = user.email;

      // Real-time balance update
      onSnapshot(doc(db, "users", user.uid), (doc) => {
        if(doc.exists()) document.getElementById('balance').textContent = '₦' + (doc.data().balance || 0).toLocaleString(undefined, {minimumFractionDigits:2});
      });

      loadTransactions(user.uid);

    } else {
      window.location.href = 'login.html';
    }
  });

  // Logout
  document.getElementById('btn-logout').addEventListener('click', () => {
    signOut(auth).then(() => window.location.href = 'index.html');
  });

  // Modal Handlers
  const amModal = document.getElementById('add-money-modal');
  document.getElementById('open-add-money').addEventListener('click', () => amModal.classList.add('open'));
  document.getElementById('close-add-money').addEventListener('click', () => amModal.classList.remove('open'));
  document.getElementById('open-buy-modal').addEventListener('click', () => bModal.classList.add('open'));
  document.getElementById('close-buy').addEventListener('click', () => bModal.classList.remove('open'));

  // Paystack Logic (Unchanged)
  document.getElementById('deposit-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const amount = document.getElementById('pay-amount').value;
    const email = document.getElementById('pay-email-hidden').value;
    const btn = document.getElementById('start-paystack');

    if(amount < 50) return alert("Minimum ₦50");
    btn.textContent = "Processing...";
    btn.disabled = true;

    const handler = PaystackPop.setup({
      key: PAYSTACK_KEY, email: email, amount: amount * 100, currency: 'NGN',
      ref: 'SL-'+Math.floor(Math.random()*1000000000),
      callback: (res) => processDeposit(amount, res.reference),
      onClose: () => { btn.disabled = false; btn.textContent = "Pay Now"; }
    });
    handler.openIframe();
  });

  async function processDeposit(amount, ref) {
    amModal.classList.remove('open');
    document.getElementById('start-paystack').disabled = false;
    document.getElementById('start-paystack').textContent = "Pay Now";
    try {
        const userRef = doc(db, "users", currentUser.uid);
        await addDoc(collection(db, "users", currentUser.uid, "transactions"), {
            type: 'deposit', amount: Number(amount), date: new Date().toISOString(), reference: ref
        });
        await runTransaction(db, async (t) => {
            const sfDoc = await t.get(userRef);
            const newBal = (sfDoc.data().balance || 0) + Number(amount);
            t.update(userRef, { balance: newBal });
        });
        alert("Wallet Funded!");
    } catch(e) { console.error(e); alert("Error updating balance. Ref: " + ref); }
  }

  // Transaction Loader (Unchanged)
  async function loadTransactions(uid) {
    const list = document.getElementById('tx-list');
    const q = query(collection(db, "users", uid, "transactions"), orderBy("date", "desc"), limit(5));
    const snap = await getDocs(q);
    list.innerHTML = '';
    if(snap.empty) { list.innerHTML = '<div class="tx-item"><div class="small">No transactions</div></div>'; return; }
    snap.forEach(d => {
        const data = d.data();
        const isDep = data.type === 'deposit';
        const formattedAmount = Number(data.amount).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        list.innerHTML += `
        <div class="tx-item">
            <div><div style="font-weight:700">${isDep?'+':'-'} ₦${formattedAmount}</div><div class="small">${new Date(data.date).toLocaleDateString()}</div></div>
            <div style="font-weight:700;color:${isDep?'var(--accent)':'#ff8a8a'}">${data.type.toUpperCase()}</div>
        </div>`;
    });
  }

  // --- 5SIM HELPER: Poll for SMS Code ---
  /** Polls the check endpoint until the status is 'RECEIVED' or 'BANNED'. */
  function checkOrderStatus(orderId) {
      return new Promise((resolve, reject) => {
          const checkInterval = setInterval(async () => {
              try {
                  // fetch5sim is globally available
                  const order = await fetch5sim(`check/${orderId}`);
                  
                  if (order.status === 'RECEIVED') {
                      clearInterval(checkInterval);
                      resolve(order); // SMS code is in order.sms[0].code
                  } else if (order.status === 'BANNED' || order.status === 'CANCELLED') {
                      clearInterval(checkInterval);
                      reject(new Error(`Order failed with status: ${order.status}. Try again.`));
                  }
                  // PENDING: Keep polling
                  
              } catch (error) {
                  clearInterval(checkInterval);
                  reject(error);
              }
          }, 5000); // Check every 5 seconds
      });
  }


  // --- 5SIM: BUY NUMBER LOGIC ---
  document.getElementById('confirm-buy').addEventListener('click', async () => {
      const product = document.getElementById('buy-product').value;
      const country = document.getElementById('buy-country').value.toLowerCase().trim();
      const btn = document.getElementById('confirm-buy');
      
      if (!country) return alert("Please enter a country (e.g., 'england' or 'any').");

      const operator = 'any'; 
      const type = 'activation'; 

      // 1. UI Feedback and State
      btn.textContent = 'Purchasing...';
      btn.disabled = true;
      bModal.classList.remove('open'); 
      const recentActivitySection = document.getElementById('tx-list');


      try {
          // --- 2. 5SIM API: Buy Number ---
          // Endpoint: /v1/user/buy/activation/{country}/{operator}/{product}
          const orderEndpoint = `buy/${type}/${country}/${operator}/${product}`;
          const order = await fetch5sim(orderEndpoint);
          const orderId = order.id;
          const number = order.phone;
          const price = order.price; 

          // --- 3. FIREBASE: Deduct Balance (Atomic Transaction) ---
          const userRef = doc(db, "users", currentUser.uid);

          await runTransaction(db, async (t) => {
              const sfDoc = await t.get(userRef);
              if (!sfDoc.exists()) throw new Error("User document does not exist!");
              
              const currentBalance = sfDoc.data().balance || 0;
              const newBal = currentBalance - price;

              if (newBal < 0) {
                  // Cancel the 5sim order if balance is insufficient (best effort)
                  await fetch5sim(`cancel/${orderId}`).catch(e => console.error("Could not auto-cancel 5sim order:", e));
                  throw new Error(`Insufficient funds (₦${currentBalance}). Price was ₦${price}. Order cancelled.`);
              }

              // Update balance and log number purchase transaction
              t.update(userRef, { balance: newBal });
              t.set(doc(collection(db, "users", currentUser.uid, "transactions")), {
                  type: 'number_purchase', 
                  amount: -Number(price), 
                  date: new Date().toISOString(), 
                  reference: `5SIM-ID-${orderId}`,
                  number: number,
                  product: product,
              });
          });

          // --- 4. SUCCESS UI / Start Polling for SMS ---
          const numberDisplayId = `number-display-${orderId}`;
          recentActivitySection.innerHTML = `
              <div id="${numberDisplayId}" style="padding:15px; background:#1c2430; border-radius:8px; margin-bottom:15px;">
                  <p style="margin:0; font-size:16px; font-weight:700;">
                      Your ${product.toUpperCase()} Number: <span style="color:var(--accent-2);">${number}</span>
                  </p>
                  <p style="margin:5px 0 0 0; color:var(--muted);">
                      Waiting for SMS Code... <span class="spinner" style="width:15px; height:15px; border-width:2px; display:inline-block; vertical-align:middle;"></span>
                  </p>
              </div>
          ` + recentActivitySection.innerHTML;

          // --- 5. 5SIM API: Wait for SMS Code ---
          const receivedOrder = await checkOrderStatus(orderId);
          const smsCode = receivedOrder.sms[0]?.code;

          // Update UI with the code and mark as received
          const numberDisplay = document.getElementById(numberDisplayId);
          numberDisplay.innerHTML = `
              <p style="margin:0; font-size:16px; font-weight:700;">
                  Number: <span style="color:var(--accent-2);">${number}</span> | Service: ${product.toUpperCase()}
              </p>
              <h3 style="margin:10px 0;">Verification Code: <span style="color:var(--accent);">${smsCode || 'N/A (Check SMS Inbox)'}</span></h3>
              <button class="btn secondary" data-order-id="${orderId}" onclick="finish5simOrder(this)" style="padding:5px 10px; font-size:12px;">
                  Confirm & Finish Order
              </button>
          `;

      } catch (e) {
          alert(`Purchase failed: ${e.message}`);
          console.error('Number purchase failed:', e);
          loadTransactions(currentUser.uid); 
      } finally {
          btn.textContent = 'Buy';
          btn.disabled = false;
      }
  });

</script>
</body>
</html>
