<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard — Sublime Logs</title>
<style>
  :root{ --bg:#0b0f13; --card:#161b22; --input-bg:#0d1117; --muted:#8b949e; --text:#c9d1d9; --accent:#2ea043; --accent-hover:#3fb950; --border:rgba(240,246,252,0.1); --danger:#f85149; --warning:#d29922; }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;}
  
  /* Layout */
  .sidebar{width:250px;background:var(--card);border-right:1px solid var(--border);padding:20px;display:flex;flex-direction:column;gap:15px;position:fixed;height:100%;}
  .main{margin-left:250px;flex:1;padding:30px;max-width:1200px;}
  @media(max-width:800px){ .sidebar{display:none} .main{margin-left:0;padding:15px} }

  /* Typography */
  h1,h2,h3{margin:0;color:#fff}
  .label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block;text-transform:uppercase;letter-spacing:0.5px;}
  
  /* Cards */
  .card{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:20px;margin-bottom:20px;}
  
  /* Inputs & Buttons */
  select, input{width:100%;padding:10px;background:var(--input-bg);border:1px solid var(--border);border-radius:6px;color:#fff;font-size:14px;outline:none;}
  select:focus, input:focus{border-color:var(--accent);}
  
  .btn{background:var(--accent);color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;transition:0.2s;}
  .btn:hover{background:var(--accent-hover);}
  .btn:disabled{opacity:0.5;cursor:not-allowed;background:var(--muted);}
  .btn.secondary{background:#21262d;border:1px solid var(--border);color:var(--text);}
  
  /* Step Interface */
  .step-container{display:none; animation: fadeIn 0.3s ease;}
  .step-container.active{display:block;}
  @keyframes fadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
  
  /* Availability List */
  .offer-list{display:grid;grid-template-columns:repeat(auto-fill, minmax(180px, 1fr));gap:10px;margin-top:15px;}
  .offer-item{background:var(--input-bg);border:1px solid var(--border);padding:15px;border-radius:6px;cursor:pointer;transition:0.2s;text-align:center;}
  .offer-item:hover{border-color:var(--accent);background:#1c2128;}
  .offer-price{font-size:18px;font-weight:bold;color:#fff;margin:5px 0;}
  .offer-stock{font-size:11px;color:var(--muted);}

  /* Data Table */
  .table-container{overflow-x:auto;}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px;}
  th{text-align:left;padding:12px;border-bottom:1px solid var(--border);color:var(--muted);font-weight:500;}
  td{padding:12px;border-bottom:1px solid var(--border);color:#fff;}
  tr:last-child td{border-bottom:none;}
  
  /* Badges */
  .badge{padding:3px 8px;border-radius:12px;font-size:10px;font-weight:700;text-transform:uppercase;}
  .status-pending{background:rgba(210,153,34,0.15);color:#e3b341;}
  .status-finished{background:rgba(46,160,67,0.15);color:#3fb950;}
  .status-canceled{background:rgba(248,81,73,0.15);color:#f85149;}
  .code-box{font-family:monospace;background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:4px;letter-spacing:1px;}

  /* Header */
  .top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;}
  .balance-card{text-align:right;}
  .balance-amount{font-size:24px;font-weight:700;color:var(--accent);}
</style>
</head>
<body>

<aside class="sidebar">
  <div style="font-weight:bold;font-size:18px;margin-bottom:20px;padding-left:5px;">Sublime Logs</div>
  <a href="#" class="btn secondary" style="text-align:left;border:none;background:rgba(255,255,255,0.05);">Dashboard</a>
  <a href="wallet.html" class="btn secondary" style="text-align:left;border:none;background:transparent;">Wallet</a>
  <div style="margin-top:auto;font-size:12px;color:var(--muted)">User: <span id="user-email">...</span></div>
  <button id="logout" class="btn secondary" style="margin-top:10px;">Logout</button>
</aside>

<main class="main">
  
  <div class="top-bar">
    <div>
      <h2>New Order</h2>
      <div style="color:var(--muted);font-size:14px">Buy verification numbers securely</div>
    </div>
    <div class="balance-card">
        <div class="label">Wallet Balance</div>
        <div class="balance-amount" id="balance">...</div>
    </div>
  </div>

  <div class="card">
    
    <div id="step-1" class="step-container active">
        <h3 style="margin-bottom:15px">1. Select Country</h3>
        <div class="label">Choose the country for the number</div>
        <select id="sel-country" style="margin-bottom:15px; max-width:400px;"></select>
        <button class="btn" onclick="goToStep2()">Continue &rarr;</button>
    </div>

    <div id="step-2" class="step-container">
        <h3 style="margin-bottom:15px">2. Select Service</h3>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
             <button class="btn secondary" style="padding:5px 10px;font-size:12px;" onclick="goToStep1()">&larr; Back</button>
             <div class="label" style="margin:0">Selected: <span id="display-country" style="color:#fff"></span></div>
        </div>
        
        <div class="label">Choose the App/Website</div>
        <select id="sel-service" style="margin-bottom:15px; max-width:400px;"></select>
        <button class="btn" id="btn-check-avail">Check Availability</button>
    </div>

    <div id="step-3" class="step-container">
        <h3 style="margin-bottom:15px">3. Available Numbers</h3>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
             <button class="btn secondary" style="padding:5px 10px;font-size:12px;" onclick="goToStep2()">&larr; Back</button>
             <div class="label" style="margin:0">For: <span id="display-final" style="color:#fff"></span></div>
        </div>
        
        <div id="results-loader" style="display:none;color:var(--muted);">Fetching best prices...</div>
        <div id="offers-grid" class="offer-list"></div>
    </div>

  </div>

  <h3 style="margin-top:40px;margin-bottom:15px;">Transaction History</h3>
  <div class="card" style="padding:0;">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th style="width:50px">No.</th>
                    <th>Phone Number</th>
                    <th>Code</th>
                    <th>Service</th>
                    <th>Price</th>
                    <th>Country</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="history-table-body">
                <tr><td colspan="9" style="text-align:center;color:var(--muted)">Loading history...</td></tr>
            </tbody>
        </table>
    </div>
  </div>

</main>

<script type="module">
  // ================= CONFIGURATION =================
  const API_URL = "https://eod5fsiqjjs71gx.m.pipedream.net"; // YOUR PIPEDREAM URL
  const EXCHANGE_RATE = 15; // 1 Ruble = 15 Naira
  // =================================================

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, collection, query, orderBy, limit, runTransaction, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDRnNoRJ4Zgtu-KEZAdOAKtou2LV9rdL5c",
    authDomain: "sublime-log.firebaseapp.com",
    projectId: "sublime-log",
    storageBucket: "sublime-log.firebasestorage.app",
    messagingSenderId: "644554254089",
    appId: "1:644554254089:web:dd3374c9468046a5a015d8"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;

  // --- STATIC DATA (To prevent Network Fail) ---
  const countries = [
      {code:"usa", name:"USA"}, {code:"england", name:"UK"}, {code:"nigeria", name:"Nigeria"},
      {code:"russia", name:"Russia"}, {code:"ukraine", name:"Ukraine"}, {code:"kazakhstan", name:"Kazakhstan"},
      {code:"kenya", name:"Kenya"}, {code:"ghana", name:"Ghana"}, {code:"southafrica", name:"South Africa"},
      {code:"brazil", name:"Brazil"}, {code:"india", name:"India"}, {code:"indonesia", name:"Indonesia"},
      {code:"philippines", name:"Philippines"}, {code:"vietnam", name:"Vietnam"}, {code:"thailand", name:"Thailand"},
      {code:"germany", name:"Germany"}, {code:"france", name:"France"}, {code:"netherlands", name:"Netherlands"},
      {code:"poland", name:"Poland"}, {code:"canada", name:"Canada"}
  ];
  const services = [
      {code:"whatsapp", name:"WhatsApp"}, {code:"telegram", name:"Telegram"}, {code:"google", name:"Google / Gmail"},
      {code:"facebook", name:"Facebook"}, {code:"instagram", name:"Instagram"}, {code:"tiktok", name:"TikTok"},
      {code:"twitter", name:"X (Twitter)"}, {code:"linkedin", name:"LinkedIn"}, {code:"netflix", name:"Netflix"},
      {code:"uber", name:"Uber"}, {code:"amazon", name:"Amazon"}, {code:"discord", name:"Discord"},
      {code:"viber", name:"Viber"}, {code:"wechat", name:"WeChat"}, {code:"snapchat", name:"Snapchat"},
      {code:"openai", name:"OpenAI / ChatGPT"}, {code:"microsoft", name:"Microsoft"}, {code:"yahoo", name:"Yahoo"},
      {code:"airbnb", name:"Airbnb"}, {code:"bolt", name:"Bolt"}
  ];

  // --- AUTH & INIT ---
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('user-email').textContent = user.email;
      
      // Balance Listener
      onSnapshot(doc(db, "users", user.uid), (docSnap) => {
         const bal = docSnap.exists() ? docSnap.data().balance : 0;
         document.getElementById('balance').textContent = '₦' + (bal || 0).toLocaleString();
      });

      // Load History
      loadHistory();
      
      // Populate Dropdowns
      initDropdowns();
    } else {
      window.location.href = 'login.html'; // Adjust to your login page
    }
  });
  
  document.getElementById('logout').addEventListener('click', () => signOut(auth));

  // --- UI STEPS LOGIC ---
  function initDropdowns() {
      // Sort and Populate Countries
      countries.sort((a,b) => a.name.localeCompare(b.name));
      const countrySel = document.getElementById('sel-country');
      countries.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.code; opt.text = c.name;
          countrySel.appendChild(opt);
      });

      // Sort and Populate Services
      services.sort((a,b) => a.name.localeCompare(b.name));
      const serviceSel = document.getElementById('sel-service');
      services.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.code; opt.text = s.name;
          serviceSel.appendChild(opt);
      });
  }

  // Expose functions to window for onclick events
  window.goToStep1 = () => {
      document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
      document.getElementById('step-1').classList.add('active');
  };

  window.goToStep2 = () => {
      const cCode = document.getElementById('sel-country').value;
      const cName = countries.find(x => x.code === cCode).name;
      document.getElementById('display-country').textContent = cName;
      
      document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
      document.getElementById('step-2').classList.add('active');
  };

  // --- CHECK AVAILABILITY LOGIC ---
  document.getElementById('btn-check-avail').addEventListener('click', async () => {
      const country = document.getElementById('sel-country').value;
      const service = document.getElementById('sel-service').value;
      
      // Update UI to Step 3
      document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
      document.getElementById('step-3').classList.add('active');
      
      const sName = services.find(x => x.code === service).name;
      const cName = countries.find(x => x.code === country).name;
      document.getElementById('display-final').textContent = `${sName} in ${cName}`;
      
      const grid = document.getElementById('offers-grid');
      const loader = document.getElementById('results-loader');
      
      grid.innerHTML = '';
      loader.style.display = 'block';

      try {
          const res = await fetch(`${API_URL}/prices`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ country, product: service })
          });
          
          const data = await res.json();
          loader.style.display = 'none';

          if(!data.offers || data.offers.length === 0) {
              grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--warning)">No numbers available right now. Try a different country.</div>';
              return;
          }

          // RENDER OFFERS
          data.offers.forEach(offer => {
             const priceNaira = Math.ceil(offer.cost * EXCHANGE_RATE);
             
             const div = document.createElement('div');
             div.className = 'offer-item';
             div.innerHTML = `
                <div style="font-weight:600;text-transform:uppercase;font-size:12px;color:var(--muted)">${offer.operator}</div>
                <div class="offer-price">₦${priceNaira}</div>
                <div class="offer-stock">Qty: ${offer.count}</div>
                <button class="btn" style="width:100%;margin-top:10px;font-size:12px;padding:8px" 
                   onclick="buyNumber('${country}', '${service}', '${offer.operator}', ${priceNaira})">
                   Buy
                </button>
             `;
             grid.appendChild(div);
          });

      } catch(e) {
          loader.style.display = 'none';
          grid.innerHTML = '<div style="color:var(--danger)">Network Error. Please try again.</div>';
      }
  });

  // --- BUY LOGIC ---
  window.buyNumber = async (country, product, operator, cost) => {
      if(!confirm(`Buy ${product} number for ₦${cost}?`)) return;
      
      // 1. Check Balance & Deduct (Frontend optimistically, Backend verifies)
      const userRef = doc(db, "users", currentUser.uid);
      
      try {
        let apiData = null;

        // Transaction: Check Balance
        await runTransaction(db, async (t) => {
            const uDoc = await t.get(userRef);
            const currentBal = uDoc.data().balance || 0;
            if(currentBal < cost) throw "Insufficient Balance";
            
            // If balance ok, call API *inside* try block but before DB commit? 
            // Better: Call API first, then deduct. 
        });

        // 2. Call API
        const res = await fetch(`${API_URL}/buy`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ country, product, operator })
        });
        const data = await res.json();
        
        if(!res.ok || data.error) throw data.error || "Purchase failed";
        apiData = data;

        // 3. Deduct & Save Order
        await runTransaction(db, async (t) => {
            const uDoc = await t.get(userRef);
            const currentBal = uDoc.data().balance || 0;
            if(currentBal < cost) throw "Insufficient Balance";

            // Deduct
            t.update(userRef, { balance: currentBal - cost });
            
            // Add Order
            const newOrderRef = doc(collection(userRef, "orders"));
            t.set(newOrderRef, {
                id: apiData.id,
                phone: apiData.phone,
                product: product,
                country: country,
                cost: cost,
                status: 'PENDING', 
                code: null,
                createdAt: new Date().toISOString()
            });
        });

        alert("Number Purchased Successfully!");
        window.goToStep1(); // Reset UI
        
      } catch(e) {
          alert("Error: " + e);
      }
  };

  // --- HISTORY TABLE LOGIC ---
  function loadHistory() {
      const q = query(collection(db, "users", currentUser.uid, "orders"), orderBy("createdAt", "desc"), limit(20));
      const tbody = document.getElementById('history-table-body');
      
      onSnapshot(q, (snapshot) => {
          tbody.innerHTML = '';
          if(snapshot.empty) {
              tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px;color:var(--muted)">No transactions yet.</td></tr>';
              return;
          }
          
          let index = 1;
          snapshot.forEach(docSnap => {
              const d = docSnap.data();
              const tr = document.createElement('tr');
              
              // Status Styling
              let statusClass = '';
              let codeDisplay = '';
              
              if(d.status === 'PENDING') {
                  statusClass = 'status-pending';
                  codeDisplay = '<span style="color:var(--muted);font-style:italic;font-size:11px">Waiting...</span>';
              } else if (d.status === 'FINISHED') {
                  statusClass = 'status-finished';
                  codeDisplay = `<span class="code-box">${d.code}</span>`;
              } else {
                  statusClass = 'status-canceled';
                  codeDisplay = '-';
              }
              
              // Date Formatting
              const dateObj = new Date(d.createdAt);
              const dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

              // Action Button
              let actionBtn = '';
              if(d.status === 'PENDING') {
                  actionBtn = `<button class="btn secondary" style="padding:4px 8px;font-size:11px" onclick="checkSMS('${docSnap.id}', '${d.id}')">Check SMS</button>`;
              }

              tr.innerHTML = `
                <td>${index++}</td>
                <td>${d.phone}</td>
                <td>${codeDisplay}</td>
                <td style="text-transform:capitalize">${d.product}</td>
                <td>₦${d.cost}</td>
                <td style="text-transform:capitalize">${d.country}</td>
                <td><span class="badge ${statusClass}">${d.status}</span></td>
                <td>${dateStr}</td>
                <td>${actionBtn}</td>
              `;
              tbody.appendChild(tr);
          });
      });
  }

  // --- SMS CHECKER ---
  window.checkSMS = async (docId, orderId) => {
      const btn = event.target;
      const originalText = btn.innerText;
      btn.innerText = "..."; btn.disabled = true;

      try {
          const res = await fetch(`${API_URL}/check`, {
             method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({orderId})
          });
          const data = await res.json();
          
          if(data.sms && data.sms.length > 0) {
              // Success
              await updateDoc(doc(db, "users", currentUser.uid, "orders", docId), {
                  status: 'FINISHED', code: data.sms[0].code
              });
          } else if (data.status === 'CANCELED' || data.status === 'BANNED') {
              // Refund Logic would go here (same as previous script)
              await updateDoc(doc(db, "users", currentUser.uid, "orders", docId), { status: 'CANCELED' });
              alert("Order Canceled by Network.");
          } else {
              alert("Still waiting for SMS...");
          }
      } catch(e) {
          console.error(e);
      } finally {
          btn.innerText = originalText; btn.disabled = false;
      }
  };
</script>

</body>
</html>
