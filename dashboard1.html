<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard — Sublime Logs</title>
<style>
  :root{ 
    --bg:#0b0f13; 
    --card:#0f1720; 
    --input-bg:rgba(255,255,255,0.03); /* Unified input background */
    --muted:#98a0a8; 
    --text:#e6eef6; /* Light text color */
    --accent:#6ee7b7; /* Primary accent */
    --accent-2:#7c5cff; /* Secondary accent */
    --border:rgba(255,255,255,0.04); /* Light border */
    --danger:#ff8a8a;
    --warning:#facc15;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter,system-ui,Arial;
    background:radial-gradient(1200px 600px at 10% 10%, rgba(124,92,255,0.06), transparent 5%),
               linear-gradient(180deg,#020408 0%, #061018 100%);
    color:var(--text);
    min-height:100vh;
    display:flex;
  }
  
  /* CORE FIX: Loader Styles */
  #app-loader {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #020408; z-index: 99999; display: flex;
    justify-content: center; align-items: center;
  }
  .spinner {
    width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1);
    border-top-color: var(--accent); border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Hide main content initially */
  #main-content { display: none; width: 100%; }

  /* Layout and Sidebar */
  .sidebar{
    width:260px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-right:1px solid var(--border);
    padding:28px 20px;
    display:flex;
    flex-direction:column;
    gap:18px;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    z-index: 100;
    transform: translateX(0); /* Start visible on desktop */
    transition: transform 0.3s ease;
    box-shadow: 2px 0 10px rgba(0,0,0,0.5);
  }
  /* Desktop: Main content shifts over */
  .main{
    flex:1;
    padding:28px;
    display:flex;
    flex-direction:column;
    gap:20px;
    margin-left: 260px; /* Offset for sidebar */
    max-width: 1200px; /* Limit dashboard width */
    width: 100%;
  }

  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent-2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:700;color:#051018;font-size:18px}
  nav{display:flex;flex-direction:column;gap:10px;margin-top:6px}
  .nav-link{display:flex;gap:12px;align-items:center;padding:10px 12px;border-radius:10px;color:var(--muted);cursor:pointer;text-decoration:none;font-size:14px; transition: background 0.2s, color 0.2s;}
  .nav-link.active, .nav-link:hover{background: linear-gradient(90deg, rgba(124,92,255,0.06), rgba(110,231,183,0.03));color:var(--text)}
  
  .top-bar{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .card-row{display:flex;gap:18px;align-items:stretch}
  .card{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:20px;flex:1;box-shadow:0 8px 30px rgba(2,6,12,0.6);min-height:110px; border: 1px solid var(--border);}
  .big-card{flex:1.4}
  .balance-value{font-size:28px;font-weight:700;color:var(--accent)}
  .small{font-size:13px;color:var(--muted)}
  .actions{display:flex;gap:12px}

  /* Buttons */
  .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#051018;font-weight:700;transition:opacity 0.2s}
  .btn:hover{opacity:0.9}
  .btn.secondary{background:transparent;border:1px solid var(--border);color:var(--muted);box-shadow:none}
  .buy-button{display:inline-block;padding:12px 16px;border-radius:12px;background:linear-gradient(90deg,#ff8a65,#ffb74d);color:#051018;font-weight:700;cursor:pointer;transition:opacity 0.2s}
  .buy-button:hover{opacity:0.9}

  /* Inputs & Selects */
  input, select{padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--input-bg);color:var(--text);outline:none; width:100%; transition: border-color 0.2s;}
  input:focus, select:focus{border-color:var(--accent-2);}
  
  /* Modals */
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(2,6,12,0.8);z-index:999}
  .modal.open{display:flex}
  .modal-card{width:450px;max-width:95%;background:#071018;padding:24px;border-radius:12px;border:1px solid var(--border); max-height: 90vh; overflow-y: auto;}
  .form-row{display:flex;gap:8px;margin-top:12px}
  
  /* Transaction List (Retained for the dashboard view) */
  .tx-list{margin-top:12px;max-height:320px;overflow-y:auto;background:var(--card);padding:12px;border-radius:10px; border: 1px solid var(--border)}
  .tx-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .tx-item:last-child{border-bottom:none;}
  
  /* Buy Modal specific: Grid for Services/Countries (optional styling for clarity) */
  .modal-label {font-size:12px;color:var(--muted);margin-bottom:4px;display:block;}

  /* Hamburger Menu Button */
  #menu-toggle {
    display: none; 
    position: fixed;
    top: 20px;
    left: 20px;
    width: 40px;
    height: 40px;
    background: rgba(255,255,255,0.1);
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    z-index: 101; 
    font-size: 24px;
    line-height: 40px;
    text-align: center;
    transition: all 0.2s;
  }
  #menu-toggle:hover {
    background: rgba(255,255,255,0.2);
  }

  /* MEDIA QUERY FOR MOBILE DEVICES */
  @media(max-width:920px){
    /* Show menu toggle button */
    #menu-toggle { display: block; }
    
    /* Make the main content take up full width and account for the button's margin */
    .main { 
        padding-top: 70px; 
        margin-left: 0; /* Remove desktop offset */
    }
    
    /* Sidebar is hidden by default, position is fixed */
    .sidebar {
        transform: translateX(-100%);
        box-shadow: none; 
    }
    .sidebar.open {
        transform: translateX(0);
        box-shadow: 2px 0 10px rgba(0,0,0,0.5);
    }
    
    /* Ensure the mobile body doesn't cause horizontal scroll */
    body { display: block; overflow-x: hidden; }

    /* Stack cards on mobile */
    .card-row{flex-direction:column}
    
    /* Top-bar actions can stack or wrap */
    .actions { flex-wrap: wrap; }
  }
</style>
</head>
<body>

<div id="app-loader"><div class="spinner"></div></div>

<div id="main-content">
  <button id="menu-toggle" aria-label="Toggle Menu">☰</button>

  <aside class="sidebar" id="sidebar">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="logo">SL</div>
      <div>
        <h1 style="margin:0;font-size:16px">Sublime Logs</h1>
        <p style="margin:0;font-size:12px;color:var(--muted)">Wallet & Numbers</p>
      </div>
    </div>
    <nav>
      <a href="#" class="nav-link active">Dashboard</a>
      <a href="wallet.html" class="nav-link">Wallet</a>
      <a href="#" class="nav-link" id="open-add-money-sidebar">Fund Wallet</a> <a href="transactions.html" class="nav-link">Transactions</a>
      <a href="index.html" class="nav-link" id="btn-logout">Logout</a> </nav>
    <div style="margin-top:auto;font-size:12px;color:var(--muted)">
      Signed in as: <div id="side-user" style="margin-top:8px;font-weight:600">...</div>
    </div>
  </aside>

  <main class="main">
    <div class="top-bar">
      <div>
        <h2 id="greeting">Welcome</h2>
        <p class="small">Your dashboard overview</p>
      </div>
      <div class="actions">
        <a href="wallet.html" class="btn secondary" style="text-decoration:none;">Open Wallet</a>
        <button class="btn" id="open-add-money">Fund Wallet</button>
      </div>
    </div>

    <div class="card-row">
      <div class="card">
        <div class="small">Available Balance</div>
        <div style="height:8px"></div>
        <div class="balance-value" id="balance">...</div>
      </div>
      <div class="card big-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Buy Number</div>
            <div style="font-weight:700;font-size:18px;margin-top:6px">Purchase a temporary number</div>
            <div class="small" style="margin-top:6px">WhatsApp, Google, Telegram, etc.</div>
          </div>
          <div><div class="buy-button" id="open-buy-modal">Buy Number</div></div>
        </div>
      </div>
    </div>

    <section>
      <h3 style="margin:20px 0 8px 0">Recent Transactions</h3>
      <div class="tx-list" id="tx-list"><div class="tx-item"><div class="small">Loading…</div></div></div>
    </section>
  </main>
</div>

<div class="modal" id="add-money-modal">
  <div class="modal-card">
    <h3 style="margin:0 0 8px 0">Fund Wallet</h3>
    <form id="deposit-form">
      <div class="small">Enter amount to fund your wallet (in NGN).</div>
      <div style="height:10px"></div>
      <input type="number" id="pay-amount" placeholder="Amount (e.g. 1000)" min="50" required />
      <input type="email" id="pay-email-hidden" style="display:none;" />
      <div style="height:15px"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button type="button" class="btn secondary" id="close-add-money">Cancel</button>
        <button type="submit" class="btn" id="start-paystack">Pay Now to Sublime Logs</button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="buy-modal">
  <div class="modal-card">
    <h3 style="margin:0 0 15px 0">Buy Verification Number</h3>
    
    <div class="modal-label">Select Service (App/Website)</div>
    <select id="buy-service" style="margin-bottom: 15px;">
      </select>

    <div class="modal-label">Select Country</div>
    <select id="buy-country" style="margin-bottom: 15px;">
      </select>

    <div style="height:15px"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:16px;">
        <div id="price-display" style="color:var(--muted)">Price: ...</div>
    </div>
    <div style="height:15px"></div>

    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button class="btn secondary" id="close-buy">Close</button>
      <button class="btn" id="confirm-buy">Buy Number</button>
    </div>
  </div>
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>

<script type="module">
  const PAYSTACK_KEY = 'pk_live_20505aa86cec6458bf2cc8cd926ecc06b87ff492';
  
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, collection, addDoc, query, orderBy, limit, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  // Using the 'sublime-log' project
  const firebaseConfig = {
    apiKey: "AIzaSyDRnNoRJ4Zgtu-KEZAdOAKtou2LV9rdL5c",
    authDomain: "sublime-log.firebaseapp.com",
    projectId: "sublime-log",
    storageBucket: "sublime-log.firebasestorage.app",
    messagingSenderId: "644554254089",
    appId: "1:644554254089:web:dd3374c9468046a5a015d8",
    measurementId: "G-YMPGVWCK16"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Persistence
  setPersistence(auth, browserLocalPersistence).catch(console.error);

  let currentUser = null;
  const appLoader = document.getElementById('app-loader');
  const mainContent = document.getElementById('main-content');
  const sidebar = document.getElementById('sidebar');
  const menuToggle = document.getElementById('menu-toggle');
  
  // ================= EXPANDED STATIC DATA =================
  const countries = [
    { code: "usa", name: "USA" }, { code: "uk", name: "United Kingdom" }, { code: "nigeria", name: "Nigeria" },
    { code: "russia", name: "Russia" }, { code: "china", name: "China" }, { code: "india", name: "India" },
    { code: "brazil", name: "Brazil" }, { code: "germany", name: "Germany" }, { code: "france", name: "France" },
    { code: "canada", name: "Canada" }, { code: "australia", name: "Australia" }, { code: "japan", name: "Japan" },
    { code: "mexico", name: "Mexico" }, { code: "italy", name: "Italy" }, { code: "spain", name: "Spain" },
    { code: "uae", name: "United Arab Emirates" }, { code: "saudiarabia", name: "Saudi Arabia" },
    { code: "southafrica", name: "South Africa" }, { code: "egypt", name: "Egypt" }, { code: "indonesia", name: "Indonesia" },
    { code: "philippines", name: "Philippines" }, { code: "vietnam", name: "Vietnam" }, { code: "thailand", name: "Thailand" },
    { code: "korea", name: "South Korea" }, { code: "turkey", name: "Turkey" }, { code: "pakistan", name: "Pakistan" },
    { code: "argentina", name: "Argentina" }, { code: "colombia", name: "Colombia" }, { code: "chile", name: "Chile" },
    { code: "peru", name: "Peru" }, { code: "kazakhstan", name: "Kazakhstan" }, { code: "ukraine", name: "Ukraine" },
    { code: "poland", name: "Poland" }, { code: "netherlands", name: "Netherlands" }, { code: "sweden", name: "Sweden" },
    { code: "norway", name: "Norway" }, { code: "denmark", name: "Denmark" }, { code: "finland", name: "Finland" },
    { code: "portugal", name: "Portugal" }, { code: "greece", name: "Greece" }, { code: "ireland", name: "Ireland" },
    { code: "newzealand", name: "New Zealand" }, { code: "singapore", name: "Singapore" }, { code: "malaysia", name: "Malaysia" },
    { code: "kenya", name: "Kenya" }, { code: "ghana", name: "Ghana" }, { code: "morocco", name: "Morocco" },
    { code: "algeria", name: "Algeria" }, { code: "bangladesh", name: "Bangladesh" }, { code: "venezuela", name: "Venezuela" },
    { code: "belgium", name: "Belgium" }, { code: "switzerland", name: "Switzerland" }, { code: "austria", name: "Austria" },
    // Add more countries for a near-complete list (approx 100+ total)
    { code: "afghanistan", name: "Afghanistan" }, { code: "albania", name: "Albania" }, { code: "andorra", name: "Andorra" },
    { code: "angola", name: "Angola" }, { code: "armenia", name: "Armenia" }, { code: "azerbaijan", name: "Azerbaijan" },
    { code: "bahamas", name: "Bahamas" }, { code: "bahrain", name: "Bahrain" }, { code: "barbados", name: "Barbados" },
    { code: "belarus", name: "Belarus" }, { code: "benin", name: "Benin" }, { code: "bolivia", name: "Bolivia" },
    { code: "bosnia", name: "Bosnia and Herzegovina" }, { code: "botswana", name: "Botswana" }, { code: "bulgaria", name: "Bulgaria" },
    { code: "burkinafaso", name: "Burkina Faso" }, { code: "burundi", name: "Burundi" }, { code: "cambodia", name: "Cambodia" },
    { code: "cameroon", name: "Cameroon" }, { code: "cyprus", name: "Cyprus" }, { code: "czechia", name: "Czechia" },
    { code: "ecuador", name: "Ecuador" }, { code: "ethiopia", name: "Ethiopia" }, { code: "georgia", name: "Georgia" },
    { code: "honduras", name: "Honduras" }, { code: "hungary", name: "Hungary" }, { code: "iceland", name: "Iceland" },
    { code: "iraq", name: "Iraq" }, { code: "israel", name: "Israel" }, { code: "jamaica", name: "Jamaica" },
    { code: "jordan", name: "Jordan" }, { code: "kuwait", name: "Kuwait" }, { code: "lebanon", name: "Lebanon" },
    { code: "libya", name: "Libya" }, { code: "lithuania", name: "Lithuania" }, { code: "luxembourg", name: "Luxembourg" },
    { code: "macedonia", name: "North Macedonia" }, { code: "malta", name: "Malta" }, { code: "moldova", name: "Moldova" },
    { code: "mongolia", name: "Mongolia" }, { code: "mozambique", name: "Mozambique" }, { code: "nepal", name: "Nepal" },
    { code: "oman", name: "Oman" }, { code: "panama", name: "Panama" }, { code: "paraguay", name: "Paraguay" },
    { code: "qatar", name: "Qatar" }, { code: "romania", name: "Romania" }, { code: "serbia", name: "Serbia" },
    { code: "slovakia", name: "Slovakia" }, { code: "slovenia", name: "Slovenia" }, { code: "srilanka", name: "Sri Lanka" },
    { code: "sudan", name: "Sudan" }, { code: "syria", name: "Syria" }, { code: "taiwan", name: "Taiwan" },
    { code: "tanzania", name: "Tanzania" }, { code: "tunisia", name: "Tunisia" }, { code: "uganda", name: "Uganda" },
    { code: "uzbekistan", name: "Uzbekistan" }, { code: "yemen", name: "Yemen" }, { code: "zambia", name: "Zambia" },
    { code: "zimbabwe", name: "Zimbabwe" },
    // A placeholder to ensure a wide variety is covered
  ];
  
  const services = [
    { code: "whatsapp", name: "WhatsApp" }, { code: "telegram", name: "Telegram" }, { code: "google", name: "Google / Gmail" },
    { code: "facebook", name: "Facebook" }, { code: "instagram", name: "Instagram" }, { code: "tiktok", name: "TikTok" },
    { code: "twitter", name: "X (Twitter)" }, { code: "linkedin", name: "LinkedIn" }, { code: "netflix", name: "Netflix" },
    { code: "uber", name: "Uber" }, { code: "amazon", name: "Amazon" }, { code: "discord", name: "Discord" },
    { code: "viber", name: "Viber" }, { code: "wechat", name: "WeChat" }, { code: "snapchat", name: "Snapchat" },
    { code: "openai", name: "OpenAI / ChatGPT" }, { code: "microsoft", name: "Microsoft" }, { code: "yahoo", name: "Yahoo" },
    { code: "airbnb", name: "Airbnb" }, { code: "bolt", name: "Bolt" }, { code: "steam", name: "Steam" },
    { code: "alibaba", name: "Alibaba" }, { code: "icq", name: "ICQ" }, { code: "momo", name: "Momo" },
    { code: "qq", name: "QQ" }, { code: "tinder", name: "Tinder" }, { code: "paypal", name: "PayPal" },
    { code: "hulu", name: "Hulu" }, { code: "skype", name: "Skype" }, { code: "line", name: "LINE" },
    { code: "weibo", name: "Weibo" }, { code: "kakaotalk", name: "KakaoTalk" }, { code: "vk", name: "VK" },
    { code: "ok", name: "Odnoklassniki" }, { code: "mailru", name: "Mail.ru" }, { code: "yandex", name: "Yandex" },
    { code: "avito", name: "Avito" }, { code: "magnit", name: "Magnit" }, { code: "sbermarket", name: "SberMarket" },
    { code: "didi", name: "DiDi" }, { code: "aliexpress", name: "AliExpress" }, { code: "wildberries", name: "Wildberries" },
    { code: "ozon", name: "Ozon" }, { code: "craigslist", name: "Craigslist" }, { code: "gittigidiyor", name: "GittiGidiyor" },
    { code: "coinbase", name: "Coinbase" }, { code: "binance", name: "Binance" }, { code: "paxful", name: "Paxful" },
    { code: "bet365", name: "Bet365" }, { code: "betfair", name: "Betfair" }, { code: "paddy", name: "PaddyPower" },
    { code: "blizzard", name: "Blizzard" }, { code: "pubg", name: "PUBG" }, { code: "fortnite", name: "Fortnite" },
    { code: "shopee", name: "Shopee" }, { code: "lazada", name: "Lazada" }, { code: "grab", name: "Grab" },
    { code: "trueid", name: "TrueID" }, { code: "myspace", name: "MySpace" }, { code: "path", name: "Path" },
    { code: "tango", name: "Tango" }, { code: "xhamster", name: "XHamster" }, { code: "manychat", name: "ManyChat" },
    { code: "niconico", name: "Niconico" }, { code: "okcupid", name: "OkCupid" }, { code: "pinduoduo", name: "Pinduoduo" },
    { code: "probit", name: "Probit" }, { code: "quora", name: "Quora" }, { code: "roku", name: "Roku" },
    { code: "tenge", name: "Tenge" }, { code: "toss", name: "Toss" }, { code: "weibo-intl", name: "Weibo International" },
    { code: "zalando", name: "Zalando" }, { code: "zalo", name: "Zalo" }, { code: "zoosk", name: "Zoosk" },
    { code: "vinted", name: "Vinted" }, { code: "mercari", name: "Mercari" }, { code: "shopify", name: "Shopify" },
    { code: "heymandi", name: "HeyMandi" }, { code: "alipay", name: "Alipay" }, { code: "bankofamerica", name: "Bank of America" },
    { code: "chase", name: "Chase Bank" }, { code: "wellsfargo", name: "Wells Fargo" }, { code: "capitalone", name: "Capital One" },
    // Placeholder to reach 100+ services (in reality, API mapping is needed)
    { code: "misc_a", name: "Miscellaneous App A" }, { code: "misc_b", name: "Miscellaneous App B" }, 
    { code: "misc_c", name: "Miscellaneous App C" }, { code: "misc_d", name: "Miscellaneous App D" }, 
    { code: "misc_e", name: "Miscellaneous App E" }, { code: "misc_f", name: "Miscellaneous App F" }, 
    { code: "misc_g", name: "Miscellaneous App G" }, { code: "misc_h", name: "Miscellaneous App H" }, 
    { code: "misc_i", name: "Miscellaneous App I" }, { code: "misc_j", name: "Miscellaneous App J" }, 
    { code: "misc_k", name: "Miscellaneous App K" }, { code: "misc_l", name: "Miscellaneous App L" },
    { code: "misc_m", name: "Miscellaneous App M" }, { code: "misc_n", name: "Miscellaneous App N" }, 
    { code: "misc_o", name: "Miscellaneous App O" }, { code: "misc_p", name: "Miscellaneous App P" },
  ];
  // =======================================================
  
  // Helper to format name: uses displayName, or email prefix
  const formatUserName = (user) => {
      const name = user.displayName;
      if (name && name.trim().length > 0) return name;
      return user.email ? user.email.split('@')[0] : 'User';
  }

  // --- Dropdown Population ---
  function populateDropdowns() {
    // Sort and Populate Countries
    countries.sort((a, b) => a.name.localeCompare(b.name));
    const countrySel = document.getElementById('buy-country');
    countrySel.innerHTML = '<option value="">-- Select Country --</option>';
    countries.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.code; opt.text = c.name;
      countrySel.appendChild(opt);
    });

    // Sort and Populate Services
    services.sort((a, b) => a.name.localeCompare(b.name));
    const serviceSel = document.getElementById('buy-service');
    serviceSel.innerHTML = '<option value="">-- Select Service --</option>';
    services.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.code; opt.text = s.name;
      serviceSel.appendChild(opt);
    });
  }
  
  // --- Mobile Menu Toggle Logic ---
  menuToggle.addEventListener('click', () => {
    sidebar.classList.toggle('open');
  });
  // Close menu when a link is clicked (mobile UX)
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', () => {
        // Only trigger on small screens
        if (window.matchMedia("(max-width: 920px)").matches) {
            sidebar.classList.remove('open');
        }
    });
  });

  // --- CRITICAL: THE FIREBASE GUARD ---
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      appLoader.style.display = 'none'; 
      mainContent.style.display = 'flex'; 

      const formattedName = formatUserName(user);
      document.getElementById('side-user').textContent = formattedName;
      document.getElementById('greeting').textContent = `Welcome, ${formattedName}`;
      document.getElementById('pay-email-hidden').value = user.email;

      // Initial Setup
      populateDropdowns();

      // Balance Listener
      onSnapshot(doc(db, "users", user.uid), (docSnap) => {
        if(docSnap.exists()) document.getElementById('balance').textContent = '₦' + (docSnap.data().balance || 0).toLocaleString(undefined, {minimumFractionDigits:2});
      });

      // Load Transactions
      loadTransactions(user.uid);

    } else {
      window.location.href = 'login.html';
    }
  });

  // Logout (Redirect to index.html)
  document.getElementById('btn-logout').addEventListener('click', (e) => {
    e.preventDefault(); // Prevent default link action
    signOut(auth).then(() => window.location.href = 'index.html');
  });

  // Modal Handlers
  const amModal = document.getElementById('add-money-modal');
  const bModal = document.getElementById('buy-modal');
  
  const openAmModal = () => amModal.classList.add('open');
  const closeAmModal = () => amModal.classList.remove('open');
  const openBModal = () => bModal.classList.add('open');
  const closeBModal = () => bModal.classList.remove('open');

  document.getElementById('open-add-money').addEventListener('click', openAmModal);
  document.getElementById('open-add-money-sidebar').addEventListener('click', (e) => { e.preventDefault(); openAmModal(); }); // Sidebar link
  document.getElementById('close-add-money').addEventListener('click', closeAmModal);
  document.getElementById('open-buy-modal').addEventListener('click', openBModal);
  document.getElementById('close-buy').addEventListener('click', closeBModal);

  // Paystack Logic
  document.getElementById('deposit-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const amount = document.getElementById('pay-amount').value;
    const email = document.getElementById('pay-email-hidden').value;
    const btn = document.getElementById('start-paystack');

    if(amount < 50) return alert("Minimum ₦50");
    btn.textContent = "Processing...";
    btn.disabled = true;

    const handler = PaystackPop.setup({
      key: PAYSTACK_KEY, email: email, amount: amount * 100, currency: 'NGN',
      ref: 'SL-'+Math.floor(Math.random()*1000000000),
      callback: (res) => processDeposit(amount, res.reference),
      onClose: () => { btn.disabled = false; btn.textContent = "Pay Now to Sublime Logs"; }
    });
    handler.openIframe();
  });

  async function processDeposit(amount, ref) {
    amModal.classList.remove('open');
    document.getElementById('start-paystack').disabled = false;
    document.getElementById('start-paystack').textContent = "Pay Now to Sublime Logs";
    try {
        const userRef = doc(db, "users", currentUser.uid);
        await addDoc(collection(db, "users", currentUser.uid, "transactions"), {
            type: 'deposit', amount: Number(amount), date: new Date().toISOString(), reference: ref
        });
        await runTransaction(db, async (t) => {
            const sfDoc = await t.get(userRef);
            const newBal = (sfDoc.data()?.balance || 0) + Number(amount);
            t.update(userRef, { balance: newBal });
        });
        alert("Wallet Funded!");
    } catch(e) { console.error(e); alert("Error updating balance. Ref: " + ref); }
  }

  // Transaction History Logic (Retained)
  async function loadTransactions(uid) {
    const list = document.getElementById('tx-list');
    const q = query(collection(db, "users", uid, "transactions"), orderBy("date", "desc"), limit(5));
    // Use onSnapshot for real-time updates on the dashboard (better UX)
    onSnapshot(q, (snap) => {
        list.innerHTML = '';
        if(snap.empty) { list.innerHTML = '<div class="tx-item"><div class="small">No transactions</div></div>'; return; }
        snap.forEach(d => {
            const data = d.data();
            const isDep = data.type === 'deposit';
            const formattedAmount = Number(data.amount).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            list.innerHTML += `
            <div class="tx-item">
                <div><div style="font-weight:700">${isDep?'+':'-'} ₦${formattedAmount}</div><div class="small">${new Date(data.date).toLocaleDateString()}</div></div>
                <div style="font-weight:700;color:${isDep?'var(--accent)':'var(--danger)'}">${data.type.toUpperCase()}</div>
            </div>`;
        });
    }, (error) => {
        console.error("Error loading transactions:", error);
        list.innerHTML = '<div class="tx-item"><div class="small" style="color:var(--danger)">Error loading history.</div></div>';
    });
  }

  // Placeholder Buy Logic (The actual Buy logic using the API is complex and needs to be fetched/implemented separately)
  document.getElementById('confirm-buy').addEventListener('click', () => {
      const country = document.getElementById('buy-country').value;
      const service = document.getElementById('buy-service').value;

      if (!country || !service) {
          alert("Please select both a Country and a Service.");
          return;
      }

      // **IMPORTANT**: The actual API call to check price, confirm availability,
      // and perform the transaction (similar to the old script's check-avail/buy logic)
      // would go here. This is a simple placeholder.
      alert(`Attempting to buy ${service} number in ${country}. (API integration required for real purchase)`);
      closeBModal();
  });
  
  // Placeholder Price Update on Select Change
  document.getElementById('buy-country').addEventListener('change', updatePriceDisplay);
  document.getElementById('buy-service').addEventListener('change', updatePriceDisplay);

  function updatePriceDisplay() {
      const country = document.getElementById('buy-country').value;
      const service = document.getElementById('buy-service').value;
      const priceDisplay = document.getElementById('price-display');

      if (country && service) {
          // Placeholder Price Logic (e.g., fetch from API, or use a simple heuristic)
          const basePrice = 50 + (countries.findIndex(c => c.code === country) % 10) * 10; // Simple placeholder
          priceDisplay.innerHTML = `Estimated Price: <span style="color:var(--accent)">₦${basePrice.toLocaleString()}</span>`;
      } else {
          priceDisplay.innerHTML = 'Price: ...';
      }
  }

</script>
</body>
</html>
