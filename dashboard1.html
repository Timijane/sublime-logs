<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard — Sublime Logs</title>
<style>
  :root{
    --bg:#0b0f13; --card:#0f1720; --muted:#98a0a8;
    --accent:#6ee7b7; --accent-2:#7c5cff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial;background:radial-gradient(1200px 600px at 10% 10%, rgba(124,92,255,0.06), transparent 5%),linear-gradient(180deg,#020408 0%, #061018 100%);color:#e6eef6;min-height:100vh;display:flex;}
  .sidebar{width:260px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-right:1px solid rgba(255,255,255,0.03);padding:28px 20px;display:flex;flex-direction:column;gap:18px}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent-2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:700;color:#051018;font-size:18px}
  nav{display:flex;flex-direction:column;gap:10px;margin-top:6px}
  .nav-link{display:flex;gap:12px;align-items:center;padding:10px 12px;border-radius:10px;color:var(--muted);cursor:pointer;text-decoration:none;font-size:14px}
  .nav-link.active, .nav-link:hover{background: linear-gradient(90deg, rgba(124,92,255,0.06), rgba(110,231,183,0.03));color:#e9fef0}
  .main{flex:1;padding:28px;display:flex;flex-direction:column;gap:20px}
  .top-bar{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .card-row{display:flex;gap:18px;align-items:stretch}
  .card{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:20px;flex:1;box-shadow:0 8px 30px rgba(2,6,12,0.6);min-height:110px}
  .big-card{flex:1.4}
  .balance-value{font-size:28px;font-weight:700;color:var(--accent)}
  .small{font-size:13px;color:var(--muted)}
  .actions{display:flex;gap:12px}
  .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#051018;font-weight:700}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);box-shadow:none}
  .buy-button{display:inline-block;padding:12px 16px;border-radius:12px;background:linear-gradient(90deg,#ff8a65,#ffb74d);color:#051018;font-weight:700;cursor:pointer}
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(2,6,12,0.6);z-index:60}
  .modal.open{display:flex}
  .modal-card{width:640px;max-width:95%;background:#071018;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .form-row{display:flex;gap:8px;margin-top:12px}
  input, select{padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:#e6eef6;outline:none}
  .tx-list{margin-top:12px;max-height:320px;overflow:auto;background:var(--card);padding:12px;border-radius:10px}
  .tx-item{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .tx-item:last-child{border-bottom:none}
  @media(max-width:920px){.sidebar{display:none}.card-row{flex-direction:column}}
</style>
</head>
<body>

<aside class="sidebar">
  <div style="display:flex;align-items:center;gap:12px">
    <div class="logo">SL</div>
    <div>
      <h1 style="margin:0;font-size:16px">Sublime Logs</h1>
      <p style="margin:0;font-size:12px;color:var(--muted)">Wallet & Numbers</p>
    </div>
  </div>

  <nav>
    <a href="dashboard1.html" class="nav-link active">Dashboard</a>
    <a href="wallet.html" class="nav-link">Wallet</a>
    <a href="transactions.html" class="nav-link">Transactions</a>
    <a href="profile.html" class="nav-link">Profile</a>
    <a href="#" class="nav-link" id="btn-logout">Logout</a>
  </nav>

  <div style="margin-top:auto;font-size:12px;color:var(--muted)">
    Signed in as:
    <div id="side-user" style="margin-top:8px;font-weight:600"></div>
  </div>
</aside>

<main class="main">
  <div class="top-bar">
    <div>
      <h2 id="greeting">Welcome</h2>
      <p class="small" id="subg">Your dashboard</p>
    </div>
    <div class="actions">
      <button class="btn" id="open-wallet">Open Wallet</button>
      <button class="btn secondary" id="open-add-money">Fund Wallet</button>
    </div>
  </div>

  <div class="card-row">
    <div class="card">
      <div class="small">Available Balance</div>
      <div style="height:8px"></div>
      <div class="balance-value" id="balance">₦0.00</div>
      <div class="small" style="margin-top:8px">Live balance (updates automatically)</div>
    </div>

    <div class="card big-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small">Buy Number</div>
          <div style="height:6px"></div>
          <div style="font-weight:700;font-size:18px">Purchase a temporary virtual number</div>
          <div class="small" style="margin-top:6px">Available services: WhatsApp, Google, Telegram, Facebook, etc.</div>
        </div>
        <div>
          <div class="buy-button" id="open-buy-modal">Buy Number</div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="tx-list" id="buy-history">
        <div class="tx-item"><div class="small">Your recent purchases will appear here</div></div>
      </div>
    </div>
  </div>

  <section>
    <h3 style="margin:0 0 8px 0">Recent activity</h3>
    <div class="tx-list" id="tx-list">
      <div class="tx-item"><div class="small">Loading…</div></div>
    </div>
  </section>
</main>

<!-- Add Money modal (Paystack) -->
<div class="modal" id="add-money-modal">
  <div class="modal-card">
    <h3 style="margin:0 0 8px 0">Fund wallet</h3>
    <div class="small">Enter amount to pay via Paystack</div>
    <div class="form-row">
      <input type="number" id="pay-amount" placeholder="Amount (e.g. 1000)" min="50" />
      <button class="btn" id="start-paystack">Pay</button>
    </div>
    <div style="height:8px"></div>
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button class="btn secondary" id="close-add-money">Close</button>
    </div>
  </div>
</div>

<!-- Buy Number modal -->
<div class="modal" id="buy-modal">
  <div class="modal-card">
    <h3 style="margin:0 0 8px 0">Buy virtual number</h3>
    <div class="small">Pick product (service), country and operator. Price will be fetched from 5SIM.</div>

    <div style="height:10px"></div>
    <div class="form-row">
      <select id="buy-product">
        <option value="whatsapp">WhatsApp</option>
        <option value="google">Google/YouTube</option>
        <option value="telegram">Telegram</option>
        <option value="facebook">Facebook</option>
        <option value="amazon">Amazon</option>
      </select>

      <input id="buy-country" placeholder="Country (e.g. england or any)" />
      <input id="buy-operator" placeholder="Operator (e.g. any)" value="any" />
    </div>

    <div style="height:10px"></div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn" id="check-price">Check Price</button>
      <div class="small" id="price-display">Price: —</div>
    </div>

    <div style="height:12px"></div>

    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button class="btn secondary" id="close-buy">Close</button>
      <button class="btn" id="confirm-buy" disabled>Buy Number</button>
    </div>

    <div style="height:12px"></div>
    <div class="small">Order result / OTP will appear below:</div>
    <pre id="buy-result" style="background:#021218;padding:10px;border-radius:8px;height:120px;overflow:auto;color:#cdf7e6"></pre>
  </div>
</div>

<script type="module">
  // ---- CONFIG ----
  // Paystack public key you gave:
  const PAYSTACK_PUBLIC_KEY = 'pk_live_20505aa86cec6458bf2cc8cd926ecc06b87ff492';

  // 5SIM placeholder token: replace with your real 5sim token.
  // IMPORTANT: For production, move 5SIM requests to a secure server.
  const FIVESIM_TOKEN = 'YOUR_5SIM_API_TOKEN_HERE';

  // ---- IMPORTS ----
  import { auth, db, logout, getRecentTransactions, updateUserBalance } from './js/firebase.js';
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { doc, onSnapshot, runTransaction, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  // ---- UI REFS ----
  const openBuyBtn = document.getElementById('open-buy-modal');
  const buyModal = document.getElementById('buy-modal');
  const closeBuy = document.getElementById('close-buy');
  const checkPriceBtn = document.getElementById('check-price');
  const buyProduct = document.getElementById('buy-product');
  const buyCountry = document.getElementById('buy-country');
  const buyOperator = document.getElementById('buy-operator');
  const priceDisplay = document.getElementById('price-display');
  const confirmBuyBtn = document.getElementById('confirm-buy');
  const buyResult = document.getElementById('buy-result');

  const addMoneyModal = document.getElementById('add-money-modal');
  const openAddMoney = document.getElementById('open-add-money');
  const closeAddMoney = document.getElementById('close-add-money');
  const startPay = document.getElementById('start-paystack');
  const payAmountInput = document.getElementById('pay-amount');

  const txList = document.getElementById('tx-list');
  const buyHistory = document.getElementById('buy-history');

  const sideUser = document.getElementById('side-user');
  const balanceEl = document.getElementById('balance');
  const greetingEl = document.getElementById('greeting');
  const btnLogout = document.getElementById('btn-logout');
  const openWalletBtn = document.getElementById('open-wallet');

  // local
  let currentUser = null;
  let lastBalance = 0;
  let lastPrice = null;
  let lastPriceMeta = null;

  // auth & live balance
  onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = 'login.html'; return; }
    currentUser = user;
    sideUser.textContent = user.displayName || user.email || 'User';
    greetingEl.textContent = `Welcome back, ${ (user.displayName||user.email).split(' ')[0] }`;

    const userRef = doc(db, 'users', user.uid);
    onSnapshot(userRef, (snap) => {
      if (!snap.exists()) { balanceEl.textContent = '₦0.00'; lastBalance = 0; return; }
      const data = snap.data();
      lastBalance = Number(data.balance || 0);
      balanceEl.textContent = formatCurrency(lastBalance);
    });

    // load recent txs
    loadRecentTxs();
    loadBuyHistory();
  });

  // navigation
  openWalletBtn.addEventListener('click', ()=> window.location.href = 'wallet.html');
  btnLogout.addEventListener('click', ()=> logout());

  // Add money modal handlers
  openAddMoney.addEventListener('click', ()=> addMoneyModal.classList.add('open'));
  closeAddMoney.addEventListener('click', ()=> addMoneyModal.classList.remove('open'));
  document.getElementById('close-add-money').addEventListener('click', ()=> addMoneyModal.classList.remove('open'));

  startPay.addEventListener('click', async () => {
    const amt = Number(payAmountInput.value);
    if (!amt || amt < 50) return alert('Enter an amount >= 50');
    if (!currentUser) return alert('You must be signed in');

    // initialize Paystack
    const handler = window.PaystackPop && window.PaystackPop.setup ? window.PaystackPop.setup({
      key: PAYSTACK_PUBLIC_KEY,
      email: currentUser.email || '',
      amount: Math.round(amt * 100), // kobo
      ref: 'SL-'+Math.floor((Math.random()*1000000000)+1),
      onClose: function(){ /* user closed */ },
      callback: async function(response){
        // NOTE: this callback is triggered after payment. For production verify on server with secret key
        try {
          // optimistic: treat callback as success; add funds serverless
          await updateUserBalance(currentUser.uid, amt);
          // record deposit transaction separately as well
          await addDoc(collection(db, 'users', currentUser.uid, 'transactions'), {
            amount: amt,
            type: 'deposit',
            date: new Date().toISOString(),
            reference: response.reference
          });
          alert('Payment successful and wallet updated');
          addMoneyModal.classList.remove('open');
          payAmountInput.value = '';
        } catch (err) {
          console.error(err);
          alert('Payment processed but failed to update wallet: ' + err.message);
        }
      }
    }) : null;

    if (!handler) {
      alert('Paystack script not loaded.');
      return;
    }
    handler.openIframe();
  });

  // load transactions (preview)
  async function loadRecentTxs(){
    txList.innerHTML = '<div class="tx-item"><div class="small">Loading…</div></div>';
    try{
      const items = await getRecentTransactions(currentUser.uid);
      if (!items || items.length===0){ txList.innerHTML = '<div class="tx-item"><div class="small">No activity yet</div></div>'; return; }
      txList.innerHTML='';
      items.forEach(tx=>{
        const div=document.createElement('div'); div.className='tx-item';
        div.innerHTML = `<div>
          <div style="font-weight:700">${tx.type==='credit' || tx.type==='deposit' ? '+' : '-'} ${formatCurrency(Math.abs(Number(tx.amount||0)))}</div>
          <div class="small">${tx.note||tx.type} • ${new Date(tx.date).toLocaleString()}</div>
        </div><div style="font-weight:700;color:${(tx.type==='credit' || tx.type==='deposit')?'var(--accent)':'#ff8a8a'}">${tx.type}</div>`;
        txList.appendChild(div);
      });
    }catch(e){
      txList.innerHTML = '<div class="tx-item"><div class="small">Failed to load</div></div>';
      console.error(e);
    }
  }

  // BUY flow
  openBuyBtn.addEventListener('click', ()=> buyModal.classList.add('open'));
  closeBuy.addEventListener('click', ()=> buyModal.classList.remove('open'));

  // Check price handler -> call 5SIM prices endpoint
  checkPriceBtn.addEventListener('click', async () => {
    const product = buyProduct.value;
    const country = (buyCountry.value || 'any').trim() || 'any';
    const operator = (buyOperator.value || 'any').trim() || 'any';
    priceDisplay.textContent = 'Price: checking...';

    try {
      // 5SIM price/purchase endpoint: documented at https://5sim.net/docs
      // We'll call "buy/activation" with operator 'any' to get price and reserve a number (it returns a JSON with price and id).
      const url = `https://5sim.net/v1/user/check/${country}/${product}`; // this endpoint returns price lists; alternative is /prices
      // But to get cost quickly we can call the "buy/activation" with operator 'any' but that will attempt to reserve.
      // To avoid immediate reservation on check, we'll call the price endpoint:
      const pricesUrl = `https://5sim.net/v1/guest/prices/${country}/${product}`;
      // NOTE: different 5SIM tokens / endpoints exist. For reliable result you may call buy endpoint directly.
      const resp = await fetch(pricesUrl, {
        headers: {
          'Accept': 'application/json',
          'Authorization': 'Bearer ' + FIVESIM_TOKEN
        }
      });
      if (!resp.ok) throw new Error('Price lookup failed: '+resp.status);
      const data = await resp.json();
      // data is expected to be an array; pick cheapest available if any
      if (!Array.isArray(data) || data.length===0) {
        priceDisplay.textContent = 'Price: not available';
        lastPrice = null; lastPriceMeta = null;
        confirmBuyBtn.disabled = true;
        return;
      }
      // pick first item (most available)
      const item = data[0];
      // different docs vary — item may have cost/price/count/operator
      const price = item.price ?? item.cost ?? item[0]?.price ?? null;
      const operatorName = item.operator ?? item[0]?.operator ?? operator;
      if (price == null) {
        priceDisplay.textContent = 'Price: unknown';
        lastPrice = null;
        confirmBuyBtn.disabled = true;
        return;
      }
      lastPrice = Number(price);
      lastPriceMeta = { product, country, operator: operatorName, raw: item };
      priceDisplay.textContent = `Price: ${formatCurrency(lastPrice)} • operator:${operatorName}`;
      confirmBuyBtn.disabled = false;
    } catch (err) {
      console.error(err);
      priceDisplay.textContent = 'Price: failed';
      confirmBuyBtn.disabled = true;
      lastPrice = null;
    }
  });

  // Confirm buy: create order with 5SIM, then deduct balance via Firestore transaction and save order
  confirmBuyBtn.addEventListener('click', async () => {
    if (!currentUser) return alert('Sign in required');
    if (!lastPrice) return alert('Check price first');

    buyResult.textContent = 'Attempting to purchase number...';
    confirmBuyBtn.disabled = true;

    try {
      // 1) CALL 5SIM BUY endpoint to reserve number
      const product = lastPriceMeta.product;
      const country = lastPriceMeta.country || 'any';
      const operator = lastPriceMeta.operator || 'any';
      const buyUrl = `https://5sim.net/v1/user/buy/activation/${country}/${operator}/${product}`;

      const resp = await fetch(buyUrl, {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
          'Authorization': 'Bearer ' + FIVESIM_TOKEN
        }
      });
      if (!resp.ok) {
        const text = await resp.text();
        throw new Error('5SIM buy failed: ' + resp.status + ' ' + text);
      }
      const order = await resp.json();
      // order example contains id, phone, price, status
      buyResult.textContent = 'Order created: ' + JSON.stringify(order, null, 2);

      const orderPrice = Number(order.price || lastPrice);
      // 2) Deduct wallet using a Firestore transaction (atomic)
      await runTransactionFromClient(currentUser.uid, orderPrice, order);

      // 3) start polling for OTP (check endpoint)
      pollForSms(order.id);

      // refresh lists
      await loadRecentTxs();
      await loadBuyHistory();
    } catch (err) {
      console.error(err);
      buyResult.textContent = 'Purchase failed: ' + err.message;
      confirmBuyBtn.disabled = false;
      return;
    }
  });

  // Run Firestore transaction: verify funds and deduct + record purchase
  async function runTransactionFromClient(uid, amount, order) {
    const userRef = doc(db, 'users', uid);
    try {
      await runTransaction(db, async (tx) => {
        const uSnap = await tx.get(userRef);
        if (!uSnap.exists()) throw new Error('User not found');
        const curBal = Number(uSnap.data().balance || 0);
        if (curBal < amount) throw new Error('Insufficient funds. Please fund wallet.');
        tx.update(userRef, { balance: curBal - amount });

        // record transaction
        const txRef = collection(userRef, 'transactions');
        const newTxRef = doc(txRef);
        tx.set(newTxRef, {
          amount: -amount,
          type: 'purchase',
          date: new Date().toISOString(),
          note: `5SIM order ${order.id} (${order.product || lastPriceMeta.product})`
        });

        // save order in user's purchases subcollection
        const purchasesRef = collection(userRef, 'purchases');
        const pRef = doc(purchasesRef);
        tx.set(pRef, {
          orderId: order.id,
          phone: order.phone || null,
          price: order.price || amount,
          product: order.product || lastPriceMeta.product,
          country: order.country || lastPriceMeta.country,
          status: order.status || 'PENDING',
          createdAt: new Date().toISOString(),
          raw: order
        });
      });
    } catch (err) {
      // If transaction failed, attempt to cancel order on 5SIM? (requires another API call and backend)
      throw err;
    }
  }

  // Poll 5SIM for SMS using /check/{order_id}
  async function pollForSms(orderId) {
    buyResult.textContent += '\n\nPolling for SMS...';
    const checkUrl = `https://5sim.net/v1/user/check/${orderId}`;
    // Poll until sms is available or timeout
    const start = Date.now();
    const timeout = 5 * 60 * 1000; // 5 minutes
    while (Date.now() - start < timeout) {
      try {
        const r = await fetch(checkUrl, {
          headers: { 'Accept': 'application/json', 'Authorization': 'Bearer ' + FIVESIM_TOKEN }
        });
        if (!r.ok) {
          // if 404 or pending, continue
          await sleep(4000);
          continue;
        }
        const data = await r.json();
        // data.sms could be filled once the SMS arrives
        if (data && (data.sms || data.code)) {
          buyResult.textContent += '\n\nSMS received:\n' + JSON.stringify(data.sms || data, null, 2);
          // update purchase document status to completed
          await markPurchaseComplete(orderId, data);
          return;
        }
      } catch (e) {
        console.error(e);
      }
      await sleep(4000);
    }
    buyResult.textContent += '\n\nNo SMS within timeout. You can check your orders in purchases.';
  }

  // mark purchase complete in Firestore
  async function markPurchaseComplete(orderId, data) {
    // find purchase doc for this orderId
    const purchasesCol = collection(doc(db, 'users', currentUser.uid), 'purchases');
    // Querying subcollection for orderId requires getDocs; for brevity iterate and update matching doc.
    const q = await (await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js")).query;
    // Simple approach: fetch all purchases and update matching id (small scale).
    const { getDocs, where, query: qfn } = await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js");
    const qry = qfn(purchasesCol);
    const snaps = await getDocs(qry);
    snaps.forEach(async (d) => {
      const info = d.data();
      if (String(info.orderId) === String(orderId)) {
        await d.ref.update({ status: 'COMPLETED', sms: data });
      }
    });
  }

  // small helpers
  function formatCurrency(num){ return '₦' + Number(num).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  // load buy history (user purchases subcollection)
  async function loadBuyHistory(){
    try{
      const purchasesRef = collection(doc(db, 'users', currentUser.uid), 'purchases');
      const { getDocs } = await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js");
      const snaps = await getDocs(purchasesRef);
      buyHistory.innerHTML = '';
      if (snaps.empty) buyHistory.innerHTML = '<div class="tx-item"><div class="small">No purchases yet</div></div>';
      snaps.forEach(d=>{
        const p = d.data();
        const div = document.createElement('div'); div.className='tx-item';
        div.innerHTML = `<div>
          <div style="font-weight:700">${p.phone || '-'} • ${p.product || ''}</div>
          <div class="small">${p.status || ''} • ${new Date(p.createdAt).toLocaleString()}</div>
        </div><div style="font-weight:700">${formatCurrency(p.price||0)}</div>`;
        buyHistory.appendChild(div);
      });
    }catch(e){ console.error(e); }
  }

  // initial: load recent txs periodically
  async function loadRecentTxs(){
    try{
      const items = await getRecentTransactions(currentUser.uid);
      txList.innerHTML = '';
      if (!items || items.length===0) txList.innerHTML = '<div class="tx-item"><div class="small">No activity yet</div></div>';
      else items.forEach(tx=>{
        const div=document.createElement('div'); div.className='tx-item';
        div.innerHTML = `<div><div style="font-weight:700">${tx.type==='credit' || tx.type==='deposit' ? '+' : '-'} ${formatCurrency(Math.abs(Number(tx.amount||0)))}</div><div class="small">${tx.note||tx.type} • ${new Date(tx.date).toLocaleString()}</div></div><div style="font-weight:700;color:${(tx.type==='credit' || tx.type==='deposit')?'var(--accent)':'#ff8a8a'}">${tx.type}</div>`;
        txList.appendChild(div);
      });
    } catch(e){ console.error(e); }
  }

  // load buy history on open
  buyModal.addEventListener('transitionend', ()=> loadBuyHistory());

  // Add Paystack script dynamically
  (function addPaystack(){
    const s = document.createElement('script');
    s.src = 'https://js.paystack.co/v1/inline.js';
    s.defer = true;
    document.head.appendChild(s);
  })();

</script>
</body>
</html>
