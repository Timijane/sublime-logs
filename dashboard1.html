<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Dashboard — Sublime Logs</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
  :root{ --bg:#0b0f13; --card:#161b22; --input-bg:#0d1117; --muted:#8b949e; --text:#c9d1d9; --accent:#2ea043; --accent-hover:#3fb950; --border:rgba(240,246,252,0.1); --danger:#f85149; --warning:#d29922; --header-height: 60px; }
  
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden;}
  
  .app-container { display: flex; min-height: 100vh; }
  
  /* Mobile Header */
  .mobile-header {
      display: none; position: fixed; top: 0; left: 0; right: 0; height: var(--header-height);
      background: var(--card); border-bottom: 1px solid var(--border); z-index: 1000;
      align-items: center; justify-content: space-between; padding: 0 20px;
  }
  .hamburger { font-size: 24px; cursor: pointer; color: var(--text); background: none; border: none; }
  
  /* Sidebar */
  .sidebar{
      width:250px; background:var(--card); border-right:1px solid var(--border);
      padding:20px; display:flex; flex-direction:column; gap:10px;
      position:fixed; height:100%; top:0; left:0; z-index: 999;
      transition: transform 0.3s ease;
  }
  
  .main{ margin-left:250px; flex:1; padding:30px; max-width:100%; width: 100%; padding-top: 30px;}

  /* Dashboard Specific Cards */
  .card{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:20px;margin-bottom:20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);}
  
  h2{margin:0 0 5px 0; color:#fff;}
  .sub-text{color:var(--muted); font-size:14px; margin-bottom:25px;}

  .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
  
  .balance-large { font-size: 32px; font-weight: 700; color: var(--accent); margin: 10px 0; }
  
  .btn{background:var(--accent);color:#fff;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;transition:0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none;}
  .btn:hover{background:var(--accent-hover);}
  .btn.secondary{background:rgba(255,255,255,0.05);border:1px solid var(--border);color:var(--text);}

  .nav-link { display: flex; align-items: center; gap: 10px; padding: 12px; color: var(--text); text-decoration: none; border-radius: 6px; transition: 0.2s; }
  .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.05); color: #fff; }
  .nav-link i { width: 20px; text-align: center; color: var(--muted); }
  
  /* Activity List */
  .tx-list{max-height:400px;overflow:auto;}
  .tx-item{display:flex;justify-content:space-between;padding:15px 0;border-bottom:1px solid var(--border);}
  .tx-item:last-child{border-bottom:none;}

  /* Modal */
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.8);z-index:2000}
  .modal.open{display:flex}
  .modal-card{width:350px;max-width:90%;background:var(--card);padding:24px;border-radius:12px;border:1px solid var(--border);}
  input{width:100%;padding:12px;background:var(--input-bg);border:1px solid var(--border);border-radius:6px;color:#fff;outline:none; margin-bottom: 15px;}

  /* Responsive */
  @media(max-width:800px){ 
      .mobile-header { display: flex; }
      .sidebar{ transform: translateX(-100%); width: 260px; box-shadow: 2px 0 10px rgba(0,0,0,0.5); padding-top: 80px;}
      .sidebar.open { transform: translateX(0); }
      .main{ margin-left:0; padding: 15px; padding-top: 80px; }
  }
</style>
</head>
<body>

<div class="mobile-header">
    <div style="font-weight:bold;font-size:18px;">Sublime Logs</div>
    <button class="hamburger" id="menu-toggle"><i class="fas fa-bars"></i></button>
</div>

<div class="modal" id="add-money-modal">
  <div class="modal-card">
    <h3 style="margin-bottom:15px"><i class="fas fa-wallet"></i> Fund Wallet</h3>
    <p style="font-size:13px;color:var(--muted);margin-bottom:15px;">Enter amount to fund your wallet.</p>
    <form id="deposit-form">
      <input type="number" id="pay-amount" placeholder="Amount (e.g. 1000)" min="50" required />
      <input type="email" id="pay-email-hidden" style="display:none;" />
      <div style="display:flex;justify-content:flex-end;gap:10px">
        <button type="button" class="btn secondary" id="close-add-money">Cancel</button>
        <button type="submit" class="btn" id="start-paystack">Pay Now</button>
      </div>
    </form>
  </div>
</div>

<div class="app-container">

    <aside class="sidebar" id="sidebar">
        <div style="font-weight:bold;font-size:20px;margin-bottom:30px;padding-left:10px;" class="desktop-only-logo">
            Sublime Logs
        </div>
        
        <a href="#" class="nav-link active" onclick="closeMenu()">
            <i class="fas fa-home"></i> Dashboard
        </a>
        <a href="wallet.html" class="nav-link">
            <i class="fas fa-shopping-cart"></i> Buy Number
        </a>
        <a href="#" class="nav-link" id="nav-fund">
            <i class="fas fa-wallet"></i> Fund Account
        </a>
        
        <div style="margin-top:auto; border-top: 1px solid var(--border); padding-top: 15px;">
            <div style="font-size:11px;color:var(--muted); margin-bottom: 10px; padding-left: 10px;">
                LOGGED IN AS:<br><span id="user-email" style="color:var(--text);font-size:13px;">...</span>
            </div>
            <button id="logout" class="btn secondary btn-full">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </aside>

    <main class="main">
      
      <div>
        <h2 id="greeting">Welcome Back</h2>
        <div class="sub-text">Here is an overview of your account.</div>
      </div>

      <div class="dashboard-grid">
          <div class="card">
              <div class="label">Available Balance</div>
              <div class="balance-large" id="balance">...</div>
              <div style="margin-top:15px; display:flex; gap:10px;">
                  <button class="btn" id="btn-fund-card">Fund Wallet</button>
                  <a href="wallet.html" class="btn secondary">History</a>
              </div>
          </div>

          <div class="card" style="background: linear-gradient(135deg, rgba(46,160,67,0.1), rgba(46,160,67,0.05)); border-color: rgba(46,160,67,0.2);">
              <div style="display:flex; justify-content:space-between; align-items:center; height:100%">
                  <div>
                      <h3>Buy Number</h3>
                      <div class="label" style="margin-top:5px; color:#fff; opacity:0.7">Instant SMS Verification</div>
                      <a href="wallet.html" class="btn" style="margin-top:15px; background:#fff; color:#0b0f13;">Purchase Now &rarr;</a>
                  </div>
                  <i class="fas fa-sim-card" style="font-size:60px; color:var(--accent); opacity:0.3;"></i>
              </div>
          </div>
      </div>

      <h3>Recent Activity</h3>
      <div class="card" style="margin-top:15px; padding:0 20px;">
          <div class="tx-list" id="tx-list">
              <div style="padding:20px;text-align:center;color:var(--muted)">Loading...</div>
          </div>
      </div>

    </main>
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>

<script type="module">
  const PAYSTACK_KEY = 'pk_live_20505aa86cec6458bf2cc8cd926ecc06b87ff492';

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, collection, addDoc, query, orderBy, limit, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDRnNoRJ4Zgtu-KEZAdOAKtou2LV9rdL5c",
    authDomain: "sublime-log.firebaseapp.com",
    projectId: "sublime-log",
    storageBucket: "sublime-log.firebasestorage.app",
    messagingSenderId: "644554254089",
    appId: "1:644554254089:web:dd3374c9468046a5a015d8"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;

  // --- MENU LOGIC ---
  const menuToggle = document.getElementById('menu-toggle');
  const sidebar = document.getElementById('sidebar');
  const amModal = document.getElementById('add-money-modal');

  menuToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
  window.closeMenu = () => sidebar.classList.remove('open');
  document.addEventListener('click', (e) => {
      if(!sidebar.contains(e.target) && !menuToggle.contains(e.target) && sidebar.classList.contains('open')) sidebar.classList.remove('open');
  });

  // --- MODAL LOGIC ---
  const openModal = () => { amModal.classList.add('open'); closeMenu(); };
  document.getElementById('nav-fund').addEventListener('click', openModal);
  document.getElementById('btn-fund-card').addEventListener('click', openModal);
  document.getElementById('close-add-money').addEventListener('click', () => amModal.classList.remove('open'));

  // --- AUTH & DATA ---
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('user-email').textContent = user.email;
      document.getElementById('pay-email-hidden').value = user.email;
      document.getElementById('greeting').textContent = `Welcome, ${user.displayName || 'User'}`;

      onSnapshot(doc(db, "users", user.uid), (docSnap) => {
         const bal = docSnap.exists() ? docSnap.data().balance : 0;
         document.getElementById('balance').textContent = '₦' + (bal || 0).toLocaleString();
      });

      loadTransactions(user.uid);
    } else {
      window.location.href = 'index.html';
    }
  });

  document.getElementById('logout').addEventListener('click', () => {
      signOut(auth).then(() => window.location.href = 'index.html');
  });

  // --- PAYSTACK ---
  document.getElementById('deposit-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const amount = document.getElementById('pay-amount').value;
    const email = document.getElementById('pay-email-hidden').value;
    const btn = document.getElementById('start-paystack');

    if(amount < 50) return alert("Minimum ₦50");
    btn.textContent = "Processing..."; btn.disabled = true;

    const handler = PaystackPop.setup({
      key: PAYSTACK_KEY, email: email, amount: amount * 100, currency: 'NGN',
      ref: 'SL-'+Math.floor(Math.random()*1000000000),
      callback: (res) => processDeposit(amount, res.reference),
      onClose: () => { btn.disabled = false; btn.textContent = "Pay Now"; }
    });
    handler.openIframe();
  });

  async function processDeposit(amount, ref) {
    amModal.classList.remove('open');
    document.getElementById('start-paystack').disabled = false;
    document.getElementById('start-paystack').textContent = "Pay Now";
    try {
        const userRef = doc(db, "users", currentUser.uid);
        await addDoc(collection(db, "users", currentUser.uid, "transactions"), {
            type: 'deposit', amount: Number(amount), date: new Date().toISOString(), reference: ref
        });
        await runTransaction(db, async (t) => {
            const sfDoc = await t.get(userRef);
            t.update(userRef, { balance: (sfDoc.data().balance || 0) + Number(amount) });
        });
        alert("Wallet Funded Successfully!");
    } catch(e) { console.error(e); alert("Error updating balance. Ref: " + ref); }
  }

  // --- TRANSACTIONS ---
  async function loadTransactions(uid) {
    const list = document.getElementById('tx-list');
    const q = query(collection(db, "users", uid, "transactions"), orderBy("date", "desc"), limit(10));
    const snap = await getDocs(q);
    list.innerHTML = '';
    if(snap.empty) { list.innerHTML = '<div style="padding:15px;color:var(--muted)">No transactions yet.</div>'; return; }
    
    snap.forEach(d => {
        const data = d.data();
        const isDep = data.type === 'deposit';
        const formattedAmount = Number(data.amount).toLocaleString(undefined, {minimumFractionDigits: 2});
        list.innerHTML += `
        <div class="tx-item">
            <div>
                <div style="font-weight:600; font-size:14px; color:#fff;">${isDep ? 'Wallet Deposit' : 'Purchase'}</div>
                <div style="font-size:11px; color:var(--muted)">${new Date(data.date).toLocaleDateString()}</div>
            </div>
            <div style="text-align:right">
                <div style="font-weight:700; color:${isDep ? 'var(--accent)' : '#fff'}">${isDep?'+':'-'} ₦${formattedAmount}</div>
                <div class="badge ${isDep ? 'status-finished' : 'status-pending'}">${data.type.toUpperCase()}</div>
            </div>
        </div>`;
    });
  }
</script>
</body>
          </html>
