<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard — Sublime Logs</title>
<style>
  :root{
    --bg:#0b0f13; --card:#0f1720; --muted:#98a0a8;
    --accent:#6ee7b7; --accent-2:#7c5cff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial;background:radial-gradient(1200px 600px at 10% 10%, rgba(124,92,255,0.06), transparent 5%),linear-gradient(180deg,#020408 0%, #061018 100%);color:#e6eef6;min-height:100vh;display:flex;}
  
  /* Sidebar */
  .sidebar{width:260px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-right:1px solid rgba(255,255,255,0.03);padding:28px 20px;display:flex;flex-direction:column;gap:18px}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent-2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:700;color:#051018;font-size:18px}
  nav{display:flex;flex-direction:column;gap:10px;margin-top:6px}
  .nav-link{display:flex;gap:12px;align-items:center;padding:10px 12px;border-radius:10px;color:var(--muted);cursor:pointer;text-decoration:none;font-size:14px}
  .nav-link.active, .nav-link:hover{background: linear-gradient(90deg, rgba(124,92,255,0.06), rgba(110,231,183,0.03));color:#e9fef0}
  
  /* Main Layout */
  .main{flex:1;padding:28px;display:flex;flex-direction:column;gap:20px}
  .top-bar{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .card-row{display:flex;gap:18px;align-items:stretch}
  .card{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:20px;flex:1;box-shadow:0 8px 30px rgba(2,6,12,0.6);min-height:110px}
  .big-card{flex:1.4}
  .balance-value{font-size:28px;font-weight:700;color:var(--accent)}
  .small{font-size:13px;color:var(--muted)}
  
  /* Buttons */
  .actions{display:flex;gap:12px}
  .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#051018;font-weight:700; font-size:14px;}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);box-shadow:none}
  .btn:disabled {opacity: 0.7; cursor: not-allowed;}
  .buy-button{display:inline-block;padding:12px 16px;border-radius:12px;background:linear-gradient(90deg,#ff8a65,#ffb74d);color:#051018;font-weight:700;cursor:pointer}
  
  /* Modals */
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(2,6,12,0.8);z-index:999; backdrop-filter: blur(4px);}
  .modal.open{display:flex}
  .modal-card{width:640px;max-width:95%;background:#0f1720;padding:24px;border-radius:16px;border:1px solid rgba(255,255,255,0.05); box-shadow: 0 20px 40px rgba(0,0,0,0.5);}
  .form-row{display:flex;gap:8px;margin-top:12px}
  input, select{padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);background:rgba(0,0,0,0.2);color:#e6eef6;outline:none; width:100%; font-family: inherit;}
  input:focus{border-color: var(--accent); background: rgba(0,0,0,0.4);}
  
  /* Transactions */
  .tx-list{margin-top:12px;max-height:320px;overflow:auto;background:var(--card);padding:12px;border-radius:10px}
  .tx-item{display:flex;justify-content:space-between;padding:12px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .tx-item:last-child{border-bottom:none}
  
  @media(max-width:920px){.sidebar{display:none}.card-row{flex-direction:column}}
</style>
</head>
<body>

<aside class="sidebar">
  <div style="display:flex;align-items:center;gap:12px">
    <div class="logo">SL</div>
    <div>
      <h1 style="margin:0;font-size:16px">Sublime Logs</h1>
      <p style="margin:0;font-size:12px;color:var(--muted)">Wallet & Numbers</p>
    </div>
  </div>
  <nav>
    <a href="dashboard1.html" class="nav-link active">Dashboard</a>
    <a href="wallet.html" class="nav-link">Wallet</a>
    <a href="transactions.html" class="nav-link">Transactions</a>
    <a href="profile.html" class="nav-link">Profile</a>
    <a href="#" class="nav-link" id="btn-logout">Logout</a>
  </nav>
  <div style="margin-top:auto;font-size:12px;color:var(--muted)">
    Signed in as:
    <div id="side-user" style="margin-top:8px;font-weight:600">Loading...</div>
  </div>
</aside>

<main class="main">
  <div class="top-bar">
    <div>
      <h2 id="greeting" style="margin:0; font-size:24px;">Welcome</h2>
      <p class="small" id="subg" style="margin-top:4px;">Your financial overview</p>
    </div>
    <div class="actions">
      <button class="btn" id="open-wallet">Open Wallet</button>
      <button class="btn secondary" id="open-add-money">Fund Wallet</button>
    </div>
  </div>

  <div class="card-row">
    <div class="card">
      <div class="small">Available Balance</div>
      <div style="height:8px"></div>
      <div class="balance-value" id="balance">₦0.00</div>
    </div>
    
    <div class="card big-card">
      <div style="display:flex;justify-content:space-between;align-items:center; height:100%">
        <div>
          <div class="small">Buy Number</div>
          <div style="height:6px"></div>
          <div style="font-weight:700;font-size:18px">Purchase a temporary number</div>
          <div class="small" style="margin-top:6px">WhatsApp, Google, Telegram, Facebook, etc.</div>
        </div>
        <div>
          <div class="buy-button" id="open-buy-modal">Buy Number</div>
        </div>
      </div>
    </div>
  </div>

  <section>
    <h3 style="margin:20px 0 8px 0">Recent activity</h3>
    <div class="tx-list" id="tx-list">
      <div class="tx-item"><div class="small">Loading…</div></div>
    </div>
  </section>
</main>

<div class="modal" id="add-money-modal">
  <div class="modal-card" style="width:400px">
    <h3 style="margin:0 0 8px 0">Fund Wallet</h3>
    <div class="small">Enter amount to deposit via Paystack</div>
    
    <div class="form-row">
      <input type="number" id="pay-amount" placeholder="Amount (e.g. 1000)" min="100" />
    </div>
    
    <div style="height:20px"></div>
    
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button class="btn secondary" id="close-add-money">Cancel</button>
      <button class="btn" id="start-paystack">Pay Now</button>
    </div>
  </div>
</div>

<div class="modal" id="buy-modal">
  <div class="modal-card">
    <h3 style="margin:0 0 8px 0">Buy Virtual Number</h3>
    <div class="form-row">
      <select id="buy-product">
        <option value="whatsapp">WhatsApp</option>
        <option value="google">Google</option>
        <option value="telegram">Telegram</option>
      </select>
      <input id="buy-country" placeholder="Country (e.g. nigeria)" />
    </div>
    <div style="height:15px"></div>
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button class="btn secondary" id="close-buy">Close</button>
      <button class="btn" id="confirm-buy">Check Price & Buy</button>
    </div>
    <div class="small" style="margin-top:10px" id="buy-status"></div>
  </div>
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>

<script type="module">
  // --- CONFIGURATION ---
  // Replace this with your actual Paystack Public Key
  const PAYSTACK_PUBLIC_KEY = 'pk_live_20505aa86cec6458bf2cc8cd926ecc06b87ff492';
  
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, collection, addDoc, query, orderBy, limit, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDVu5IQ3Y5bvgAfSKym8kXPpZZWKqMELTM",
    authDomain: "sublime-logs.firebaseapp.com",
    projectId: "sublime-logs",
    storageBucket: "sublime-logs.firebasestorage.app",
    messagingSenderId: "381847722551",
    appId: "1:381847722551:web:8ec68f018291d3927f3db2",
    measurementId: "G-8YHHJC1MP7"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- UI ELEMENTS ---
  const balanceEl = document.getElementById('balance');
  const sideUser = document.getElementById('side-user');
  const greeting = document.getElementById('greeting');
  const txList = document.getElementById('tx-list');
  
  // Navigation Buttons
  const openWalletBtn = document.getElementById('open-wallet');
  const openAddMoneyBtn = document.getElementById('open-add-money');
  
  // Payment Modal Elements
  const addMoneyModal = document.getElementById('add-money-modal');
  const closeAddMoneyBtn = document.getElementById('close-add-money');
  const startPayBtn = document.getElementById('start-paystack');
  const payAmountInput = document.getElementById('pay-amount');
  
  // Buy Modal Elements
  const openBuyBtn = document.getElementById('open-buy-modal');
  const buyModal = document.getElementById('buy-modal');
  const closeBuyBtn = document.getElementById('close-buy');
  
  let currentUser = null;

  // ---------------------------------------------
  // 1. AUTHENTICATION & DATA LOADING
  // ---------------------------------------------
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = 'login.html';
      return;
    }
    currentUser = user;

    // --- FIX FOR NAME DISPLAY ---
    // We listen to the database for the name. 
    // If "name" exists in DB, use it. If not, use Email.
    onSnapshot(doc(db, "users", user.uid), (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        
        // 1. Balance
        const bal = data.balance || 0;
        balanceEl.textContent = formatCurrency(bal);

        // 2. Name Logic
        // Checks: Database Name -> Auth Display Name -> Email
        let displayName = data.name; 
        if(!displayName) displayName = user.displayName;
        if(!displayName) displayName = user.email.split('@')[0];

        // Update UI
        sideUser.textContent = displayName;
        greeting.textContent = `Welcome, ${displayName}`;
      } else {
        // Fallback for new users with no DB record yet
        balanceEl.textContent = '₦0.00';
        sideUser.textContent = user.email.split('@')[0];
        greeting.textContent = `Welcome, ${user.email.split('@')[0]}`;
      }
    });

    // Load Transactions
    loadTransactions(user.uid);
  });

  // ---------------------------------------------
  // 2. NAVIGATION & MODALS
  // ---------------------------------------------
  
  // "Open Wallet" -> Goes to wallet.html
  openWalletBtn.addEventListener('click', () => {
    window.location.href = 'wallet.html';
  });

  // "Fund Wallet" -> Opens the Custom Modal
  openAddMoneyBtn.addEventListener('click', () => {
    addMoneyModal.classList.add('open');
  });
  closeAddMoneyBtn.addEventListener('click', () => {
    addMoneyModal.classList.remove('open');
  });

  // "Buy Number" Modal
  openBuyBtn.addEventListener('click', () => {
    buyModal.classList.add('open');
  });
  closeBuyBtn.addEventListener('click', () => {
    buyModal.classList.remove('open');
  });

  // Logout
  document.getElementById('btn-logout').addEventListener('click', () => {
    signOut(auth).then(() => window.location.href = 'login.html');
  });

  // ---------------------------------------------
  // 3. PAYMENT LOGIC (PAYSTACK)
  // ---------------------------------------------
  startPayBtn.addEventListener('click', () => {
    const amount = Number(payAmountInput.value);
    
    // Validation
    if (!amount || amount < 100) {
      alert("Minimum deposit is ₦100");
      return;
    }

    // UX: Change button text
    const originalText = startPayBtn.textContent;
    startPayBtn.textContent = "Processing...";
    startPayBtn.disabled = true;

    // Call Paystack
    const handler = PaystackPop.setup({
      key: PAYSTACK_PUBLIC_KEY,
      email: currentUser.email,
      amount: amount * 100, // Paystack expects Kobo
      currency: 'NGN',
      ref: 'SL-' + Math.floor((Math.random() * 1000000000) + 1), // Unique Reference
      
      // On Success
      callback: function(response) {
        startPayBtn.textContent = "Verifying...";
        processDeposit(amount, response.reference);
      },
      
      // On Close
      onClose: function() {
        startPayBtn.textContent = originalText;
        startPayBtn.disabled = false;
      }
    });
    
    handler.openIframe();
  });

  async function processDeposit(amount, ref) {
    try {
      const userRef = doc(db, "users", currentUser.uid);
      
      // A. Create Transaction Record
      await addDoc(collection(db, "users", currentUser.uid, "transactions"), {
        type: 'deposit',
        amount: amount,
        date: new Date().toISOString(),
        reference: ref,
        note: 'Wallet Funded'
      });
      
      // B. Update Balance Atomically
      await runTransaction(db, async (transaction) => {
        const sfDoc = await transaction.get(userRef);
        if (!sfDoc.exists()) {
           transaction.set(userRef, { balance: amount, email: currentUser.email });
        } else {
           const newBal = (sfDoc.data().balance || 0) + amount;
           transaction.update(userRef, { balance: newBal });
        }
      });

      // C. Reset UI
      addMoneyModal.classList.remove('open');
      payAmountInput.value = '';
      startPayBtn.textContent = "Pay Now";
      startPayBtn.disabled = false;
      alert("Success! ₦" + amount + " has been added.");

    } catch (e) {
      console.error("Error:", e);
      startPayBtn.textContent = "Pay Now";
      startPayBtn.disabled = false;
      alert("Payment verified, but network error updating balance. Ref: " + ref);
    }
  }

  // ---------------------------------------------
  // 4. LOAD TRANSACTIONS
  // ---------------------------------------------
  async function loadTransactions(uid) {
    txList.innerHTML = '<div class="tx-item"><div class="small">Loading...</div></div>';
    
    // Query: Last 10 items
    const q = query(collection(db, "users", uid, "transactions"), orderBy("date", "desc"), limit(10));
    
    try {
      const querySnapshot = await getDocs(q);
      txList.innerHTML = '';
      
      if(querySnapshot.empty) {
        txList.innerHTML = '<div class="tx-item"><div class="small">No transactions yet</div></div>';
        return;
      }

      querySnapshot.forEach((doc) => {
        const tx = doc.data();
        const isCredit = tx.type === 'deposit' || tx.type === 'credit';
        const amountClean = isNaN(tx.amount) ? 0 : tx.amount;

        const item = document.createElement('div');
        item.className = 'tx-item';
        item.innerHTML = `
          <div>
            <div style="font-weight:700">${isCredit ? '+' : '-'} ${formatCurrency(amountClean)}</div>
            <div class="small">${new Date(tx.date).toLocaleDateString()} • ${tx.note || tx.type}</div>
          </div>
          <div style="font-weight:700; color: ${isCredit ? 'var(--accent)' : '#ff8a8a'}">
            ${(tx.type || 'TX').toUpperCase()}
          </div>
        `;
        txList.appendChild(item);
      });
    } catch (e) {
      console.log(e);
      txList.innerHTML = '<div class="tx-item"><div class="small">No activity found.</div></div>';
    }
  }

  function formatCurrency(val) {
    return '₦' + Number(val).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
  }
</script>
</body>
</html>
