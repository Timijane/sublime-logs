<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sublime Logs - Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Lobster&family=David:wght@400;700&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'David', sans-serif;
    background: #fefefe;
    min-height:100vh;
  }

  header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:15px 20px;
    background: linear-gradient(90deg,#9b59b6,#e91e63);
    color:#fff;
    position:fixed;
    width:100%;
    z-index:200;
  }
  header h1 { font-family:'Lobster',cursive; font-size:1.8em; }
  #menu-btn { font-size:1.5em; cursor:pointer; }
  #back-home { background:#fff; color:#9b59b6; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:bold; text-decoration:none; }

  nav#side-menu {
    position:fixed;
    left:-40%;
    top:0;
    width:40%;
    height:100%;
    background:gold;
    padding:20px;
    transition:0.3s;
    z-index:150;
  }
  nav#side-menu.active { left:0; }
  nav#side-menu ul { list-style:none; margin-top:50px; }
  nav#side-menu ul li { margin:20px 0; font-weight:bold; cursor:pointer; }
  #close-menu { position:absolute; top:10px; right:15px; font-size:1.5em; cursor:pointer; }

  main {
    padding:80px 20px 20px 20px;
    transition:margin-left 0.3s;
    margin-left:0;
  }
  nav#side-menu.active ~ main { margin-left:40%; }

  .profile {
    display:flex;
    align-items:center;
    margin-bottom:20px;
  }
  .avatar {
    width:80px;
    height:80px;
    border-radius:50%;
    background:#ccc url('https://cdn-icons-png.flaticon.com/512/149/149071.png') center/cover no-repeat;
    margin-right:15px;
    cursor:pointer;
  }
  .profile-info h2 { font-size:1.5em; margin-bottom:5px; }
  .profile-info p { color:#555; }

  .balance { font-size:1.2em; margin-bottom:20px; font-weight:bold; }

  button {
    padding:12px 20px;
    background: linear-gradient(90deg,#9b59b6,#e91e63);
    border:none;
    border-radius:8px;
    color:#fff;
    font-weight:bold;
    cursor:pointer;
    margin-right:10px;
  }

  table {
    width:100%;
    border-collapse:collapse;
    margin-top:20px;
  }
  table th, table td {
    border:1px solid #ccc;
    padding:10px;
    text-align:left;
  }
  table th { background:#9b59b6; color:#fff; }
  table tr:nth-child(even) { background:#f2f2f2; }

  @media (max-width:768px){
    nav#side-menu { width:60%; }
    nav#side-menu.active ~ main { margin-left:60%; }
  }
</style>
</head>
<body>

<header>
  <span id="menu-btn">≡</span>
  <h1>Sublime Logs</h1>
  <a href="index.html" id="back-home">Home</a>
</header>

<nav id="side-menu">
  <span id="close-menu">×</span>
  <ul>
    <li id="menu-profile">Profile</li>
    <li id="menu-fund">Fund Account</li>
    <li id="menu-buy">Buy Number</li>
    <li id="menu-send">Send Gift</li>
    <li id="menu-transactions">Transaction History</li>
    <li id="menu-logout">Logout</li>
  </ul>
</nav>

<main>
  <div class="profile">
    <div class="avatar" id="avatar"></div>
    <div class="profile-info">
      <h2 id="user-name">Welcome</h2>
      <p id="user-email"></p>
    </div>
  </div>
  <div class="balance">Balance: ₦<span id="balance">0</span></div>
  <button id="fund-btn">Fund Account</button>
  
  <table id="transactions-table">
    <thead>
      <tr>
        <th>Type</th>
        <th>Amount</th>
        <th>Date</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <!-- Transactions will load dynamically -->
    </tbody>
  </table>
</main>

<script type="module">
  import { auth, db } from './js/firebase.js';
  import { doc, getDoc, setDoc, collection, addDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

  const menuBtn = document.getElementById('menu-btn');
  const closeMenu = document.getElementById('close-menu');
  const sideMenu = document.getElementById('side-menu');
  const userNameEl = document.getElementById('user-name');
  const userEmailEl = document.getElementById('user-email');
  const balanceEl = document.getElementById('balance');
  const avatarEl = document.getElementById('avatar');
  const fundBtn = document.getElementById('fund-btn');
  const transactionsTable = document.getElementById('transactions-table').querySelector('tbody');

  // Hamburger toggle
  menuBtn.addEventListener('click', () => sideMenu.classList.add('active'));
  closeMenu.addEventListener('click', () => sideMenu.classList.remove('active'));

  // Auth state
  onAuthStateChanged(auth, async user => {
    if (!user) { window.location.href = "login.html"; return; }

    const userDocRef = doc(db,'users',user.uid);
    const snap = await getDoc(userDocRef);
    if(!snap.exists()){
      await setDoc(userDocRef,{
        firstName:user.displayName?.split(' ')[0]||'User',
        surname:user.displayName?.split(' ')[1]||'',
        email:user.email,
        balance:0,
        avatar:null
      });
    }

    const data = (await getDoc(userDocRef)).data();
    userNameEl.textContent = `Welcome, ${data.firstName}`;
    userEmailEl.textContent = data.email;
    balanceEl.textContent = data.balance.toLocaleString();

    if(data.avatar) avatarEl.style.backgroundImage = `url(${data.avatar})`;

    // Transactions
    const transCol = collection(db,'users',user.uid,'transactions');
    onSnapshot(transCol,snapshot=>{
      transactionsTable.innerHTML='';
      snapshot.forEach(docSnap=>{
        const t=docSnap.data();
        const row=document.createElement('tr');
        row.innerHTML=`
          <td>${t.type}</td>
          <td>₦${t.amount.toLocaleString()}</td>
          <td>${new Date(t.date.seconds*1000).toLocaleString()}</td>
          <td>${t.status}</td>
        `;
        transactionsTable.appendChild(row);
      });
    });
  });

  // Fund account
  fundBtn.addEventListener('click', async ()=>{
    const user=auth.currentUser;
    if(!user) return;
    const amount=parseFloat(prompt("Enter amount to fund in Naira:"));
    if(!amount || amount<=0) return alert("Invalid amount");

    alert(`Payment of ₦${amount.toLocaleString()} successful!`);

    const userDocRef=doc(db,'users',user.uid);
    const snap=await getDoc(userDocRef);
    const currentBalance = snap.data().balance||0;
    const newBalance=currentBalance+amount;

    await updateDoc(userDocRef,{balance:newBalance});
    await addDoc(collection(db,'users',user.uid,'transactions'),{
      type:'Fund Account',
      amount,
      date:new Date(),
      status:'Successful'
    });

    balanceEl.textContent=newBalance.toLocaleString();
    alert("Thanks for trading with us!");
  });

  // Avatar upload
  avatarEl.addEventListener('click', async ()=>{
    const fileInput=document.createElement('input');
    fileInput.type='file';
    fileInput.accept='image/*';
    fileInput.click();
    fileInput.onchange=async ()=>{
      const file=fileInput.files[0];
      if(!file) return;
const reader = new FileReader();
      reader.onload = async (e) => {
        avatarEl.style.backgroundImage = `url(${e.target.result})`;
        const user = auth.currentUser;
        await updateDoc(doc(db, 'users', user.uid), { avatar: e.target.result });
      };
      reader.readAsDataURL(file);
    };
  });

  // Logout
  document.getElementById('menu-logout').addEventListener('click', async () => {
    await signOut(auth);
    window.location.href = "login.html";
  });
</script>
</body>
</html>
