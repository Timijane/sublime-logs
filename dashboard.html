<!-- Paystack -->
<script src="https://js.paystack.co/v1/inline.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDVu5IQ3Y5bvgAfSKym8kXPpZZWKqMELTM",
  authDomain: "sublime-logs.firebaseapp.com",
  projectId: "sublime-logs",
  storageBucket: "sublime-logs.firebasestorage.app",
  messagingSenderId: "381847722551",
  appId: "1:381847722551:web:8ec68f018291d3927f3db2",
  measurementId: "G-8YHHJC1MP7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Elements
const menuBtn = document.getElementById('menu-btn');
const closeMenu = document.getElementById('close-menu');
const sideMenu = document.getElementById('side-menu');
const userNameEl = document.getElementById('user-name');
const userEmailEl = document.getElementById('user-email');
const balanceEl = document.getElementById('balance');
const fundBtn = document.getElementById('fund-btn');
const transactionsTable = document.getElementById('transactions-table').querySelector('tbody');

// Menu toggle
menuBtn.addEventListener('click', () => sideMenu.classList.add('active'));
closeMenu.addEventListener('click', () => sideMenu.classList.remove('active'));

// Auth listener
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  // Load user data
  const userDocRef = doc(db, 'users', user.uid);
  let snap = await getDoc(userDocRef);
  if (!snap.exists()) {
    await setDoc(userDocRef, {
      firstName: user.displayName?.split(' ')[0] || 'User',
      surname: user.displayName?.split(' ')[1] || '',
      email: user.email,
      balance: 0,
      avatar: null
    });
    snap = await getDoc(userDocRef);
  }

  const data = snap.data();
  userNameEl.textContent = `Welcome, ${data.firstName} ${data.surname}`;
  userEmailEl.textContent = data.email;
  balanceEl.textContent = data.balance.toFixed(2);

  // Live transaction updates
  const transCol = collection(db, 'users', user.uid, 'transactions');
  onSnapshot(transCol, snapshot => {
    transactionsTable.innerHTML = '';
    snapshot.forEach(docSnap => {
      const t = docSnap.data();
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${t.type}</td>
        <td>â‚¦${t.amount.toFixed(2)}</td>
        <td>${new Date(t.date.seconds * 1000).toLocaleString()}</td>
        <td>${t.status}</td>
      `;
      transactionsTable.appendChild(row);
    });
  });

  // Fund Account with Paystack Inline
  fundBtn.addEventListener('click', async () => {
    const amountInput = prompt("Enter amount to fund (NGN):", "1000");
    if (!amountInput || isNaN(amountInput) || amountInput <= 0) return;
    const amountKobo = parseFloat(amountInput) * 100;

    const handler = PaystackPop.setup({
      key: "pk_live_20505aa86cec6458bf2cc8cd926ecc06b87ff492", // âœ… your live public key
      email: user.email,
      amount: amountKobo,
      metadata: {
        userId: user.uid // âœ… links payment to Firestore user
      },
      callback: function(response) {
        alert("âœ… Payment successful! Reference: " + response.reference);

        // ðŸ” Send payment reference to your backend (Pipedream)
        fetch("https://eojegh3ks8gvl0e.m.pipedream.net", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            reference: response.reference,
            userId: user.uid,
            amount: amountKobo
          })
        })
        .then(res => res.json())
        .then(data => console.log("Pipedream response:", data))
        .catch(err => console.error("Error sending to Pipedream:", err));
      },
      onClose: function() {
        alert("Payment window closed.");
      }
    });

    handler.openIframe();
  });
});
</script>
