<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sublime Logs - Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Lobster&family=David:wght@400;700&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'David', sans-serif; background: #fefefe; min-height: 100vh; }
  
  header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 15px 20px; background: linear-gradient(90deg, #9b59b6, #e91e63); color: #fff;
  }
  header h1 { font-family: 'Lobster', cursive; font-size: 1.8em; }
  #menu-btn { font-size: 1.5em; cursor: pointer; }
  #back-home { background: #fff; color: #9b59b6; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; text-decoration: none; }

  #side-menu {
    position: fixed; left: -40%; top: 0; width: 40%; height: 100%;
    background: gold; padding: 20px; transition: 0.3s; z-index: 100;
  }
  #side-menu.active { left: 0; }
  #side-menu ul { list-style: none; margin-top: 50px; }
  #side-menu ul li { margin: 20px 0; font-weight: bold; cursor: pointer; }
  #close-menu { position: absolute; top: 10px; right: 15px; font-size: 1.5em; cursor: pointer; }

  main { padding: 20px; transition: margin-left 0.3s; margin-left: 0; }
  #side-menu.active ~ main { margin-left: 40%; }

  .profile { display: flex; align-items: center; margin-bottom: 20px; }
  .avatar {
    width: 80px; height: 80px; border-radius: 50%; background: #ccc url('https://cdn-icons-png.flaticon.com/512/149/149071.png') center/cover no-repeat;
    margin-right: 15px; cursor: pointer;
  }
  .profile-info h2 { font-size: 1.5em; margin-bottom: 5px; }
  .profile-info p { color: #555; }

  .balance { font-size: 1.2em; margin-bottom: 20px; font-weight: bold; }

  button { padding: 12px 20px; background: linear-gradient(90deg, #9b59b6, #e91e63); border: none; border-radius: 8px; color: #fff; font-weight: bold; cursor: pointer; margin-right: 10px; }

  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  table th, table td { border: 1px solid #ccc; padding: 10px; text-align: left; }
  table th { background: #9b59b6; color: #fff; }
  table tr:nth-child(even) { background: #f2f2f2; }

  @media (max-width: 768px) {
    #side-menu { width: 60%; }
    #side-menu.active ~ main { margin-left: 60%; }
  }
</style>
</head>
<body>

<header>
  <span id="menu-btn">≡</span>
  <h1>Sublime Logs</h1>
  <a href="index.html" id="back-home">Home</a>
</header>

<nav id="side-menu">
  <span id="close-menu">×</span>
  <ul>
    <li id="menu-profile">Profile</li>
    <li id="menu-fund">Fund Account</li>
    <li id="menu-buy">Buy Number</li>
    <li id="menu-send">Send Gift</li>
    <li id="menu-transactions">Transaction History</li>
    <li id="menu-logout">Logout</li>
  </ul>
</nav>

<main>
  <div class="profile">
    <div class="avatar" id="avatar"></div>
    <div class="profile-info">
      <h2 id="user-name">Welcome</h2>
      <p id="user-email"></p>
    </div>
  </div>
  <div class="balance">Balance: ₦<span id="balance">0</span></div>
  <button id="fund-btn">Fund Account</button>

  <table id="transactions-table">
    <thead>
      <tr>
        <th>Type</th>
        <th>Amount</th>
        <th>Date</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<script type="module">
  import { auth, db } from './js/firebase.js';
  import { doc, getDoc, setDoc, collection, addDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

  const menuBtn = document.getElementById('menu-btn');
  const closeMenu = document.getElementById('close-menu');
  const sideMenu = document.getElementById('side-menu');
  const userNameEl = document.getElementById('user-name');
  const userEmailEl = document.getElementById('user-email');
  const balanceEl = document.getElementById('balance');
  const avatarEl = document.getElementById('avatar');
  const fundBtn = document.getElementById('fund-btn');
  const transactionsTable = document.getElementById('transactions-table').querySelector('tbody');

  // Hamburger toggle
  menuBtn.addEventListener('click', () => sideMenu.classList.add('active'));
  closeMenu.addEventListener('click', () => sideMenu.classList.remove('active'));

  // Auth state
  onAuthStateChanged(auth, async user => {
    if (!user) { window.location.href = "login.html"; return; }

    const userDocRef = doc(db, 'users', user.uid);
    const snap = await getDoc(userDocRef);
    if (!snap.exists()) {
      await setDoc(userDocRef, { firstName: user.displayName?.split(' ')[0] || 'User', surname: user.displayName?.split(' ')[1] || '', email: user.email, balance: 0, avatar: null });
    }
    const data = (await getDoc(userDocRef)).data();

    userNameEl.textContent = `Welcome, ${data.firstName}`;
    userEmailEl.textContent = data.email;
    balanceEl.textContent = data.balance.toFixed(2);
    if (data.avatar) avatarEl.style.backgroundImage = `url(${data.avatar})`;

    // Transactions
    const transCol = collection(db, 'users', user.uid, 'transactions');
    onSnapshot(transCol, snapshot => {
      transactionsTable.innerHTML = '';
      snapshot.forEach(docSnap => {
        const t = docSnap.data();
        const row = document.createElement('tr');
        row.innerHTML = `<td>${t.type}</td><td>₦${t.amount.toFixed(2)}</td><td>${new Date(t.date.seconds*1000).toLocaleString()}</td><td>${t.status}</td>`;
        transactionsTable.appendChild(row);
      });
    });
  });

  // Fund Account
  fundBtn.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user) return;

    const amount = parseFloat(prompt("Enter amount to fund (₦):"));
    if (!amount || amount <= 0) return alert("Invalid amount");

    // Open Paystack payment in new tab
    const paystackUrl = `https://paystack.shop/pay/hweuw46d87?amount=${amount*100}&email=${user.email}`;
    window.open(paystackUrl, "_blank");

    // After payment, update Firestore (simulation)
    const userDocRef = doc(db, 'users', user.uid);
    const snap = await getDoc(userDocRef);
    const currentBalance = snap.data().balance || 0;
    const newBalance = currentBalance + amount;

    await updateDoc(userDocRef, { balance: newBalance });
    await addDoc(collection(db, 'users', user.uid, 'transactions'), {
      type: 'Fund Account',
      amount,
      date: new Date(),
      status: 'Successful'
    });

    balanceEl.textContent = newBalance.toFixed(2);
    alert("Thanks for trading with us!");
  });

  // Avatar upload
  avatarEl.addEventListener('click', async () => {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.click();
    fileInput.onchange = async () => {
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (e) => {
        avatarEl.style.backgroundImage = `url(${e.target.result})`;
        const user = auth.currentUser;
        await updateDoc(doc(db, 'users', user.uid), { avatar: e.target.result });
      };
      reader.readAsDataURL(file);
    };
  });

  // Logout
  document.getElementById('menu-logout').addEventListener('click', async () => {
    await signOut(auth);
    window.location.href = "login.html";
  });

  // Menu actions (example: can be extended)
  document.getElementById('menu-profile').addEventListener('click', () => alert("Profile page under construction"));
  document.getElementById('menu-buy').addEventListener('click', () => alert("Buy Number page under construction"));
  document.getElementById('menu-send').addEventListener('click', () => alert("Send Gift page under construction"));
  document.getElementById('menu-transactions').addEventListener('click', () => window.scrollTo({top: transactionsTable.offsetTop, behavior: 'smooth'}));
  document.getElementById('menu-fund').addEventListener('click', () => fundBtn.click());
</script>
<!-- Buy Number Modal -->
<div id="buy-number-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:200;">
  <div style="background:#fff; padding:20px; border-radius:10px; width:90%; max-width:400px; position:relative;">
    <span id="close-buy-number" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:1.5em;">×</span>
    <h2>Buy Number</h2>
    <p>Enter the amount in ₦ and proceed to buy a number:</p>
    <input type="number" id="buy-number-amount" placeholder="Amount in ₦" style="width:100%; padding:10px; margin:10px 0; border-radius:5px; border:1px solid #ccc;">
    <button id="buy-number-btn" style="width:100%; margin-top:10px;">Buy Now</button>
  </div>
</div>

<!-- Send Gift Modal -->
<div id="send-gift-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:200;">
  <div style="background:#fff; padding:20px; border-radius:10px; width:90%; max-width:400px; position:relative;">
    <span id="close-send-gift" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:1.5em;">×</span>
    <h2>Send Gift</h2>
    <p>Enter recipient email and amount in ₦:</p>
    <input type="email" id="gift-email" placeholder="Recipient Email" style="width:100%; padding:10px; margin:10px 0; border-radius:5px; border:1px solid #ccc;">
    <input type="number" id="gift-amount" placeholder="Amount in ₦" style="width:100%; padding:10px; margin:10px 0; border-radius:5px; border:1px solid #ccc;">
    <button id="send-gift-btn" style="width:100%; margin-top:10px;">Send Gift</button>
  </div>
</div>

<script type="module">
  import { auth, db } from './js/firebase.js';
  import { doc, getDoc, setDoc, collection, addDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

  const menuBuy = document.getElementById('menu-buy');
  const menuSend = document.getElementById('menu-send');
  const buyNumberModal = document.getElementById('buy-number-modal');
  const sendGiftModal = document.getElementById('send-gift-modal');
  const closeBuyNumber = document.getElementById('close-buy-number');
  const closeSendGift = document.getElementById('close-send-gift');
  const buyNumberBtn = document.getElementById('buy-number-btn');
  const sendGiftBtn = document.getElementById('send-gift-btn');
  const giftEmailInput = document.getElementById('gift-email');
  const giftAmountInput = document.getElementById('gift-amount');
  const buyNumberAmountInput = document.getElementById('buy-number-amount');
  const balanceEl = document.getElementById('balance');
  
  let currentUserData;

  onAuthStateChanged(auth, async user => {
    if (!user) { window.location.href = "login.html"; return; }

    const userDoc = doc(db, 'users', user.uid);
    const snap = await getDoc(userDoc);
    if (!snap.exists()) {
      await setDoc(userDoc, {
        firstName: user.displayName?.split(' ')[0] || 'User',
        surname: user.displayName?.split(' ')[1] || '',
        email: user.email,
        balance: 0,
        avatar: null
      });
    }
    currentUserData = (await getDoc(userDoc)).data();
    balanceEl.textContent = currentUserData.balance.toFixed(2);
  });

  // Buy Number Modal
  menuBuy.addEventListener('click', () => buyNumberModal.style.display = 'flex');
  closeBuyNumber.addEventListener('click', () => buyNumberModal.style.display = 'none');

  buyNumberBtn.addEventListener('click', async () => {
    const user = auth.currentUser;
    const amount = parseFloat(buyNumberAmountInput.value);
    if (!amount || amount <= 0) return alert("Enter valid amount");
    if (amount > currentUserData.balance) return alert("Insufficient balance");

    // Deduct amount
    const newBalance = currentUserData.balance - amount;
    await updateDoc(doc(db, 'users', user.uid), { balance: newBalance });
    await addDoc(collection(db, 'users', user.uid, 'transactions'), {
      type: 'Buy Number',
      amount,
      date: new Date(),
      status: 'Successful'
    });
    balanceEl.textContent = newBalance.toFixed(2);
    currentUserData.balance = newBalance;
    alert("Thanks for trading with us!");
    buyNumberModal.style.display = 'none';
  });

  // Send Gift Modal
  menuSend.addEventListener('click', () => sendGiftModal.style.display = 'flex');
  closeSendGift.addEventListener('click', () => sendGiftModal.style.display = 'none');

  sendGiftBtn.addEventListener('click', async () => {
    const user = auth.currentUser;
    const recipientEmail = giftEmailInput.value.trim();
    const amount = parseFloat(giftAmountInput.value);
    if (!recipientEmail || !amount || amount <= 0) return alert("Enter valid email and amount");
    if (amount > currentUserData.balance) return alert("Insufficient balance");

    // Deduct amount from sender
    const newBalance = currentUserData.balance - amount;
    await updateDoc(doc(db, 'users', user.uid), { balance: newBalance });
    await addDoc(collection(db, 'users', user.uid, 'transactions'), {
      type: 'Send Gift',
      amount,
      date: new Date(),
      status: 'Successful',
      recipient: recipientEmail
    });

    // Credit amount to recipient (if exists)
    const usersCol = collection(db, 'users');
    const recipientSnap = await getDoc(doc(db, 'users', recipientEmail));
    if (recipientSnap.exists()) {
      const recipientData = recipientSnap.data();
      const recipientNewBalance = (recipientData.balance || 0) + amount;
      await updateDoc(doc(db, 'users', recipientSnap.id), { balance: recipientNewBalance });
      await addDoc(collection(db, 'users', recipientSnap.id, 'transactions'), {
        type: 'Received Gift',
        amount,
        date: new Date(),
        status: 'Successful',
        sender: user.email
      });
    }

    balanceEl.textContent = newBalance.toFixed(2);
    currentUserData.balance = newBalance;
    alert("Gift sent successfully! Thanks for trading with us!");
    sendGiftModal.style.display = 'none';
  });
</script>
</body>
</html>
