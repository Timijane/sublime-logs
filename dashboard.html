<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sublime Logs - Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Lobster&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<script src="https://js.paystack.co/v1/inline.js"></script>
<style>
/* ===== Global ===== */
* {margin:0;padding:0;box-sizing:border-box;}
body {font-family:Roboto,sans-serif; background:#fefefe; min-height:100vh;}

/* ===== Navigation ===== */
nav{position:fixed;top:0;left:0;width:100%; display:flex;justify-content:space-between;align-items:center; background:linear-gradient(90deg,#008751,#FFD700); padding:12px 22px; z-index:1200; box-shadow:0 2px 0 rgba(0,0,0,0.06);}
.nav-left{display:flex;align-items:center;gap:12px;}
.nav-left img{width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.15);}
.brand-text{color:#fff;font-weight:900;font-size:1.2rem;white-space:nowrap;text-shadow:0 2px 4px rgba(0,0,0,0.4);}
.nav-right{display:flex;align-items:center; list-style:none; gap:18px;}
.nav-right li{color:#fff;font-weight:700; cursor:pointer;}
.hamburger{display:none; flex-direction:column; gap:4px; cursor:pointer;}
.hamburger span{width:26px;height:3px;background:#fff;border-radius:2px;}
.close-btn{display:none;}

/* Responsive Menu */
@media(max-width:820px){
  .nav-right{
    position:fixed;top:0;right:-40%;
    width:40%;height:100%;
    background:linear-gradient(180deg,#008751,#FFD700);
    flex-direction:column; padding:60px 20px 20px; gap:22px;
    transition:right .3s ease;
  }
  .nav-right.show{right:0;}
  .close-btn{display:block; position:absolute; top:16px; right:18px; font-size:28px; font-weight:bold; color:#fff; cursor:pointer;}
  .hamburger{display:flex;}
}

/* ===== Main ===== */
main{margin-top:80px; padding:20px; transition:margin-left .3s;}
.profile{display:flex;align-items:center;margin-bottom:20px;}
.avatar{width:80px;height:80px;border-radius:50%;background:#ccc url('https://cdn-icons-png.flaticon.com/512/149/149071.png') center/cover no-repeat;margin-right:15px;cursor:pointer;}
.profile-info h2{font-size:1.5em;margin-bottom:5px;}
.profile-info p{color:#555;}
.balance{font-size:1.2em;margin-bottom:20px;font-weight:bold;}
button{padding:12px 20px; background:linear-gradient(90deg,#008751,#FFD700); border:none; border-radius:8px; color:#fff; font-weight:bold; cursor:pointer; margin-bottom:20px;}
table{width:100%; border-collapse:collapse; margin-top:20px;}
table th, table td{border:1px solid #ccc; padding:10px; text-align:left;}
table th{background:#008751;color:#fff;}
table tr:nth-child(even){background:#f2f2f2;}

/* Responsive */
@media(max-width:768px){main{padding:15px;}.profile{flex-direction:column;align-items:flex-start;}.avatar{margin-bottom:10px;}}
</style>
</head>
<body>

<!-- NAVIGATION -->
<nav>
  <div class="nav-left">
    <img src="logo11.jpg" alt="Logo">
    <div class="brand-text">Sublime Logs</div>
  </div>
  <div class="hamburger" id="hamburger"><span></span><span></span><span></span></div>
  <ul class="nav-right" id="navRight">
    <span class="close-btn" id="closeBtn">&times;</span>
    <li id="menu-profile">Profile</li>
    <li id="menu-fund">Fund Account</li>
    <li id="menu-buy">Buy Number</li>
    <li id="menu-send">Send Gift</li>
    <li id="menu-transactions">Transaction History</li>
    <li id="menu-logout">Logout</li>
  </ul>
</nav>

<main>
  <div class="profile">
    <div class="avatar" id="avatar"></div>
    <div class="profile-info">
      <h2 id="user-name">Welcome</h2>
      <p id="user-email"></p>
    </div>
  </div>

  <div class="balance">Balance: ₦<span id="balance">0</span></div>
  <button id="fund-btn">Fund Account</button>

  <table id="transactions-table">
    <thead>
      <tr>
        <th>Type</th>
        <th>Amount</th>
        <th>Date</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <!-- Transactions will appear here -->
    </tbody>
  </table>
</main>

<script type="module">
import { auth, db } from './js/firebase.js';
import { doc, getDoc, setDoc, collection, addDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

// Hamburger menu
const navRight = document.getElementById('navRight');
document.getElementById('hamburger').addEventListener('click',()=>navRight.classList.toggle('show'));
document.getElementById('closeBtn').addEventListener('click',()=>navRight.classList.remove('show'));

// Elements
const userNameEl = document.getElementById('user-name');
const userEmailEl = document.getElementById('user-email');
const balanceEl = document.getElementById('balance');
const avatarEl = document.getElementById('avatar');
const fundBtn = document.getElementById('fund-btn');
const transactionsTable = document.getElementById('transactions-table').querySelector('tbody');

// Authentication
onAuthStateChanged(auth, async user => {
  if(!user){ window.location.href="login.html"; return; }

  const userDoc = doc(db,'users',user.uid);
  const snap = await getDoc(userDoc);
  if(!snap.exists()){
    await setDoc(userDoc,{
      firstName:user.displayName?.split(' ')[0]||'User',
      surname:user.displayName?.split(' ')[1]||'',
      email:user.email,
      balance:0,
      avatar:null
    });
  }

  const data = (await getDoc(userDoc)).data();
  userNameEl.textContent = `Welcome, ${data.firstName}`;
  userEmailEl.textContent = data.email;
  balanceEl.textContent = data.balance.toLocaleString();
  if(data.avatar) avatarEl.style.backgroundImage = `url(${data.avatar})`;

  // Transactions
  const transCol = collection(db,'users',user.uid,'transactions');
  onSnapshot(transCol, snapshot=>{
    transactionsTable.innerHTML='';
    snapshot.forEach(docSnap=>{
      const t = docSnap.data();
      const row = document.createElement('tr');
      row.innerHTML=`<td>${t.type}</td><td>₦${t.amount.toLocaleString()}</td><td>${new Date(t.date.seconds*1000).toLocaleString()}</td><td>${t.status}</td>`;
      transactionsTable.appendChild(row);
    });
  });
});

// Fund Account with Paystack
fundBtn.addEventListener('click', async () => {
  const user = auth.currentUser;
  if(!user) return;

  const amount = parseFloat(prompt("Enter amount to fund (₦):"));
  if(!amount || amount<=0) return alert("Invalid amount");

  const amountKobo = amount*100;
  const handler = PaystackPop.setup({
    key: 'YOUR_PUBLIC_PAYSTACK_KEY', // Replace with your key
    email: user.email,
    amount: amountKobo,
    currency: 'NGN',
    ref: 'SUBLIME-'+Math.floor(Math.random()*1000000000+1),
    onClose: ()=>{alert('Payment window closed.')},
    callback: async function(response){
      alert('Payment successful! Ref: '+response.reference);

      const userDoc = doc(db,'users',user.uid);
      const snap = await getDoc(userDoc);
      const newBalance = (snap.data().balance||0)+amount;

      await updateDoc(userDoc,{balance:newBalance});
      await addDoc(collection(db,'users',user.uid,'transactions'),{
        type:'Fund Account',
        amount,
        date:new Date(),
        status:'Successful',
        reference:response.reference
      });

      balanceEl.textContent=newBalance.toLocaleString();
      alert("Thanks for trading with us!");
    }
  });
  handler.openIframe();
});

// Avatar upload
avatarEl.addEventListener('click', async ()=>{
  const fileInput = document.createElement('input');
  fileInput.type='file'; fileInput.accept='image/*'; fileInput.click();
  fileInput.onchange = async ()=>{
    const file = fileInput.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = async (e)=>{
      avatarEl.style.backgroundImage=`url(${e.target.result})`;
      const user = auth.currentUser;
      await updateDoc(doc(db,'users',user.uid),{avatar:e.target.result});
    };
    reader.readAsDataURL(file);
  }
});

// Logout
document.getElementById('menu-logout').addEventListener('click', async ()=>{
  await signOut(auth);
  window.location.href="login.html";
});
</script>
</body>
</html>
