<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sublime Logs - Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Lobster&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<script src="https://js.paystack.co/v1/inline.js"></script>
<style>
body{font-family:Roboto,sans-serif;background:#fefefe;margin:0;padding:0;}
header{background:linear-gradient(90deg,#008751,#FFD700);padding:20px;text-align:center;color:#fff;}
header h1{font-family:'Lobster',cursive;font-size:2rem;margin-bottom:5px;}
header p{font-weight:bold;}
main{padding:20px;}
.profile{display:flex;align-items:center;gap:15px;margin-bottom:20px;}
.avatar{width:80px;height:80px;border-radius:50%;background:#ccc url('https://cdn-icons-png.flaticon.com/512/149/149071.png') center/cover no-repeat;cursor:pointer;}
.profile-info h2{font-size:1.5em;margin-bottom:5px;}
.profile-info p{color:#555;}
.balance{font-size:1.2em;margin-bottom:20px;font-weight:bold;}
.buttons{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:20px;}
.buttons button{flex:1 1 150px;padding:15px;background:linear-gradient(90deg,#008751,#FFD700);border:none;border-radius:8px;color:#fff;font-weight:bold;cursor:pointer;transition:transform .15s;}
.buttons button:hover{transform:translateY(-3px);}
table{width:100%;border-collapse:collapse;margin-top:20px;}
table th, table td{border:1px solid #ccc;padding:10px;text-align:left;}
table th{background:#008751;color:#fff;}
table tr:nth-child(even){background:#f2f2f2;}
@media(max-width:768px){.profile{flex-direction:column;align-items:flex-start;}.avatar{margin-bottom:10px;}.buttons{flex-direction:column;}}
</style>
</head>
<body>

<header>
  <h1>Sublime Logs Dashboard</h1>
  <p>Manage your account easily</p>
</header>

<main>
  <div class="profile">
    <div class="avatar" id="avatar"></div>
    <div class="profile-info">
      <h2 id="user-name">Welcome</h2>
      <p id="user-email"></p>
    </div>
  </div>

  <div class="balance">Balance: ₦<span id="balance">0</span></div>

  <div class="buttons">
    <button id="home-btn">Home</button>
    <button id="fund-btn">Fund Account</button>
    <button id="buy-btn">Buy Number</button>
    <button id="send-btn">Send Gift</button>
    <button id="trans-btn">Transaction History</button>
    <button id="logout-btn">Logout</button>
  </div>

  <table id="transactions-table">
    <thead>
      <tr>
        <th>Type</th>
        <th>Amount</th>
        <th>Date</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <!-- Transactions will appear here -->
    </tbody>
  </table>
</main>

<script type="module">
import { auth, db } from './js/firebase.js';
import { doc, getDoc, setDoc, collection, addDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

const userNameEl=document.getElementById('user-name');
const userEmailEl=document.getElementById('user-email');
const balanceEl=document.getElementById('balance');
const avatarEl=document.getElementById('avatar');
const fundBtn=document.getElementById('fund-btn');
const transactionsTable=document.getElementById('transactions-table').querySelector('tbody');
const logoutBtn=document.getElementById('logout-btn');

// Authentication
onAuthStateChanged(auth, async user => {
  if(!user){ window.location.href="login.html"; return; }

  const userDoc = doc(db,'users',user.uid);
  const snap = await getDoc(userDoc);
  if(!snap.exists()){
    await setDoc(userDoc,{
      firstName:user.displayName?.split(' ')[0]||'User',
      surname:user.displayName?.split(' ')[1]||'',
      email:user.email,
      balance:0,
      avatar:null
    });
  }

  const data = (await getDoc(userDoc)).data();
  userNameEl.textContent = `Welcome, ${data.firstName}`;
  userEmailEl.textContent = data.email;
  balanceEl.textContent = data.balance.toLocaleString();
  if(data.avatar) avatarEl.style.backgroundImage=`url(${data.avatar})`;

  // Transactions
  const transCol = collection(db,'users',user.uid,'transactions');
  onSnapshot(transCol, snapshot=>{
    transactionsTable.innerHTML='';
    snapshot.forEach(docSnap=>{
      const t=docSnap.data();
      const row=document.createElement('tr');
      row.innerHTML=`<td>${t.type}</td><td>₦${t.amount.toLocaleString()}</td><td>${new Date(t.date.seconds*1000).toLocaleString()}</td><td>${t.status}</td>`;
      transactionsTable.appendChild(row);
    });
  });
});

// Fund Account with Paystack
fundBtn.addEventListener('click', async () => {
  const user=auth.currentUser;
  if(!user) return;
  const amount=parseFloat(prompt("Enter amount to fund (₦):"));
  if(!amount || amount<=0) return alert("Invalid amount");
  const amountKobo=amount*100;
  const handler=PaystackPop.setup({
    key: 'YOUR_PUBLIC_PAYSTACK_KEY',
    email:user.email,
    amount:amountKobo,
    currency:'NGN',
    ref:'SUBLIME-'+Math.floor(Math.random()*1000000000+1),
    onClose:()=>{alert('Payment window closed.')},
    callback:async function(response){
      alert('Payment successful! Ref: '+response.reference);
      const userDoc=doc(db,'users',user.uid);
      const snap=await getDoc(userDoc);
      const newBalance=(snap.data().balance||0)+amount;
      await updateDoc(userDoc,{balance:newBalance});
      await addDoc(collection(db,'users',user.uid,'transactions'),{
        type:'Fund Account',
        amount,
        date:new Date(),
        status:'Successful',
        reference:response.reference
      });
      balanceEl.textContent=newBalance.toLocaleString();
      alert("Thanks for trading with us!");
    }
  });
  handler.openIframe();
});

// Avatar upload
avatarEl.addEventListener('click', async ()=>{
  const fileInput=document.createElement('input');
  fileInput.type='file'; fileInput.accept='image/*'; fileInput.click();
  fileInput.onchange=()=>{
    const file=fileInput.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=(e)=>{
      avatarEl.style.backgroundImage=`url(${e.target.result})`;
      const user=auth.currentUser;
      updateDoc(doc(db,'users',user.uid),{avatar:e.target.result});
    };
    reader.readAsDataURL(file);
  }
});

// Logout
logoutBtn.addEventListener('click', async ()=>{
  await signOut(auth);
  window.location.href="login.html";
});

// Other button placeholders
document.getElementById('home-btn').addEventListener('click',()=>alert("Already on Home"));
document.getElementById('buy-btn').addEventListener('click',()=>alert("Buy Number clicked"));
document.getElementById('send-btn').addEventListener('click',()=>alert("Send Gift clicked"));
document.getElementById('trans-btn').addEventListener('click',()=>alert("Transaction History clicked"));

</script>
</body>
</html>
