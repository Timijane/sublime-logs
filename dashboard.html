<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sublime Logs — Dashboard</title>

  <!-- Fonts & minimal styling -->
  <link href="https://fonts.googleapis.com/css2?family=Lobster&family=David:wght@400;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'David',sans-serif;background:#fff;min-height:100vh;color:#222}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:linear-gradient(90deg,#9b59b6,#e91e63);color:#fff}
    header h1{font-family:'Lobster',cursive;font-size:1.6rem}
    #back-home{background:#fff;color:#9b59b6;padding:8px 12px;border-radius:6px;text-decoration:none;font-weight:700}
    main{padding:18px}
    .profile{display:flex;align-items:center;gap:14px;margin-bottom:18px}
    .avatar{width:72px;height:72px;border-radius:50%;background:#ddd center/cover no-repeat}
    .balance{font-weight:700;margin:10px 0;font-size:1.05rem}
    button{background:linear-gradient(90deg,#9b59b6,#e91e63);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{padding:8px;border:1px solid #e6e6e6;text-align:left}
    th{background:#9b59b6;color:#fff}
    .small{font-size:.9rem;color:#555}
    .muted{color:#666;font-size:.9rem}
  </style>
</head>
<body>

<header>
  <h1>Sublime Logs</h1>
  <a id="back-home" href="index.html">Home</a>
</header>

<main>
  <div class="profile">
    <div id="avatar" class="avatar" style="background-image:url('https://cdn-icons-png.flaticon.com/512/149/149071.png')"></div>
    <div>
      <div id="user-name">Welcome</div>
      <div id="user-email" class="muted"></div>
    </div>
  </div>

  <div class="balance">Balance: ₦<span id="balance">0.00</span></div>
  <div style="margin:12px 0">
    <button id="fund-btn">Fund Account</button>
    <button id="refresh-btn" class="small" style="margin-left:10px;padding:8px 10px;background:#eee;color:#333">Refresh</button>
  </div>

  <div class="small">Transaction history</div>
  <table id="transactions-table" aria-live="polite">
    <thead>
      <tr><th>Type</th><th>Amount</th><th>Date</th><th>Status</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<!-- Paystack inline -->
<script src="https://js.paystack.co/v1/inline.js"></script>

<!-- Firebase v11 modules (CDN) -->
<script type="module">
/* ====== CONFIGURE THESE (you already provided them) ====== */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyDVu5IQ3Y5bvgAfSKym8kXPpZZWKqMELTM",
  authDomain: "sublime-logs.firebaseapp.com",
  projectId: "sublime-logs",
  storageBucket: "sublime-logs.firebasestorage.app",
  messagingSenderId: "381847722551",
  appId: "1:381847722551:web:8ec68f018291d3927f3db2",
  measurementId: "G-8YHHJC1MP7"
};

const PAYSTACK_PUBLIC_KEY = "pk_live_20505aa86cec6458bf2cc8cd926ecc06b87ff492";
const PIPEDREAM_ENDPOINT = "https://eojegh3ks8gvl0e.m.pipedream.net"; // your Pipedream webhook verifying endpoint
/* ======================================================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, collection, query, orderBy, limit,
  onSnapshot, getDocs
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

/* Initialize Firebase app */
const app = initializeApp(FIREBASE_CONFIG);
const auth = getAuth(app);
const db = getFirestore(app);

/* UI elements */
const userNameEl = document.getElementById("user-name");
const userEmailEl = document.getElementById("user-email");
const balanceEl = document.getElementById("balance");
const fundBtn = document.getElementById("fund-btn");
const refreshBtn = document.getElementById("refresh-btn");
const transactionsTableBody = document.querySelector("#transactions-table tbody");

/* Helper: format NGN amounts nicely */
function formatNgn(n) {
  if (n === undefined || n === null) return "0.00";
  return Number(n).toFixed(2);
}

/* Helper: show transactions in table */
function renderTransactions(list) {
  transactionsTableBody.innerHTML = "";
  if (!list || list.length === 0) {
    transactionsTableBody.innerHTML = `<tr><td colspan="4" class="muted">No transactions</td></tr>`;
    return;
  }
  list.forEach(t => {
    const date = t.date && t.date.seconds ? new Date(t.date.seconds * 1000).toLocaleString() : (t.date || "");
    const amount = Number(t.amount || 0).toFixed(2);
    const row = document.createElement("tr");
    row.innerHTML = `<td>${t.type || "—"}</td>
                     <td>₦${amount}</td>
                     <td>${date}</td>
                     <td>${t.status || "—"}</td>`;
    transactionsTableBody.appendChild(row);
  });
}

/* Re-fetch the user's Firestore doc and transactions (used after payment verification) */
async function refreshUserData(uid) {
  try {
    const userRef = doc(db, "users", uid);
    const snap = await getDoc(userRef);
    if (!snap.exists()) {
      // Nothing to show
      userNameEl.textContent = "Welcome";
      userEmailEl.textContent = "";
      balanceEl.textContent = formatNgn(0);
      renderTransactions([]);
      return;
    }
    const data = snap.data();
    userNameEl.textContent = `Welcome, ${data.firstName || ""} ${data.surname || ""}`.trim();
    userEmailEl.textContent = data.email || "";
    balanceEl.textContent = formatNgn(data.balance || 0);

    // fetch latest 50 transactions sorted by date if available
    const txCol = collection(db, "users", uid, "transactions");
    const txQuery = query(txCol, orderBy("date", "desc"), limit(50));
    const txSnap = await getDocs(txQuery);
    const txs = [];
    txSnap.forEach(d => txs.push(d.data()));
    renderTransactions(txs);
  } catch (err) {
    console.error("refreshUserData error:", err);
  }
}

/* ---------- Auth state: ensures user is logged in ----------
   We rely on your existing login page. If the user is not logged in
   we redirect them to login.html (you already had this behavior).
   When logged in we ensure a user doc exists (balance defaults to 0).
*/
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  // Ensure user doc exists with balance=0 (id = user.uid)
  const userRef = doc(db, "users", user.uid);
  const snap = await getDoc(userRef);
  if (!snap.exists()) {
    await setDoc(userRef, {
      firstName: user.displayName?.split(" ")[0] || "User",
      surname: user.displayName?.split(" ")[1] || "",
      email: user.email || "",
      balance: 0
    });
  }

  // Show initial user data
  await refreshUserData(user.uid);

  // Start live transactions listener to update table in real-time
  const txCol = collection(db, "users", user.uid, "transactions");
  const txQuery = query(txCol, orderBy("date", "desc"), limit(50));
  onSnapshot(txQuery, (snapshot) => {
    const txs = [];
    snapshot.forEach(d => txs.push(d.data()));
    renderTransactions(txs);
  });
});

/* ---------- Fund button: opens Paystack inline ---------- */
fundBtn.addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user) { alert("Please log in first"); return; }

  // Ask user for amount (simple prompt — you can replace with nicer UI)
  const amountInput = prompt("Enter amount to fund (NGN):", "1000");
  if (!amountInput) return;
  const amountNumber = parseFloat(amountInput);
  if (isNaN(amountNumber) || amountNumber <= 0) { alert("Enter a valid amount"); return; }

  const amountKobo = Math.round(amountNumber * 100); // Paystack expects kobo

  const handler = PaystackPop.setup({
    key: PAYSTACK_PUBLIC_KEY,
    email: user.email,
    amount: amountKobo,
    metadata: { userId: user.uid }, // IMPORTANT: attach userId so backend knows which Firestore doc to update
    callback: async function(response) {
      // Called when Paystack client thinks payment succeeded — we still must verify server-side.
      alert("Payment initiated. Reference: " + response.reference);

      // Send reference to your Pipedream endpoint which will verify with Paystack secret and update Firestore.
      try {
        const res = await fetch(PIPEDREAM_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            reference: response.reference,
            userId: user.uid,
            // we send amount as kobo too — backend can double-check via Paystack verify
            amount: amountKobo
          })
        });

        // Pipedream may return JSON or text depending on your workflow response
        let result;
        try { result = await res.json(); } catch(e) { result = await res.text(); }

        console.log("Pipedream response:", result);

        // After the backend verifies and updates Firestore, refresh the UI
        // (If your Pipedream returns success indicator check it — here we refresh regardless)
        await refreshUserData(user.uid);
        alert("Verification requested — check your wallet balance. If it doesn't update, contact support.");
      } catch (err) {
        console.error("Error calling backend:", err);
        alert("Could not contact verification backend. Contact support.");
      }
    },
    onClose: function() {
      console.log("Payment window closed by user");
    }
  });

  handler.openIframe();
});

/* Manual refresh button */
refreshBtn.addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user) { alert("Please log in first"); return; }
  await refreshUserData(user.uid);
});
</script>
</body>
</html>
