<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sublime Blog - Dashboard</title>
<link rel="stylesheet" href="css/style.css">
<style>
  body { font-family: 'Segoe UI', sans-serif; background: #1b1b2f; color: #fff; margin: 0; }
  header { background: #0f0c29; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 0 10px #00c6ff; }
  header h1 { color: #00c6ff; margin: 0; }
  header button { background: #db4437; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; }
  .container { padding: 2rem; }
  .section { background: rgba(0,0,0,0.75); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 0 10px #00c6ff; }
  .section h2 { color: #00c6ff; margin-bottom: 1rem; }
  .number-card { background: #24243e; padding: 1rem; border-radius: 8px; margin: 0.5rem 0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
  .btn { padding: 0.5rem 1rem; background: #00c6ff; color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
  .btn:hover { background: #009acd; color: #fff; }
  input[type=number]{ padding:0.5rem; border-radius:6px; border:none; margin-right:1rem;}
</style>
</head>
<body>

<header>
  <h1>Dashboard</h1>
  <button id="logoutBtn">Logout</button>
</header>

<div class="container">
  <!-- Welcome Section -->
  <div class="section">
    <h2>Welcome, <span id="userName"></span></h2>
    <p>Your dashboard gives you access to number verification services and OTP requests.</p>
  </div>

  <!-- Wallet Section -->
  <div class="section">
    <h2>Wallet</h2>
    <p>Current Balance: â‚¦<span id="walletBalance">0.00</span></p>
    <input type="number" id="amount" placeholder="Enter amount to load" min="1">
    <button class="btn" id="fundWalletBtn">Load Wallet</button>
    <p>Note: Complete the payment in Paystack page. Wallet will be updated automatically.</p>
  </div>

  <!-- Available Numbers Section -->
  <div class="section">
    <h2>Available Numbers</h2>
    <div id="numberList">
      <!-- Number cards will appear here dynamically -->
    </div>
  </div>
</div>

<script type="module">
import { auth, db } from './js/firebase.js';
import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import { doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

// -------------------- Protect dashboard --------------------
onAuthStateChanged(auth, async user => {
  if(!user) window.location.href = "login.html";
  else {
    document.getElementById('userName').textContent = user.displayName || user.email;

    // Load wallet from Firestore
    const walletRef = doc(db, "wallets", user.uid);
    const walletSnap = await getDoc(walletRef);
    if(walletSnap.exists()){
      walletBalance = walletSnap.data().balance;
      updateBalance();
    } else {
      await setDoc(walletRef, { balance: 0 });
    }
  }
});

// Logout
document.getElementById('logoutBtn').addEventListener('click', () => {
  signOut(auth).then(() => window.location.href = "login.html");
});

// -------------------- Wallet Funding via Paystack --------------------
let walletBalance = 0;
function updateBalance(){
  document.getElementById('walletBalance').textContent = walletBalance.toFixed(2);
}

document.getElementById('fundWalletBtn').addEventListener('click', () => {
  const amount = parseFloat(document.getElementById('amount').value);
  if(!amount || amount <= 0){
    alert("Enter a valid amount");
    return;
  }

  // Redirect to your Paystack shop link
  window.open('https://paystack.shop/pay/hweuw46d87', '_blank');
  alert("Complete the payment in the new tab. Wallet will update automatically via webhook.");
});

// -------------------- SMS Activate Numbers Section --------------------
const API_KEY = "YOUR_SMS_ACTIVATE_API_KEY"; // Replace with your API key
const countries = ["US","UK","NG"];
const services = ["fb","wa","tw"];
const numberList = document.getElementById("numberList");

// Dummy fetch function
async function fetchNumbers(country, service){
  // Replace this with actual SMS Activate API endpoint
  return [
    {id: "1", number: "+1234567890", service: service, price: 100},
    {id: "2", number: "+1234567891", service: service, price: 200}
  ];
}

// Load numbers
async function loadNumbers(){
  numberList.innerHTML = "Loading numbers...";
  for(const country of countries){
    for(const service of services){
      const nums = await fetchNumbers(country, service);
      nums.forEach(num => {
        const card = document.createElement('div');
        card.classList.add('number-card');
        card.innerHTML = `
          <span>ðŸ‡ºðŸ‡¸ ${num.number}</span>
          <span>Site: ${num.service}</span>
          <span>Price: â‚¦${num.price}</span>
          <button class="btn requestOtpBtn" data-id="${num.id}" data-price="${num.price}">Request OTP</button>
        `;
        numberList.appendChild(card);
      });
    }
  }

  // OTP button logic with wallet check
  document.querySelectorAll('.requestOtpBtn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const price = parseFloat(btn.dataset.price);
      if(walletBalance < price){
        alert(`Insufficient balance! Please top-up â‚¦${price - walletBalance} more.`);
        return;
      }
      walletBalance -= price;
      updateBalance();

      // Update wallet in Firestore
      const walletRef = doc(db, "wallets", auth.currentUser.uid);
      await updateDoc(walletRef, { balance: walletBalance });

      alert(`Purchase successful! â‚¦${price} deducted. Requesting OTP...`);
      // Call SMS Activate API to request OTP here
    });
  });
}

loadNumbers();
</script>
</body>
  </html>
