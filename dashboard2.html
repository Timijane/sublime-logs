<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Send Gift â€” Sublime Logs</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
  :root{ --bg:#0b0f13; --card:#161b22; --input-bg:#0d1117; --muted:#8b949e; --text:#c9d1d9; --accent:#2ea043; --accent-hover:#3fb950; --border:rgba(240,246,252,0.1); --danger:#f85149; --warning:#d29922; --header-height: 60px; --purple:#9d4edd; --pink:#f72585; --blue:#4361ee; }
  
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden;}
  
  .app-container { display: flex; min-height: 100vh; }
  
  /* Mobile Header */
  .mobile-header {
      display: none; position: fixed; top: 0; left: 0; right: 0; height: var(--header-height);
      background: var(--card); border-bottom: 1px solid var(--border); z-index: 1000;
      align-items: center; justify-content: space-between; padding: 0 20px;
  }
  .hamburger { font-size: 24px; cursor: pointer; color: var(--text); background: none; border: none; }
  
  /* Sidebar */
  .sidebar{
      width:250px; background:var(--card); border-right:1px solid var(--border);
      padding:20px; display:flex; flex-direction:column; gap:10px;
      position:fixed; height:100%; top:0; left:0; z-index: 999;
      transition: transform 0.3s ease;
  }
  
  .main{ margin-left:250px; flex:1; padding:30px; max-width:100%; width: 100%; padding-top: 30px;}

  /* UI Elements */
  h1,h2,h3,h4{margin:0;color:#fff}
  .label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block;text-transform:uppercase;letter-spacing:0.5px;}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);}
  
  .search-wrapper { position: relative; margin-bottom: 10px; }
  .search-wrapper i { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 12px;}
  .search-input { padding-left: 30px !important; }

  select, input, textarea{width:100%;padding:12px;background:var(--input-bg);border:1px solid var(--border);border-radius:8px;color:#fff;font-size:14px;outline:none;}
  select:focus, input:focus, textarea:focus{border-color:var(--accent);}
  
  /* Button Styles */
  .btn{background:var(--accent);color:#fff;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px;}
  .btn:hover{background:var(--accent-hover);}
  .btn:disabled{opacity:0.5;cursor:not-allowed;background:var(--muted);}
  .btn.secondary{background:rgba(255,255,255,0.05);border:1px solid var(--border);color:var(--text); justify-content: flex-start;}
  .btn.secondary:hover { background: rgba(255,255,255,0.1); }
  .btn-full { width: 100%; }
  .btn-gift { background: linear-gradient(135deg, var(--purple), var(--pink)); }
  .btn-gift:hover { background: linear-gradient(135deg, #8a2be2, #ff1493); }

  .nav-link { display: flex; align-items: center; gap: 10px; padding: 12px; color: var(--text); text-decoration: none; border-radius: 6px; transition: 0.2s; }
  .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.05); color: #fff; }
  .nav-link i { width: 20px; text-align: center; color: var(--muted); }
  
  /* Gift Grid */
  .gift-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 25px;
  }
  
  .gift-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .gift-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      border-color: var(--purple);
  }
  
  .gift-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-bottom: 1px solid var(--border);
  }
  
  .gift-content {
      padding: 20px;
  }
  
  .gift-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #fff;
  }
  
  .gift-price {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 15px;
  }
  
  .gift-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
  }
  
  .delivery-time {
      font-size: 12px;
      color: var(--muted);
      background: rgba(46,160,67,0.1);
      padding: 4px 8px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
  }
  
  /* Announcement Banner */
  .announcement-banner {
      background: linear-gradient(135deg, rgba(157,78,221,0.1), rgba(247,37,133,0.1));
      border: 1px solid rgba(157,78,221,0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 15px;
  }
  
  .announcement-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--purple), var(--pink));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
  }
  
  .announcement-content h4 {
      color: #fff;
      margin-bottom: 5px;
  }
  
  .announcement-content p {
      color: var(--muted);
      font-size: 14px;
      margin: 0;
  }
  
  /* Top Bar */
  .top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px; flex-wrap: wrap; gap: 15px;}
  .balance-card{text-align:right; background: rgba(46,160,67,0.1); padding: 10px 15px; border-radius: 8px; border: 1px solid rgba(46,160,67,0.3);}
  .balance-amount{font-size:20px;font-weight:700;color:var(--accent);}
  
  /* Gift Modal */
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.8);z-index:2000}
  .modal.open{display:flex}
  .modal-card{width:500px; max-width:90%;background:var(--card);padding:24px;border-radius:12px;border:1px solid var(--border); max-height: 85vh; overflow-y: auto;}
  
  .order-summary {
      background: var(--input-bg);
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      border: 1px solid var(--border);
  }
  
  .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
  }
  
  .summary-total {
      border-top: 2px solid var(--border);
      padding-top: 10px;
      margin-top: 10px;
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
  }
  
  /* Form Grid */
  .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
  }
  
  /* Table */
  .table-container{overflow-x:auto; -webkit-overflow-scrolling: touch;}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px; min-width: 600px;} 
  th{text-align:left;padding:12px;border-bottom:1px solid var(--border);color:var(--muted);font-weight:500;}
  td{padding:12px;border-bottom:1px solid var(--border);color:#fff;}
  tr:last-child td{border-bottom:none;}
  
  .badge{padding:3px 8px;border-radius:12px;font-size:10px;font-weight:700;text-transform:uppercase;}
  .status-pending{background:rgba(210,153,34,0.15);color:#e3b341;}
  .status-processing{background:rgba(67,97,238,0.15);color:#4361ee;}
  .status-shipped{background:rgba(157,78,221,0.15);color:#9d4edd;}
  .status-delivered{background:rgba(46,160,67,0.15);color:#3fb950;}
  .status-canceled{background:rgba(248,81,73,0.15);color:#f85149;}
  
  /* Important Notice */
  .important-notice {
      background: linear-gradient(135deg, rgba(46,160,67,0.15), rgba(46,160,67,0.05));
      border: 1px solid rgba(46,160,67,0.3);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      font-size: 13px;
  }
  .notice-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      color: var(--accent);
      font-weight: 600;
  }
  .notice-header i {
      font-size: 16px;
  }
  .notice-content ul {
      margin: 10px 0;
      padding-left: 20px;
  }
  .notice-content li {
      margin-bottom: 8px;
      color: var(--text);
  }
  .notice-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
  }
  .notice-actions .btn {
      flex: 1;
      min-width: 150px;
  }

  /* Stats Cards */
  .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
  }
  
  .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
  }
  
  .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
  }
  
  .stat-icon.total { background: rgba(46,160,67,0.15); color: var(--accent); }
  .stat-icon.pending { background: rgba(210,153,34,0.15); color: var(--warning); }
  .stat-icon.delivered { background: rgba(67,97,238,0.15); color: var(--blue); }
  
  .stat-info h3 {
      font-size: 24px;
      margin-bottom: 5px;
  }
  
  .stat-info span {
      font-size: 12px;
      color: var(--muted);
  }

  /* Responsive */
  @media(max-width:800px){ 
      .mobile-header { display: flex; }
      .sidebar{ transform: translateX(-100%); width: 260px; box-shadow: 2px 0 10px rgba(0,0,0,0.5); padding-top: 80px;}
      .sidebar.open { transform: translateX(0); }
      .main{ margin-left:0; padding: 15px; padding-top: 80px; }
      .top-bar { flex-direction: column; align-items: flex-start; }
      .balance-card { width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center;}
      .support-actions, .notice-actions { flex-direction: column; }
      .form-grid { grid-template-columns: 1fr; }
      .gift-grid { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="mobile-header">
    <div style="font-weight:bold;font-size:18px;">Sublime Logs</div>
    <button class="hamburger" id="menu-toggle"><i class="fas fa-bars"></i></button>
</div>

<!-- Gift Order Modal -->
<div class="modal" id="gift-modal">
  <div class="modal-card">
    <h3 style="margin-bottom:15px"><i class="fas fa-gift"></i> Send Gift</h3>
    
    <div id="gift-details">
        <!-- Filled dynamically -->
    </div>
    
    <div class="order-summary">
        <div id="order-summary-content">
            <!-- Filled dynamically -->
        </div>
    </div>
    
    <form id="gift-order-form">
        <h4 style="margin-bottom:15px;color:#fff">Recipient Information</h4>
        
        <div class="form-grid">
            <div>
                <label class="label">Recipient Name</label>
                <input type="text" id="recipient-name" placeholder="Enter full name" required>
            </div>
            <div>
                <label class="label">Recipient Phone</label>
                <input type="tel" id="recipient-phone" placeholder="Phone number" required>
            </div>
        </div>
        
        <div class="form-grid">
            <div>
                <label class="label">Address</label>
                <input type="text" id="address" placeholder="Street address" required>
            </div>
            <div>
                <label class="label">City</label>
                <input type="text" id="city" placeholder="City" required>
            </div>
        </div>
        
        <div class="form-grid">
            <div>
                <label class="label">State</label>
                <select id="state" required>
                    <option value="">Select State</option>
                    <option value="Abia">Abia</option>
                    <option value="Adamawa">Adamawa</option>
                    <option value="Akwa Ibom">Akwa Ibom</option>
                    <option value="Anambra">Anambra</option>
                    <option value="Bauchi">Bauchi</option>
                    <option value="Bayelsa">Bayelsa</option>
                    <option value="Benue">Benue</option>
                    <option value="Borno">Borno</option>
                    <option value="Cross River">Cross River</option>
                    <option value="Delta">Delta</option>
                    <option value="Ebonyi">Ebonyi</option>
                    <option value="Edo">Edo</option>
                    <option value="Ekiti">Ekiti</option>
                    <option value="Enugu">Enugu</option>
                    <option value="FCT">FCT - Abuja</option>
                    <option value="Gombe">Gombe</option>
                    <option value="Imo">Imo</option>
                    <option value="Jigawa">Jigawa</option>
                    <option value="Kaduna">Kaduna</option>
                    <option value="Kano">Kano</option>
                    <option value="Katsina">Katsina</option>
                    <option value="Kebbi">Kebbi</option>
                    <option value="Kogi">Kogi</option>
                    <option value="Kwara">Kwara</option>
                    <option value="Lagos">Lagos</option>
                    <option value="Nasarawa">Nasarawa</option>
                    <option value="Niger">Niger</option>
                    <option value="Ogun">Ogun</option>
                    <option value="Ondo">Ondo</option>
                    <option value="Osun">Osun</option>
                    <option value="Oyo">Oyo</option>
                    <option value="Plateau">Plateau</option>
                    <option value="Rivers">Rivers</option>
                    <option value="Sokoto">Sokoto</option>
                    <option value="Taraba">Taraba</option>
                    <option value="Yobe">Yobe</option>
                    <option value="Zamfara">Zamfara</option>
                </select>
            </div>
            <div>
                <label class="label">Zip Code</label>
                <input type="text" id="zip-code" placeholder="Postal code" required>
            </div>
        </div>
        
        <label class="label" style="margin-top:15px">Special Instructions (Optional)</label>
        <textarea id="special-instructions" rows="3" placeholder="Any special delivery instructions or message for recipient..."></textarea>
        
        <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px">
            <button type="button" class="btn secondary" id="close-gift-modal">Cancel</button>
            <button type="submit" class="btn btn-gift" id="confirm-gift-order">
                <i class="fas fa-paper-plane"></i> Confirm & Send Gift
            </button>
        </div>
    </form>
  </div>
</div>

<!-- Fund Wallet Modal -->
<div class="modal" id="add-money-modal">
  <div class="modal-card">
    <h3 style="margin-bottom:15px"><i class="fas fa-wallet"></i> Fund Wallet</h3>
    
    <p style="font-size:13px;color:var(--muted);margin-bottom:15px;" id="modal-msg">Enter amount to fund your wallet (Minimum: â‚¦100).</p>
    
    <form id="deposit-form">
      <input type="number" id="pay-amount" placeholder="Amount (e.g., 1000)" min="100" required style="margin-bottom:15px;" />
      <input type="email" id="pay-email-hidden" style="display:none;" />
      
      <div style="display:flex;justify-content:flex-end;gap:10px">
        <button type="button" class="btn secondary" id="close-add-money">Cancel</button>
        <button type="submit" class="btn" id="start-paystack">Pay Now</button>
      </div>
    </form>
    
    <p style="font-size:11px; color:var(--muted); text-align:center; margin-top:15px;">
        <i class="fas fa-sync-alt"></i> For bank transfers (Opay, etc.), wallet updates may take 5-15 minutes. Contact support if not updated after 15 minutes.
    </p>
  </div>
</div>

<div class="app-container">

    <aside class="sidebar" id="sidebar">
        <div style="font-weight:bold;font-size:20px;margin-bottom:30px;padding-left:10px;" class="desktop-only-logo">
            Sublime Logs
        </div>
        
        <a href="dashboard1.html" class="nav-link">
            <i class="fas fa-home"></i> Dashboard
        </a>
        <a href="buy-number.html" class="nav-link">
            <i class="fas fa-shopping-cart"></i> Buy Number
        </a>
        <a href="#" class="nav-link active" onclick="closeMenu()">
            <i class="fas fa-gift"></i> Send Gift
        </a>
        <a href="#" class="nav-link" id="nav-fund">
            <i class="fas fa-wallet"></i> Fund Account
        </a>
        
        <div style="margin-top:auto; border-top: 1px solid var(--border); padding-top: 15px;">
            <div style="font-size:11px;color:var(--muted); margin-bottom: 10px; padding-left: 10px;">
                LOGGED IN AS:<br><span id="user-email" style="color:var(--text);font-size:13px;">...</span>
            </div>
            <button id="logout" class="btn secondary btn-full">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </aside>

    <main class="main">
      
      <div class="top-bar">
        <div>
          <h2>Send a Gift</h2>
          <div style="color:var(--muted);font-size:14px">Express Delivery in 1 Hour</div>
        </div>
        <div class="balance-card">
            <div class="label" style="margin:0; color: #fff;">Wallet Balance</div>
            <div class="balance-amount" id="balance">...</div>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="stats-grid">
          <div class="stat-card">
              <div class="stat-icon total">
                  <i class="fas fa-gifts"></i>
              </div>
              <div class="stat-info">
                  <h3 id="total-gifts">0</h3>
                  <span>Total Gifts Sent</span>
              </div>
          </div>
          
          <div class="stat-card">
              <div class="stat-icon pending">
                  <i class="fas fa-clock"></i>
              </div>
              <div class="stat-info">
                  <h3 id="pending-gifts">0</h3>
                  <span>Pending Deliveries</span>
              </div>
          </div>
          
          <div class="stat-card">
              <div class="stat-icon delivered">
                  <i class="fas fa-check-circle"></i>
              </div>
              <div class="stat-info">
                  <h3 id="delivered-gifts">0</h3>
                  <span>Successfully Delivered</span>
              </div>
          </div>
      </div>

      <!-- Announcement Banner -->
      <div class="announcement-banner">
          <div class="announcement-icon">
              <i class="fas fa-shipping-fast" style="color:#fff; font-size:20px;"></i>
          </div>
          <div class="announcement-content">
              <h4>ðŸšš Fast Delivery Guaranteed</h4>
              <p>You'll be given a tracking code soon and your order will be delivered in 1 hour time. Real-time tracking available upon dispatch.</p>
          </div>
      </div>

      <!-- Important Notice -->
      <div class="important-notice">
          <div class="notice-header">
              <i class="fas fa-exclamation-circle"></i>
              <span>Delivery Information & Policies</span>
          </div>
          <div class="notice-content">
              <ul>
                  <li><strong>1. Delivery Time:</strong> All gifts are delivered within 1 hour of order confirmation in major cities.</li>
                  <li><strong>2. Tracking:</strong> You'll receive a tracking code immediately after order processing.</li>
                  <li><strong>3. Quality Assurance:</strong> All gifts are professionally wrapped and include a personalized message card.</li>
                  <li><strong>4. Contact Information:</strong> Ensure recipient's phone number is accurate for delivery coordination.</li>
              </ul>
          </div>
      </div>

      <!-- Gift Grid -->
      <h3 style="margin-bottom:20px;">Select Your Gift</h3>
      <div class="gift-grid" id="gift-grid">
          <!-- Gift items will be populated by JavaScript -->
      </div>

      <!-- Gift Orders History -->
      <h3 style="margin-top:40px;margin-bottom:15px;">Gift Orders History</h3>
      <div class="card" style="padding:0;">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width:40px">#</th>
                        <th>Gift</th>
                        <th>Recipient</th>
                        <th>Address</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Tracking</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="gift-history-table-body">
                    <tr><td colspan="8" style="text-align:center;padding:20px;color:var(--muted)">Loading gift orders...</td></tr>
                </tbody>
            </table>
        </div>
      </div>

    </main>
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script type="module">
  const PAYSTACK_KEY = 'pk_live_20505aa86cec6458bf2cc8cd926ecc06b87ff492';
  
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, collection, query, orderBy, limit, runTransaction, addDoc, getDocs, where, getDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDRnNoRJ4Zgtu-KEZAdOAKtou2LV9rdL5c",
    authDomain: "sublime-log.firebaseapp.com",
    projectId: "sublime-log",
    storageBucket: "sublime-log.firebasestorage.app",
    messagingSenderId: "644554254089",
    appId: "1:644554254089:web:dd3374c9468046a5a015d8"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let currentWalletBalance = 0;
  let selectedGift = null;

  // Gift Items Data
  const giftItems = [
      { id: 1, name: "Ring Order", price: 45000, image: "https://images.unsplash.com/photo-1515562141207-7a88fb7ce338?w=400&h=300&fit=crop", category: "jewelry" },
      { id: 2, name: "Bracelet Order", price: 45000, image: "https://images.unsplash.com/photo-1605100804763-247f67b3557e?w=400&h=300&fit=crop", category: "jewelry" },
      { id: 3, name: "Custom Cake", price: 70000, image: "https://images.unsplash.com/photo-1563729784474-d77dbb933a9e?w=400&h=300&fit=crop", category: "food" },
      { id: 4, name: "Love Card", price: 30000, image: "https://images.unsplash.com/photo-1511795409834-ef04bbd61622?w=400&h=300&fit=crop", category: "cards" },
      { id: 5, name: "Explosion Box", price: 140000, image: "https://images.unsplash.com/photo-1598300042247-d088f8ab3a91?w=400&h=300&fit=crop", category: "special" },
      { id: 6, name: "Necklace", price: 45000, image: "https://images.unsplash.com/photo-1535632066927-ab7c9ab60908?w=400&h=300&fit=crop", category: "jewelry" },
      { id: 7, name: "Pizza & Coke", price: 30000, image: "https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w-400&h=300&fit=crop", category: "food" },
      { id: 8, name: "Pizza, Coke & Chicken", price: 40000, image: "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400&h=300&fit=crop", category: "food" },
      { id: 9, name: "Glass Flower Bouquet", price: 50000, image: "https://images.unsplash.com/photo-1485955900006-10f4d324d411?w=400&h=300&fit=crop", category: "flowers" },
      { id: 10, name: "Photo Frame", price: 55000, image: "https://images.unsplash.com/photo-1513519245088-0e129d3c9c1a?w=400&h=300&fit=crop", category: "decor" },
      { id: 11, name: "Custom Shirt/Hoodie", price: 50000, image: "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=400&h=300&fit=crop", category: "clothing" },
      { id: 12, name: "Personalized Blanket", price: 50000, image: "https://images.unsplash.com/photo-1562176562-1a8b4e15e39d?w=400&h=300&fit=crop", category: "home" },
      { id: 13, name: "Customize Pillow", price: 50000, image: "https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=400&h=300&fit=crop", category: "home" },
      { id: 14, name: "Designer Wristwatch", price: 50000, image: "https://images.unsplash.com/photo-1523170335258-f5ed11844a49?w=400&h=300&fit=crop", category: "accessories" },
      { id: 15, name: "Teddy Bear", price: 50000, image: "https://images.unsplash.com/photo-1596462502278-27bfdc403348?w=400&h=300&fit=crop", category: "toys" },
      { id: 16, name: "Fresh Cut Flowers", price: 70000, image: "https://images.unsplash.com/photo-1464207687429-7505649dae38?w=400&h=300&fit=crop", category: "flowers" },
      { id: 17, name: "Customize Mug", price: 55000, image: "https://images.unsplash.com/photo-1514228742587-6b1558fcf93a?w=400&h=300&fit=crop", category: "home" }
  ];

  // --- MENU & MODAL LOGIC ---
  const menuToggle = document.getElementById('menu-toggle');
  const sidebar = document.getElementById('sidebar');
  const amModal = document.getElementById('add-money-modal');
  const giftModal = document.getElementById('gift-modal');

  menuToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
  window.closeMenu = () => sidebar.classList.remove('open');
  
  // Close menu when clicking outside
  document.addEventListener('click', (e) => {
      if(!sidebar.contains(e.target) && !menuToggle.contains(e.target) && sidebar.classList.contains('open')){
          sidebar.classList.remove('open');
      }
  });

  // Modal Handlers
  document.getElementById('nav-fund').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('modal-msg').textContent = "Enter amount to fund your wallet (Minimum: â‚¦100).";
      document.getElementById('pay-amount').value = "";
      amModal.classList.add('open');
      closeMenu();
  });
  
  document.getElementById('close-add-money').addEventListener('click', () => {
    amModal.classList.remove('open');
  });

  document.getElementById('close-gift-modal').addEventListener('click', () => {
    giftModal.classList.remove('open');
    selectedGift = null;
  });

  // --- AUTH ---
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('user-email').textContent = user.email;
      document.getElementById('pay-email-hidden').value = user.email;
      
      // Load wallet balance
      onSnapshot(doc(db, "users", user.uid), (docSnap) => {
         const bal = docSnap.exists() ? docSnap.data().balance : 0;
         currentWalletBalance = bal || 0;
         document.getElementById('balance').textContent = 'â‚¦' + (bal || 0).toLocaleString();
      });

      loadGiftHistory();
      loadGiftStats();
      renderGiftGrid();
    } else {
      window.location.href = 'index.html';
    }
  });
  
  document.getElementById('logout').addEventListener('click', () => {
      signOut(auth).then(() => window.location.href = 'index.html');
  });

  // --- RENDER GIFT GRID ---
  function renderGiftGrid() {
      const grid = document.getElementById('gift-grid');
      grid.innerHTML = '';
      
      giftItems.forEach(gift => {
          const card = document.createElement('div');
          card.className = 'gift-card';
          card.innerHTML = `
              <img src="${gift.image}" alt="${gift.name}" class="gift-image" onerror="this.src='https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=400&h=300&fit=crop'">
              <div class="gift-content">
                  <div class="gift-name">${gift.name}</div>
                  <div class="gift-price">â‚¦${gift.price.toLocaleString()}</div>
                  <div class="gift-meta">
                      <span class="delivery-time">
                          <i class="fas fa-clock"></i> 1 Hour Delivery
                      </span>
                      <button class="btn btn-gift" onclick="openGiftModal(${gift.id})">
                          <i class="fas fa-gift"></i> Buy & Send
                      </button>
                  </div>
              </div>
          `;
          grid.appendChild(card);
      });
  }

  // --- OPEN GIFT MODAL ---
  window.openGiftModal = (giftId) => {
      selectedGift = giftItems.find(g => g.id === giftId);
      
      if (!selectedGift) return;
      
      // Check balance
      if (currentWalletBalance < selectedGift.price) {
          const deficit = selectedGift.price - currentWalletBalance;
          const fundAmount = deficit < 100 ? 100 : deficit;
          
          document.getElementById('modal-msg').innerHTML = `
              <span style="color:var(--warning)">Insufficient Balance!</span><br>
              You need â‚¦${Math.ceil(deficit)} more to send this ${selectedGift.name}.<br>
              Fund your wallet now to continue.
          `;
          document.getElementById('pay-amount').value = Math.ceil(fundAmount);
          amModal.classList.add('open');
          return;
      }
      
      // Update modal content
      document.getElementById('gift-details').innerHTML = `
          <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;">
              <img src="${selectedGift.image}" alt="${selectedGift.name}" style="width:80px;height:80px;border-radius:8px;object-fit:cover;">
              <div>
                  <h4 style="margin-bottom:5px;">${selectedGift.name}</h4>
                  <div style="color:var(--muted);font-size:14px;">Premium Gift Delivery</div>
              </div>
          </div>
      `;
      
      document.getElementById('order-summary-content').innerHTML = `
          <div class="summary-item">
              <span>Gift Price:</span>
              <span>â‚¦${selectedGift.price.toLocaleString()}</span>
          </div>
          <div class="summary-item">
              <span>Delivery Fee:</span>
              <span style="color:var(--accent)">FREE</span>
          </div>
          <div class="summary-item">
              <span>Processing Fee:</span>
              <span>â‚¦0</span>
          </div>
          <div class="summary-item summary-total">
              <span>Total Amount:</span>
              <span>â‚¦${selectedGift.price.toLocaleString()}</span>
          </div>
      `;
      
      // Reset form
      document.getElementById('gift-order-form').reset();
      giftModal.classList.add('open');
  };

  // --- HANDLE GIFT ORDER ---
  document.getElementById('gift-order-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!selectedGift) return;
      
      const btn = document.getElementById('confirm-gift-order');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
      btn.disabled = true;
      
      try {
          const recipientData = {
              name: document.getElementById('recipient-name').value.trim(),
              phone: document.getElementById('recipient-phone').value.trim(),
              address: document.getElementById('address').value.trim(),
              city: document.getElementById('city').value.trim(),
              state: document.getElementById('state').value,
              zipCode: document.getElementById('zip-code').value.trim(),
              instructions: document.getElementById('special-instructions').value.trim()
          };
          
          // Validate
          if (!recipientData.name || !recipientData.phone || !recipientData.address || 
              !recipientData.city || !recipientData.state || !recipientData.zipCode) {
              throw new Error('Please fill all required fields');
          }
          
          // Check balance again
          if (currentWalletBalance < selectedGift.price) {
              throw new Error('Insufficient balance. Please fund your wallet.');
          }
          
          const userRef = doc(db, "users", currentUser.uid);
          
          // Generate tracking code
          const trackingCode = 'SLG-' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substr(2, 4).toUpperCase();
          
          // Deduct from balance and create gift order
          await runTransaction(db, async (t) => {
              const uDoc = await t.get(userRef);
              if ((uDoc.data().balance || 0) < selectedGift.price) {
                  throw new Error("Insufficient Balance (Server)");
              }
              
              t.update(userRef, { balance: uDoc.data().balance - selectedGift.price });
              
              const newGiftOrderRef = doc(collection(userRef, "giftOrders"));
              t.set(newGiftOrderRef, {
                  id: newGiftOrderRef.id,
                  giftName: selectedGift.name,
                  giftPrice: selectedGift.price,
                  giftImage: selectedGift.image,
                  ...recipientData,
                  trackingCode: trackingCode,
                  status: 'PROCESSING',
                  senderEmail: currentUser.email,
                  senderUid: currentUser.uid,
                  orderDate: new Date().toISOString(),
                  estimatedDelivery: new Date(Date.now() + 60 * 60 * 1000).toISOString() // 1 hour from now
              });
          });
          
          // Success
          giftModal.classList.remove('open');
          
          alert(`
              ðŸŽ‰ Gift Order Confirmed!
              
              âœ… Order: ${selectedGift.name}
              âœ… Amount: â‚¦${selectedGift.price.toLocaleString()}
              âœ… Recipient: ${recipientData.name}
              âœ… Delivery: ${recipientData.city}, ${recipientData.state}
              
              ðŸ“¦ Tracking Code: ${trackingCode}
              
              Your gift will be delivered within 1 hour.
              You can track the delivery status in your orders history.
              
              Thank you for choosing Sublime Logs!
          `);
          
          // Refresh data
          loadGiftHistory();
          loadGiftStats();
          
          selectedGift = null;
          
      } catch (error) {
          console.error('Gift order error:', error);
          alert('Error: ' + error.message);
      } finally {
          btn.innerHTML = originalText;
          btn.disabled = false;
      }
  });

  // --- LOAD GIFT STATS ---
  async function loadGiftStats() {
      if (!currentUser) return;
      
      try {
          const giftsRef = collection(db, "users", currentUser.uid, "giftOrders");
          const snapshot = await getDocs(giftsRef);
          
          let total = 0;
          let pending = 0;
          let delivered = 0;
          
          snapshot.forEach(doc => {
              total++;
              const data = doc.data();
              if (data.status === 'DELIVERED') delivered++;
              if (data.status === 'PROCESSING' || data.status === 'SHIPPED') pending++;
          });
          
          document.getElementById('total-gifts').textContent = total;
          document.getElementById('pending-gifts').textContent = pending;
          document.getElementById('delivered-gifts').textContent = delivered;
          
      } catch (error) {
          console.error('Error loading gift stats:', error);
      }
  }

  // --- LOAD GIFT HISTORY ---
  function loadGiftHistory() {
      if (!currentUser) return;
      
      const q = query(collection(db, "users", currentUser.uid, "giftOrders"), orderBy("orderDate", "desc"), limit(20));
      const tbody = document.getElementById('gift-history-table-body');
      
      onSnapshot(q, (snapshot) => {
          tbody.innerHTML = '';
          if(snapshot.empty) { 
              tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;color:var(--muted)">No gift orders yet. Send your first gift!</td></tr>'; 
              return; 
          }
          
          let index = 1;
          snapshot.forEach(docSnap => {
              const d = docSnap.data();
              const tr = document.createElement('tr');
              
              // Status badge
              let statusClass = 'status-pending';
              let statusText = d.status;
              
              if (d.status === 'PROCESSING') {
                  statusClass = 'status-processing';
              } else if (d.status === 'SHIPPED') {
                  statusClass = 'status-shipped';
              } else if (d.status === 'DELIVERED') {
                  statusClass = 'status-delivered';
              } else if (d.status === 'CANCELED') {
                  statusClass = 'status-canceled';
              }
              
              // Format address
              const shortAddress = d.address.length > 20 ? d.address.substring(0, 20) + '...' : d.address;
              
              tr.innerHTML = `
                  <td>${index++}</td>
                  <td>
                      <div style="display:flex;align-items:center;gap:8px;">
                          <img src="${d.giftImage}" alt="${d.giftName}" style="width:30px;height:30px;border-radius:4px;object-fit:cover;">
                          <span style="font-weight:500;">${d.giftName}</span>
                      </div>
                  </td>
                  <td>${d.name}</td>
                  <td title="${d.address}">${shortAddress}</td>
                  <td>â‚¦${d.giftPrice.toLocaleString()}</td>
                  <td><span class="badge ${statusClass}">${statusText}</span></td>
                  <td>
                      <span class="code-box">${d.trackingCode}</span>
                  </td>
                  <td style="font-size:11px;color:var(--muted)">
                      ${new Date(d.orderDate).toLocaleDateString()}<br>
                      ${new Date(d.orderDate).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                  </td>
              `;
              tbody.appendChild(tr);
          });
      });
  }

  // --- PAYSTACK PAYMENT HANDLING ---
  document.getElementById('deposit-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const amount = document.getElementById('pay-amount').value;
      const email = document.getElementById('pay-email-hidden').value;
      const btn = document.getElementById('start-paystack');

      if(amount < 100) return alert("Minimum deposit is â‚¦100");
      
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
      btn.disabled = true;

      const handler = PaystackPop.setup({
          key: PAYSTACK_KEY, 
          email: email, 
          amount: amount * 100, 
          currency: 'NGN',
          ref: 'SLG-' + Date.now() + '-' + Math.floor(Math.random() * 1000),
          metadata: {
              userId: currentUser.uid,
              userEmail: currentUser.email,
              platform: 'Sublime Logs Gift'
          },
          callback: (response) => {
              processDeposit(amount, response.reference);
          },
          onClose: () => {
              btn.disabled = false;
              btn.innerHTML = '<i class="fas fa-credit-card"></i> Pay Now';
          }
      });
      handler.openIframe();
  });

  // --- PROCESS DEPOSIT ---
  async function processDeposit(amount, ref) {
      try {
          const userRef = doc(db, "users", currentUser.uid);
          
          // Record transaction
          await addDoc(collection(db, "users", currentUser.uid, "transactions"), {
              type: 'deposit',
              amount: Number(amount),
              date: new Date().toISOString(),
              reference: ref,
              status: 'COMPLETED',
              userEmail: currentUser.email,
              platform: 'gift'
          });
          
          // Update balance
          await runTransaction(db, async (t) => {
              const sfDoc = await t.get(userRef);
              t.update(userRef, { balance: (sfDoc.data().balance || 0) + Number(amount) });
          });

          alert(`âœ… Payment Successful! â‚¦${amount} has been added to your wallet.\nReference: ${ref}`);
          amModal.classList.remove('open');

          // Update balance display immediately
          currentWalletBalance += Number(amount);
          document.getElementById('balance').textContent = 'â‚¦' + currentWalletBalance.toLocaleString();

      } catch (error) {
          console.error("Error processing deposit:", error);
          alert("Error updating balance. Please contact support with reference: " + ref);
      } finally {
          const btn = document.getElementById('start-paystack');
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-credit-card"></i> Pay Now';
      }
  }

  // Generate placeholder images if needed
  document.addEventListener('DOMContentLoaded', () => {
      // Replace broken images with placeholder
      document.addEventListener('error', function(e) {
          if (e.target.tagName === 'IMG' && e.target.classList.contains('gift-image')) {
              e.target.src = 'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=400&h=300&fit=crop';
          }
      }, true);
  });
</script>
</body>
          </html>
